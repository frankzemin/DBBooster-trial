<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>DBbooster - Automated DBLEAVES Parser & Formatter</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Load SheetJS (xlsx.full.min.js) for Excel file parsing (for Phase 2 & 4) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Load MathJax for LaTeX rendering -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --tech-blue: #00c6ff;
            --tech-purple: #6a11cb;
            --tech-green: #11998e;
            --tech-orange: #ff8a00;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2a6c, #2c3e50, #4a235a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            max-width: 100%;
            overflow: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .tech-header {
            background: var(--dark-gradient);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .tech-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }
        
        .feature-card {
            background: rgba(30, 41, 59, 0.7);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--accent-gradient);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover::before {
            transform: scaleX(1);
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        .feature-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        .intro-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .intro-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .intro-section h2 {
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            padding-bottom: 0.5rem;
        }
        
        .intro-section h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100px;
            height: 3px;
            background: var(--accent-gradient);
            border-radius: 2px;
        }
        
        .intro-section h3 {
            font-size: clamp(1.25rem, 3vw, 1.75rem);
            font-weight: 600;
            margin: 2rem 0 1rem;
            color: #cbd5e1;
        }
        
        .intro-section p {
            font-size: clamp(1rem, 2vw, 1.1rem);
            line-height: 1.7;
            color: #cbd5e1;
            margin-bottom: 1.5rem;
        }
        
        .intro-section ul, .intro-section ol {
            font-size: clamp(1rem, 2vw, 1.1rem);
            line-height: 1.7;
            color: #cbd5e1;
            margin-bottom: 1.5rem;
            padding-left: 1.5rem;
        }
        
        .intro-section li {
            margin-bottom: 0.75rem;
        }
        
        .code-inline {
            background: rgba(100, 116, 139, 0.3);
            color: #60a5fa;
            padding: 0.2rem 0.5rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.95rem;
        }
        
        .workflow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .workflow-step {
            flex: 1;
            min-width: 150px;
            text-align: center;
            padding: 1.5rem;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 12px;
            position: relative;
        }
        
        .workflow-step:not(:last-child)::after {
            content: '→';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: #60a5fa;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .data-flow {
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 2rem 0;
            padding: 2rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-item {
            flex: 1;
            min-width: 120px;
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-arrow {
            font-size: 2rem;
            color: #60a5fa;
            margin: 0 1rem;
        }
        
        .concept-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .concept-item {
            background: rgba(30, 41, 59, 0.7);
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #60a5fa;
        }
        
        .concept-item strong {
            color: #60a5fa;
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .getting-started-steps {
            counter-reset: step-counter;
            list-style: none;
            padding: 0;
        }
        
        .getting-started-steps li {
            counter-increment: step-counter;
            margin-bottom: 1.5rem;
            padding-left: 3rem;
            position: relative;
        }
        
        .getting-started-steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        /* Enhanced Header Styles */
        .header-container {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .header-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb, #43e97b);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            position: relative;
            z-index: 2;
        }
        
        /* Professional DBbooster Logo */
        .dbbooster-logo {
            width: 70px;
            height: 70px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-base {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        /* Database Server Elements */
        .server {
            position: absolute;
            width: 35px;
            height: 10px;
            background: linear-gradient(135deg, #4a5568, #2d3748);
            border-radius: 3px;
            border: 1px solid rgba(96, 165, 250, 0.3);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .server-top {
            top: 13px;
            left: 17px;
        }
        
        .server-middle {
            top: 26px;
            left: 17px;
        }
        
        .server-bottom {
            top: 39px;
            left: 17px;
        }
        
        /* Data Connection Lines */
        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transform-origin: left center;
        }
        
        .line-1 {
            top: 20px;
            left: 25px;
            width: 18px;
            transform: rotate(30deg);
        }
        
        .line-2 {
            top: 33px;
            left: 25px;
            width: 18px;
            transform: rotate(-30deg);
        }
        
        .line-3 {
            top: 46px;
            left: 25px;
            width: 18px;
            transform: rotate(30deg);
        }
        
        /* Automation Gear */
        .gear {
            position: absolute;
            width: 22px;
            height: 22px;
            top: 26px;
            left: 48px;
            background: linear-gradient(135deg, #43e97b, #38f9d7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: rotateGear 4s linear infinite;
            box-shadow: 0 0 10px rgba(67, 233, 123, 0.5);
        }
        
        .gear-inner {
            width: 13px;
            height: 13px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 50%;
        }
        
        .gear-teeth {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .tooth {
            position: absolute;
            width: 3px;
            height: 7px;
            background: #43e97b;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
        }
        
        .tooth:nth-child(2) { transform: rotate(45deg) translateX(-50%); }
        .tooth:nth-child(3) { transform: rotate(90deg) translateX(-50%); }
        .tooth:nth-child(4) { transform: rotate(135deg) translateX(-50%); }
        .tooth:nth-child(5) { transform: rotate(180deg) translateX(-50%); }
        .tooth:nth-child(6) { transform: rotate(225deg) translateX(-50%); }
        .tooth:nth-child(7) { transform: rotate(270deg) translateX(-50%); }
        .tooth:nth-child(8) { transform: rotate(315deg) translateX(-50%); }
        
        /* Data Transformation Arrows */
        .transform-arrow {
            position: absolute;
            width: 25px;
            height: 18px;
            top: 30px;
            left: 5px;
        }
        
        .arrow-line {
            position: absolute;
            width: 18px;
            height: 2px;
            background: linear-gradient(90deg, #f093fb, #f5576c);
            top: 8px;
            left: 0;
        }
        
        .arrow-head {
            position: absolute;
            width: 0;
            height: 0;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
            border-left: 7px solid #f093fb;
            top: 4px;
            right: 0;
        }
        
        /* Performance Boost Elements */
        .boost-element {
            position: absolute;
            width: 7px;
            height: 7px;
            background: #ffd700;
            border-radius: 50%;
            box-shadow: 0 0 8px #ffd700;
        }
        
        .boost-1 { top: 4px; left: 31px; animation: pulseBoost 2s infinite; }
        .boost-2 { top: 4px; left: 38px; animation: pulseBoost 2s infinite 0.3s; }
        .boost-3 { top: 4px; left: 45px; animation: pulseBoost 2s infinite 0.6s; }
        
        /* Speed Lines */
        .speed-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ffd700);
            border-radius: 1px;
        }
        
        .speed-1 { top: 13px; left: 5px; width: 13px; animation: moveLine 1.5s infinite; }
        .speed-2 { top: 17px; left: 5px; width: 17px; animation: moveLine 1.5s infinite 0.2s; }
        .speed-3 { top: 21px; left: 5px; width: 21px; animation: moveLine 1.5s infinite 0.4s; }
        
        @keyframes rotateGear {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulseBoost {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.7; }
        }
        
        @keyframes moveLine {
            0% { transform: translateX(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(18px); opacity: 0; }
        }
        
        .brand-content {
            flex: 1;
        }
        
        .brand-title {
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 800;
            background: linear-gradient(90deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            line-height: 1.2;
            letter-spacing: -0.5px;
        }
        
        .brand-subtitle {
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            color: #94a3b8;
            margin: 0.5rem 0 0;
            font-weight: 400;
            letter-spacing: 0.5px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .cta-button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: clamp(0.9rem, 2vw, 1rem);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            white-space: nowrap;
        }
        
        .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .cta-button:active {
            transform: translateY(0);
        }
        
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            animation: float 15s infinite linear;
        }
        
        @keyframes float {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(-1000px) translateX(1000px) rotate(720deg);
                opacity: 0;
            }
        }
        
        .tech-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(96, 165, 250, 0.2);
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            color: #93c5fd;
            margin: 0.25rem;
        }
        
        /* Main content area */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        
        /* Footer */
        .footer-container {
            flex-shrink: 0;
            padding: 1.5rem;
            text-align: center;
            color: #94a3b8;
            font-size: clamp(0.8rem, 1.5vw, 0.9rem);
        }
        
        /* Initial Stress Icon */
        .initial-stress-icon {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stress-block {
            position: relative;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stress-lines {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .stress-line {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 1px;
        }
        
        .line-1 { top: 8px; left: 5px; width: 30px; height: 2px; }
        .line-2 { top: 15px; left: 5px; width: 30px; height: 2px; }
        .line-3 { top: 22px; left: 5px; width: 30px; height: 2px; }
        .line-4 { top: 29px; left: 5px; width: 30px; height: 2px; }
        
        .stress-arrows {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .arrow-top {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 8px solid #f87171;
        }
        
        .arrow-bottom {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #f87171;
        }
        
        .arrow-left {
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 8px solid #f87171;
        }
        
        .arrow-right {
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 8px solid #f87171;
        }
        
        .stress-center {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #f87171;
            border-radius: 50%;
            animation: pulseStress 1.5s infinite;
        }
        
        @keyframes pulseStress {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* --- NEW NAVIGATION BAR STYLES --- */
        .phase-nav-container {
            flex-shrink: 0;
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(96, 165, 250, 0.2);
            padding: 0.5rem 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .phase-nav-scroll {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }

        .phase-nav-scroll::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }

        .phase-nav-item {
            flex-shrink: 0;
            padding: 0.75rem 1.25rem;
            margin: 0 0.25rem;
            border-radius: 8px;
            color: #cbd5e1; /* slate-300 */
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border: 1px solid transparent;
        }

        .phase-nav-item:hover {
            background: rgba(96, 165, 250, 0.1);
            color: #fff;
        }

        .phase-nav-item.active {
            background: rgba(96, 165, 250, 0.2);
            color: #93c5fd; /* blue-300 */
            font-weight: 600;
            border-color: rgba(96, 165, 250, 0.3);
            box-shadow: 0 2px 8px rgba(96, 165, 250, 0.1);
        }

        .phase-nav-mobile {
            background: rgba(30, 41, 59, 0.9); /* slate-800 */
            color: #cbd5e1;
            border: 1px solid rgba(96, 165, 250, 0.3);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-weight: 500;
            width: 100%;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2393c5fd' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        /* --- END NEW STYLES --- */


        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .concept-list {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .workflow-diagram {
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 992px) {
            .workflow-step:not(:last-child)::after {
                content: '↓';
                right: 50%;
                top: 100%;
                transform: translateX(50%);
            }
            
            .data-flow {
                flex-direction: column;
            }
            
            .data-arrow {
                transform: rotate(90deg);
                margin: 1rem 0;
            }
            
            .concept-list {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
            
            .header-container {
                padding: 1rem;
            }
            
            .logo-container {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .dbbooster-logo {
                width: 60px;
                height: 60px;
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
                margin-top: 1rem;
            }
            
            .cta-button {
                padding: 0.75rem 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .workflow-step {
                min-width: 120px;
                padding: 1rem;
            }
            
            .step-number {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
            
            .workflow-step h4 {
                font-size: 0.9rem;
            }
            
            .data-item {
                min-width: 100px;
                padding: 0.75rem;
            }
            
            .concept-list {
                grid-template-columns: 1fr;
            }
            
            .intro-section h2 {
                font-size: 1.75rem;
            }
            
            .intro-section h3 {
                font-size: 1.25rem;
            }
            
            .intro-section p, .intro-section ul, .intro-section ol {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .main-content {
                padding: 1rem;
            }
            
            .tech-header {
                padding: 1rem;
            }
            
            .intro-section {
                margin-bottom: 1.5rem;
                padding-bottom: 1rem;
            }
            
            .workflow-step {
                min-width: 100px;
                padding: 0.75rem;
            }
            
            .data-item {
                min-width: 80px;
                padding: 0.5rem;
            }
            
            .feature-card {
                padding: 1rem;
            }
            
            .feature-icon {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }
            
            .stress-block {
                width: 35px;
                height: 35px;
            }
            
            .line-1, .line-2, .line-3, .line-4 {
                width: 25px;
                left: 5px;
            }
            
            .arrow-top { top: -6px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 6px solid #f87171; }
            .arrow-bottom { bottom: -6px; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #f87171; }
            .arrow-left { left: -6px; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-right: 6px solid #f87171; }
            .arrow-right { right: -6px; border-top: 5px solid transparent; border-bottom: 5px solid transparent; border-left: 6px solid #f87171; }
            
            .stress-center {
                width: 10px;
                height: 10px;
            }
        }
        
        @media (min-width: 1600px) {
            .intro-section h2 {
                font-size: 2.75rem;
            }
            
            .intro-section h3 {
                font-size: 2rem;
            }
            
            .intro-section p, .intro-section ul, .intro-section ol {
                font-size: 1.25rem;
            }
            
            .workflow-step {
                padding: 2rem;
            }
            
            .data-item {
                padding: 1.5rem;
            }
        }
        
        /* Ultra-wide display handling */
        @media (min-aspect-ratio: 21/9) {
            .main-content {
                max-width: 1800px;
                margin: 0 auto;
                width: 100%;
            }
        }
        
        /* Tall display handling */
        @media (min-height: 1000px) and (min-width: 1200px) {
            .intro-section {
                margin-bottom: 3rem;
                padding-bottom: 2rem;
            }
            
            .workflow-step {
                padding: 2rem;
            }
        }

        /* --- STYLES FROM PHASE 2 --- */
        /* Inputs */
        .config-input, .config-select { 
            border: 1px solid #334155; /* Dark gray border */
            border-radius: 0.375rem; 
            padding: 0.5rem 0.75rem; 
            font-size: 0.875rem; 
            background-color: #1e293b; /* Darker background */
            color: #e2e8f0; /* Light text */
            transition: border-color 0.2s, box-shadow 0.2s; 
        }
        .config-input:focus, .config-select:focus { 
            outline: 2px solid transparent; 
            outline-offset: 2px; 
            border-color: #3b82f6; /* Blue focus border */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); 
        }
        
        /* Inner Tabs (from Phase 2, may need merging/scoping) */
        .tab-btn { 
            border-bottom: 2px solid transparent; 
            transition: border-color 0.3s, color 0.3s; 
        }
        .tab-btn.active { 
            border-bottom-color: #3b82f6; 
            color: #3b82f6; 
            font-weight: 600; 
        }
        .cm-tab-btn, .inspect-tab-btn { 
            border: 1px solid #334155; 
            border-bottom: 0; 
            background-color: #1e293b; 
            margin-bottom: -1px; 
            border-radius: 6px 6px 0 0; 
            padding: 0.5rem 1rem; 
            font-size: 0.875rem; 
            cursor: pointer; 
            transition: background-color 0.2s, color 0.2s; 
        }
        .cm-tab-btn:hover, .inspect-tab-btn:hover { 
            background-color: #334155; 
        }
        .cm-tab-btn.active, .inspect-tab-btn.active { 
            background-color: #0f172a; 
            border-color: #334155; 
            border-bottom-color: #0f172a; 
            font-weight: 600; 
            color: #3b82f6; 
        }
        .cm-tab-btn .delete-material-btn { 
            margin-left: 8px; 
            color: #ef4444; 
            font-weight: bold; 
            font-size: 1rem; 
            opacity: 0.5; 
            transition: opacity 0.2s; 
        }
        .cm-tab-btn:hover .delete-material-btn, .cm-tab-btn.active .delete-material-btn { 
            opacity: 1; 
        }

        /* Data Grids */
        .data-grid-container { 
            width: 100%; 
            overflow: auto; 
            max-height: 500px; 
            border: 1px solid #334155; 
            border-radius: 0.375rem; 
            background-color: #1e293b; /* Darker background */
        }
        .data-grid { 
            border-collapse: collapse; 
            width: 100%; 
            font-size: 0.875rem; 
        }
        .data-grid th, .data-grid td { 
            border: 1px solid #334155; 
            padding: 0.5rem 0.75rem; 
            text-align: left; 
            white-space: nowrap; 
        }
        .data-grid th { 
            background-color: #334155; /* Dark header */
            position: sticky; 
            top: 0; 
            z-index: 10; 
            user-select: none; 
            cursor: move; 
            min-width: 150px; 
        }
        .data-grid th.source-grid-header { 
            cursor: default; 
        }
        .data-grid th.source-grid-header .source-header-content { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            font-size: 0.875rem; 
            font-weight: 600; 
        }
        .data-grid th.source-grid-header .form-checkbox { 
            height: 1rem; 
            width: 1rem; 
        }
        .data-grid th .config-group { 
            font-size: 0.75rem; 
            font-weight: normal; 
            display: flex; 
            flex-direction: column; 
            gap: 4px; 
            margin-top: 8px; 
        }
        .data-grid th .config-group label { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            gap: 4px; 
        }
        .data-grid th .config-group .config-input, .data-grid th .config-group .config-select { 
            font-size: 0.75rem; 
            padding: 2px 4px; 
            width: auto; 
            flex-grow: 1; 
            min-width: 60px;
        }
        .data-grid th .config-group .col-name-input { 
            width: 100%; 
            font-size: 0.875rem; 
            font-weight: 600; 
            padding: 2px 4px; 
        }
        .data-grid th .config-group .calc-input { 
            width: 100%; 
            font-size: 0.75rem; 
            padding: 2px 4px; 
        }
        .data-grid th .config-group .calc-select { 
            width: 100%; 
            font-size: 0.75rem; 
            padding: 2px 4px; 
        }
        .data-grid th .col-header-content { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 0.875rem; 
        }
        .data-grid th .col-remove-btn { 
            font-weight: bold; 
            font-size: 1.1rem; 
            color: #ef4444; 
            cursor: pointer; 
            padding: 0 4px; 
            border-radius: 4px; 
            flex-shrink: 0; 
        }
        .data-grid th .col-remove-btn:hover { 
            background-color: #fee2e2; 
        }
        .data-grid td[contenteditable="true"] { 
            background-color: #1e3a8a; /* Dark blue editable */
            outline: none; 
        }
        .data-grid td[contenteditable="true"]:focus { 
            background-color: #3b82f6; /* Blue focus */
            box-shadow: inset 0 0 0 2px #1d4ed8; 
        }
        .header-drag-over { 
            background-color: #1e3a8a; 
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(90deg, #3b82f6 0%, #60a5fa 100%);
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, #475569 0%, #64748b 100%);
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(90deg, #334155 0%, #475569 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .btn-success {
            background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-success:hover {
            background: linear-gradient(90deg, #059669 0%, #10b981 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .btn-warning {
            background: linear-gradient(90deg, #f59e0b 0%, #fbbf24 100%);
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-warning:hover {
            background: linear-gradient(90deg, #d97706 0%, #f59e0b 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #ef4444 0%, #f87171 100%);
            color: white;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-danger:hover {
            background: linear-gradient(90deg, #dc2626 0%, #ef4444 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        
        /* Cards */
        .card {
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #60a5fa;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #334155;
        }
        
        /* Preview box */
        .preview-box {
            background-color: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Consolas', 'Menlo', 'Courier New', monospace;
            font-size: 0.875rem;
            color: #e2e8f0;
            min-height: 200px;
            overflow: auto;
            white-space: pre;
        }
        
        /* Loading spinner */
        .spinner {
            border: 2px solid #334155;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .data-grid th { min-width: 120px; }
            .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
            .md\\:grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .lg\\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }

        /* --- END STYLES FROM PHASE 2 --- */

        /* --- STYLES FROM PHASE 3 (CM PARAMETERS) --- */
        /* Custom styles for the app */
        #interface-cmParams {
            background-color: #0f172a; /* Dark slate background */
            color: #e2e8f0; /* Light text */
        }
        
        /* Custom input styles for dark mode */
        #interface-cmParams .config-input, #interface-cmParams .config-select {
            border: 1px solid #334155; /* Dark border */
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #1e293b; /* Dark input background */
            color: #e2e8f0; /* Light text */
        }
        #interface-cmParams .config-input:focus, #interface-cmParams .config-select:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #60a5fa; /* Blue focus border */
            box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3);
        }
        #interface-cmParams .config-input::placeholder {
            color: #94a3b8; /* Muted placeholder */
        }

        /* Inner Tabs */
        #interface-cmParams .tab-btn {
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s, color 0.3s;
        }
        #interface-cmParams .tab-btn.active {
            border-bottom-color: #60a5fa; /* blue-400 */
            color: #60a5fa; /* blue-400 */
            font-weight: 600;
        }
        #interface-cmParams .cm-tab-btn {
            border: 1px solid #334155; /* Dark border */
            border-bottom: 0;
            background: linear-gradient(to bottom, #1e293b, #0f172a); /* Dark gradient */
            margin-bottom: -1px;
            border-radius: 6px 6px 0 0;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #94a3b8; /* Muted text */
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        #interface-cmParams .cm-tab-btn:hover {
            background: linear-gradient(to bottom, #334155, #1e293b); /* Hover gradient */
        }
        #interface-cmParams .cm-tab-btn.active {
            background: linear-gradient(to bottom, #0f172a, #1e293b); /* Active gradient */
            border-color: #60a5fa; /* Blue border */
            border-bottom-color: #0f172a;
            font-weight: 600;
            color: #60a5fa; /* Blue text */
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #interface-cmParams .cm-tab-btn .delete-material-btn {
            margin-left: 8px;
            color: #f87171; /* Red delete button */
            font-weight: bold;
            font-size: 1.2rem;
            opacity: 0.7;
            transition: opacity 0.2s, transform 0.2s;
        }
        #interface-cmParams .cm-tab-btn:hover .delete-material-btn,
        #interface-cmParams .cm-tab-btn.active .delete-material-btn {
            opacity: 1;
        }
        #interface-cmParams .cm-tab-btn .delete-material-btn:hover {
            transform: scale(1.2);
        }

        /* CM Params Grid */
        #interface-cmParams .cm-material-section {
            border: 1px solid #334155; /* Dark border */
            border-radius: 0 6px 6px 6px;
            padding: 1rem;
            background: linear-gradient(to bottom right, #0f172a, #1e293b); /* Dark gradient */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        #interface-cmParams .param-grid-container {
            font-family: 'Consolas', 'Menlo', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            background-color: #1e293b; /* Dark container background */
            border: 1px solid #334155; /* Dark border */
            border-radius: 0.375rem;
            padding: 1rem;
            overflow-x: auto;
            max-width: 100%;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        #interface-cmParams .param-ruler {
            color: #60a5fa; /* Blue ruler text */
            white-space: pre;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }
        #interface-cmParams .param-row-labels {
            display: flex;
            color: #93c5fd; /* Light blue labels */
            font-weight: 600;
            border-bottom: 1px solid #334155; /* Dark separator */
        }
        #interface-cmParams .param-row-inputs {
            display: flex;
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #334155; /* Dark separator */
        }
        #interface-cmParams .param-row-inputs:last-of-type {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: 0;
        }
        #interface-cmParams .param-row-labels :first-child,
        #interface-cmParams .param-row-inputs :first-child {
            border-left: none;
            padding-left: 0.25rem;
        }
        #interface-cmParams .param-label,
        #interface-cmParams .param-input-wrapper,
        #interface-cmParams .param-spacer {
            padding: 0.25rem 0.5rem;
            text-align: right;
            border-left: 1px solid #334155; /* Dark separators */
            flex-shrink: 0;
        }
        #interface-cmParams .param-row-labels :first-child,
        #interface-cmParams .param-row-inputs :first-child {
            border-left: none;
            padding-left: 0.25rem;
        }
        #interface-cmParams .param-label {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: help;
            font-size: 0.875rem;
            text-shadow: 0 1px 1px rgba(0,0,0,0.5);
        }
        #interface-cmParams .param-input {
            width: 100%;
            background-color: #0f172a; /* Very dark input background */
            border: 1px solid #334155; /* Dark border */
            border-radius: 0.25rem;
            font: inherit;
            text-align: right;
            padding: 0.125rem 0.25rem;
            -moz-appearance: textfield;
            color: #e2e8f0; /* Light text */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
        }
        #interface-cmParams .param-input::-webkit-outer-spin-button,
        #interface-cmParams .param-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        #interface-cmParams .param-input:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #60a5fa; /* Blue focus border */
            box-shadow: 0 0 0 1px #60a5fa;
        }
        #interface-cmParams .param-input.border-red-500 {
            border-color: #f87171; /* Red error border */
        }
        #interface-cmParams .param-input.shadow-outline-red:focus {
            box-shadow: 0 0 0 1px #f87171; /* Red focus shadow */
        }
        #interface-cmParams .param-spacer {
            border-left: none;
        }
        #interface-cmParams .w-5ch {
            flex-basis: 5ch;
            min-width: 5ch;
        }
        #interface-cmParams .w-10ch {
            flex-basis: 10ch;
            min-width: 10ch;
        }
        #interface-cmParams #concatenated-output {
            font-family: 'Consolas', 'Menlo', 'Courier New', monospace;
            white-space: pre; /* Preserve fixed-width formatting */
            overflow: auto; /* Enable horizontal and vertical scrolling */
            background: linear-gradient(to bottom right, #1e293b, #0f172a); /* Dark gradient */
            border: 1px solid #334155; /* Dark border */
            border-radius: 0.5rem;
            padding: 1rem;
            /* min-height removed, handled by Tailwind h-64 class */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
            color: #93c5fd; /* Light blue text */
        }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 1.25rem; /* 20px */
            right: 1.25rem; /* 20px */
            background-color: #1e293b; /* Dark background */
            color: #e2e8f0; /* Light text */
            padding: 0.75rem 1.25rem; /* 12px 20px */
            border-radius: 0.5rem; /* 8px */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 50;
            border: 1px solid #334155; /* Dark border */
        }
        
        /* Button styles for dark mode */
        #interface-cmParams .btn-primary {
            background: linear-gradient(to bottom, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #interface-cmParams .btn-primary:hover {
            background: linear-gradient(to bottom, #2563eb, #1d4ed8);
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
        }
        #interface-cmParams .btn-secondary {
            background: linear-gradient(to bottom, #4b5563, #374151);
            color: #e5e7eb;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #interface-cmParams .btn-secondary:hover {
            background: linear-gradient(to bottom, #374151, #1f2937);
            box-shadow: 0 4px 6px rgba(0,0,0,0.4);
        }
        
        /* Reference Table Styles */
        #interface-cmParams .reference-table-container {
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            max-height: 500px;
            overflow-y: auto;
        }
        #interface-cmParams .reference-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            color: #cbd5e1;
        }
        #interface-cmParams .reference-table th {
            background-color: #334155;
            padding: 0.5rem;
            text-align: center;
            border: 1px solid #475569;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #interface-cmParams .reference-table td {
            padding: 0.4rem;
            border: 1px solid #334155;
            text-align: center;
            background-color: #0f172a;
        }
        #interface-cmParams .reference-table tr:nth-child(even) td {
            background-color: #1e293b;
        }
        #interface-cmParams .reference-table tr:hover td {
            background-color: #334155;
        }
        #interface-cmParams .reference-table-container::-webkit-scrollbar {
            width: 8px;
        }
        #interface-cmParams .reference-table-container::-webkit-scrollbar-track {
            background: #0f172a;
        }
        #interface-cmParams .reference-table-container::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        #interface-cmParams .reference-table-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Sticky header for reference table */
        #interface-cmParams .sticky-header {
            position: sticky;
            top: 0;
            background-color: #334155;
            z-index: 20;
        }
        /* --- END STYLES FROM PHASE 3 --- */

        /* --- STYLES FROM PHASE 4 --- */
        /* These styles are mostly for .config-input, .data-grid, etc. */
        /* They are very similar to Phase 2, but I will add them for completeness */
        /* and to catch any specific overrides for Phase 4. */
        
        /* Custom input styles for clarity (Phase 4) */
        /* These are slightly different from Phase 2, using gray-600, gray-700 */
        #interface-modelConfig .config-input, #interface-modelConfig .config-select {
            border: 1px solid #4b5563; /* gray-600 */
            background-color: #374151; /* gray-700 */
            color: #f3f4f6; /* gray-100 */
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.9rem;
        }

        /* Styles for invalid inputs (Phase 4) */
        #interface-modelConfig .config-input.invalid, #interface-modelConfig .data-grid td.invalid {
            border-color: #f87171; /* red-400 */
            background-color: #450a0a; /* dark-red-900 */
            outline: 1px solid #f87171;
            color: #fecaca; /* red-200 */
        }
        #interface-modelConfig .data-grid td.invalid:focus {
             box-shadow: inset 0 0 0 2px #f87171;
        }

        /* Custom tab styles (Phase 4) */
        #interface-modelConfig .tab-btn {
            border-bottom: 2px solid transparent;
            transition: border-color 0.3s, color 0.3s;
        }
        #interface-modelConfig .tab-btn.active {
            border-bottom-color: #60a5fa; /* blue-400 */
            color: #60a5fa; /* blue-400 */
            font-weight: 600;
        }
        
        /* Tab styles for the inspection panel (Phase 4) */
        #interface-modelConfig .inspect-tab-btn {
            border: 1px solid #374151; /* gray-700 */
            border-bottom: 0;
            background-color: #1f2937; /* gray-800 */
            color: #9ca3af; /* gray-400 */
            margin-bottom: -1px;
            border-radius: 6px 6px 0 0;
        }
        #interface-modelConfig .inspect-tab-btn:hover {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
        }
        #interface-modelConfig .inspect-tab-btn.active {
            background-color: #1f2937; /* gray-800 (pane color) */
            border-color: #374151; /* gray-700 */
            border-bottom-color: #1f2937; /* gray-800 (pane color) */
            font-weight: 600;
            color: #60a5fa; /* blue-400 */
        }

        /* Top-level App Tab Styles (Phase 4) */
        #interface-modelConfig .app-tab-btn {
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            font-size: 1rem; /* text-base */
            font-weight: 600; /* font-semibold */
            border-radius: 6px 6px 0 0;
            border: 1px solid transparent;
            border-bottom: 0;
            cursor: pointer;
            background-color: #374151; /* gray-700 */
            color: #9ca3af; /* gray-400 */
            margin-bottom: -1px; /* Overlap the border-b */
        }
        #interface-modelConfig .app-tab-btn.active {
            background-color: #1f2937; /* gray-800 */
            color: #60a5fa; /* blue-400 */
            border-color: #374151; /* gray-700 */
        }
        #interface-modelConfig .interface-pane {
            border-top: 1px solid #374151; /* gray-700 */
            background-color: #1f2937; /* gray-800 */
        }

        /* Dragging highlight (Phase 4) */
        #interface-modelConfig .dragging {
            opacity: 0.5;
            background: #422006; /* dark-yellow */
            border: 2px dashed #60a5fa;
        }

        /* Data Grid Styles (Phase 4) */
        #interface-modelConfig .data-grid-container { 
            width: 100%; 
            overflow: auto; 
            max-height: 500px; 
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 0.375rem; 
        }
        #interface-modelConfig .data-grid { border-collapse: collapse; width: 100%; font-size: 0.875rem; }
        #interface-modelConfig .data-grid th, #interface-modelConfig .data-grid td { 
            border: 1px solid #374151; /* gray-700 */
            padding: 0.5rem 0.75rem; 
            text-align: left; 
            white-space: nowrap; 
            color: #d1d5db; /* gray-300 */
        }
        #interface-modelConfig .data-grid th { 
            background-color: #111827; /* gray-900 */ 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            user-select: none; 
            min-width: 200px; 
            color: #e5e7eb; /* gray-200 */
        }
        #interface-modelConfig .data-grid th.header-drag-target { cursor: move; }
        
        /* Highlighting for selected source headers (Phase 4) */
        #interface-modelConfig .data-grid th.source-grid-header.selected {
            background-color: #1e3a8a; /* blue-900 */
            border-left-color: #3b82f6; /* blue-500 */
            border-right-color: #3b82f6; /* blue-500 */
        }

        #interface-modelConfig .data-grid th.source-grid-header { cursor: default; }
        #interface-modelConfig .data-grid th.source-grid-header .source-header-content { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; font-weight: 600; }
        #interface-modelConfig .data-grid th.source-grid-header .form-checkbox { height: 1rem; width: 1rem; }
        #interface-modelConfig .data-grid th .config-group { font-size: 0.75rem; font-weight: normal; display: flex; flex-direction: column; gap: 4px; margin-top: 8px; }
        #interface-modelConfig .data-grid th .config-group label { display: flex; align-items: center; justify-content: space-between; }
        #interface-modelConfig .data-grid th .config-group .config-input, #interface-modelConfig .data-grid th .config-group .config-select { font-size: 0.75rem; padding: 2px 4px; width: 100px; }
        #interface-modelConfig .data-grid th .config-group .col-name-input { width: 100%; font-size: 0.875rem; font-weight: 600; padding: 2px 4px; }
        #interface-modelConfig .data-grid th .config-group .calc-input { width: 100%; font-size: 0.75rem; padding: 2px 4px; }
        #interface-modelConfig .data-grid th .config-group .calc-select { width: 100%; font-size: 0.75rem; padding: 2px 4px; }
        #interface-modelConfig .data-grid th .col-header-content { display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; }
        #interface-modelConfig .data-grid th .col-remove-btn { 
            font-weight: bold; 
            font-size: 1.1rem; 
            color: #f87171; /* red-400 */
            cursor: pointer; 
            padding: 0 4px; 
            border-radius: 4px; 
        }
        #interface-modelConfig .data-grid th .col-remove-btn:hover { background-color: #7f1d1d; /* red-900 */ }
        
        /* Scoping the contenteditable rule to phase 4 */
        #interface-modelConfig .data-grid td[contenteditable="true"] { background-color: #2a271c; outline: none; }
        #interface-modelConfig .data-grid td[contenteditable="true"]:focus { 
            background-color: #1f2937; /* gray-800 */
            box-shadow: inset 0 0 0 2px #3b82f6; /* blue-500 */
        }
        #interface-modelConfig .header-drag-over { background-color: #1e40af; /* blue-800 */ }
        
        /* Substitution row styles (Phase 4) */
        .sub-row { display: flex; gap: 4px; align-items: center; margin-bottom: 2px; }
        .sub-row input { width: 60px; font-size: 0.75rem; padding: 2px 4px; }
        .sub-row span { font-size: 0.75rem; color: #d1d5db; /* gray-300 */ }
        .sub-row .sub-remove-btn { 
            cursor: pointer; 
            color: #f87171; /* red-400 */
            font-weight: bold; 
            font-size: 1rem; 
            padding: 0 4px; 
            border-radius: 4px; 
        }
        .sub-row .sub-remove-btn:hover { background-color: #7f1d1d; /* red-900 */ }
        /* --- END STYLES FROM PHASE 4 --- */

        /* --- EQUAL DISP BOUNDARY STYLES --- */
        /* Glassmorphism effect */
        #interface-equalDisp .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-radius: 16px;
        }
        
        /* Neon glow effect */
        #interface-equalDisp .neon-glow {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        
        /* Animated gradient button */
        #interface-equalDisp .gradient-button {
            background: linear-gradient(45deg, #3b82f6, #60a5fa, #3b82f6);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Inputs */
        #interface-equalDisp .config-input, #interface-equalDisp .config-select {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.5);
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: #e2e8f0;
            transition: all 0.3s ease;
        }
        
        #interface-equalDisp .config-input:focus, #interface-equalDisp .config-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        /* Data Grids */
        #interface-equalDisp .data-grid-container {
            width: 100%;
            overflow: auto;
            max-height: 500px;
            border: 1px solid rgba(100, 116, 139, 0.5);
            border-radius: 0.75rem;
            background: rgba(15, 23, 42, 0.5);
        }
        
        #interface-equalDisp .data-grid {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.875rem;
        }
        
        #interface-equalDisp .data-grid th, #interface-equalDisp .data-grid td {
            border: 1px solid rgba(100, 116, 139, 0.3);
            padding: 0.75rem;
            text-align: left;
            white-space: nowrap;
        }
        
        #interface-equalDisp .data-grid th {
            background: rgba(30, 41, 59, 0.8);
            position: sticky;
            top: 0;
            z-index: 10;
            user-select: none;
            cursor: move;
            min-width: 150px;
        }
        
        #interface-equalDisp .data-grid th.source-grid-header {
            cursor: default;
        }
        
        #interface-equalDisp .data-grid th.source-grid-header .source-header-content {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        #interface-equalDisp .data-grid th.source-grid-header .form-checkbox {
            height: 1rem;
            width: 1rem;
        }
        
        #interface-equalDisp .data-grid th .config-group {
            font-size: 0.75rem;
            font-weight: normal;
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 8px;
        }
        
        #interface-equalDisp .data-grid th .config-group label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 4px;
        }
        
        #interface-equalDisp .data-grid th .config-group .config-input, #interface-equalDisp .data-grid th .config-group .config-select {
            font-size: 0.75rem;
            padding: 4px;
            width: auto;
            flex-grow: 1;
            min-width: 60px;
        }
        
        #interface-equalDisp .data-grid th .config-group .col-name-input {
            width: 100%;
            font-size: 0.875rem;
            font-weight: 600;
            padding: 4px;
        }
        
        #interface-equalDisp .data-grid th .config-group .calc-input {
            width: 100%;
            font-size: 0.75rem;
            padding: 4px;
        }
        
        #interface-equalDisp .data-grid th .config-group .calc-select {
            width: 100%;
            font-size: 0.75rem;
            padding: 4px;
        }
        
        #interface-equalDisp .data-grid th .col-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        
        #interface-equalDisp .data-grid th .col-remove-btn {
            font-weight: bold;
            font-size: 1.2rem;
            color: #ef4444;
            cursor: pointer;
            padding: 0 6px;
            border-radius: 4px;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }
        
        #interface-equalDisp .data-grid th .col-remove-btn:hover {
            background-color: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }
        
        #interface-equalDisp .data-grid td[contenteditable="true"] {
            background-color: rgba(255, 255, 240, 0.1);
            outline: none;
            transition: all 0.2s ease;
        }
        
        #interface-equalDisp .data-grid td[contenteditable="true"]:focus {
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 0 0 2px #3b82f6;
        }
        
        #interface-equalDisp .header-drag-over {
            background-color: rgba(59, 130, 246, 0.3);
        }
        
        /* Equal Disp */
        #interface-equalDisp .drop-zone {
            border: 2px dashed rgba(100, 116, 139, 0.5);
            border-radius: 1rem;
            padding: 2.5rem;
            text-align: center;
            color: #94a3b8;
            transition: all 0.3s ease;
            background: rgba(15, 23, 42, 0.5);
            cursor: pointer;
        }
        
        #interface-equalDisp .drop-zone:hover, #interface-equalDisp .drop-zone-over {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }
        
        #interface-equalDisp .source-column-container {
            border: 1px solid rgba(100, 116, 139, 0.5);
            border-radius: 1rem;
            background: rgba(15, 23, 42, 0.5);
            padding: 1.5rem;
            min-height: 120px;
        }
        
        #interface-equalDisp .file-tab-btn {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.5);
            border-bottom: 0;
            padding: 0.75rem 1.25rem;
            border-radius: 8px 8px 0 0;
            margin-bottom: -1px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #94a3b8;
        }
        
        #interface-equalDisp .file-tab-btn:hover {
            background: rgba(56, 70, 94, 0.7);
            color: #e2e8f0;
        }
        
        #interface-equalDisp .file-tab-btn.active {
            background: rgba(15, 23, 42, 0.8);
            font-weight: 600;
            color: #3b82f6;
            border-color: rgba(100, 116, 139, 0.5);
            border-bottom-color: rgba(15, 23, 42, 0.8);
        }
        
        #interface-equalDisp .source-column-list {
            border: 1px solid rgba(100, 116, 139, 0.5);
            border-radius: 0 8px 8px 8px;
            padding: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            min-height: 60px;
        }
        
        #interface-equalDisp .source-column-draggable {
            background: linear-gradient(45deg, rgba(59, 130, 246, 0.2), rgba(96, 165, 250, 0.2));
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: #bfdbfe;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            user-select: none;
            transition: all 0.3s ease;
        }
        
        #interface-equalDisp .source-column-draggable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        #interface-equalDisp .data-grid th.equal-disp-source-col {
            background: linear-gradient(45deg, rgba(59, 130, 246, 0.2), rgba(96, 165, 250, 0.1));
        }
        
        #interface-equalDisp .data-grid th.equal-disp-uniform-col {
            background: linear-gradient(45deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.1));
        }
        
        #interface-equalDisp .data-grid th.equal-disp-uniform-col .col-name-input {
            background: rgba(251, 191, 36, 0.1);
            font-style: italic;
        }
        
        /* Toast Notification */
        #interface-equalDisp #toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(20px);
        }
        
        #interface-equalDisp #toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        #interface-equalDisp #toast.success {
            border-left: 4px solid #10b981;
        }
        
        #interface-equalDisp #toast.error {
            border-left: 4px solid #ef4444;
        }
        
        #interface-equalDisp #toast.warning {
            border-left: 4px solid #f59e0b;
        }
        
        #interface-equalDisp #toast.info {
            border-left: 4px solid #3b82f6;
        }
        
        /* Section headers */
        #interface-equalDisp .section-header {
            position: relative;
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
            font-weight: 700;
            color: #e2e8f0;
        }
        
        #interface-equalDisp .section-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 2px;
        }
        
        /* Preview area */
        #interface-equalDisp #output-preview-equalDisp, #interface-equalDisp #final-output-equalDisp {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.5);
            border-radius: 0.75rem;
            color: #94f294;
            font-family: 'Fira Code', 'Consolas', monospace;
        }
        
        /* Data view */
        #interface-equalDisp #data-view-content-equalDisp {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(100, 116, 139, 0.5);
            border-radius: 0.75rem;
            color: #cbd5e1;
            font-family: 'Fira Code', 'Consolas', monospace;
        }
        
        /* Buttons */
        #interface-equalDisp .action-button {
            transition: all 0.3s ease;
            font-weight: 500;
            border-radius: 0.5rem;
            padding: 0.6rem 1.2rem;
        }
        
        #interface-equalDisp .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        #interface-equalDisp .action-button:active {
            transform: translateY(0);
        }
        
        #interface-equalDisp .primary-button {
            background: linear-gradient(45deg, #3b82f6, #60a5fa);
            color: white;
        }
        
        #interface-equalDisp .secondary-button {
            background: rgba(100, 116, 139, 0.3);
            color: #e2e8f0;
        }
        
        #interface-equalDisp .success-button {
            background: linear-gradient(45deg, #10b981, #34d399);
            color: white;
        }
        
        #interface-equalDisp .warning-button {
            background: linear-gradient(45deg, #f59e0b, #fbbf24);
            color: white;
        }
        
        #interface-equalDisp .danger-button {
            background: linear-gradient(45deg, #ef4444, #f87171);
            color: white;
        }
        
        /* Scrollbar styling */
        #interface-equalDisp ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        #interface-equalDisp ::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 4px;
        }
        
        #interface-equalDisp ::-webkit-scrollbar-thumb {
            background: rgba(100, 116, 139, 0.5);
            border-radius: 4px;
        }
        
        #interface-equalDisp ::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.7);
        }
        /* --- END EQUAL DISP BOUNDARY STYLES --- */

    </style>
</head>
<body>
    <!-- Floating particles for background effect -->
    <div id="particles-container" class="fixed inset-0 pointer-events-none z-0"></div>
    
    <div class="app-container">
        <!-- Enhanced Header -->
        <header class="header-container p-4 md:p-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 md:gap-6">
                <div class="logo-container">
                    <div class="dbbooster-logo">
                        <div class="logo-base">
                            <!-- Database Servers -->
                            <div class="server server-top"></div>
                            <div class="server server-middle"></div>
                            <div class="server server-bottom"></div>
                            
                            <!-- Connection Lines -->
                            <div class="connection-line line-1"></div>
                            <div class="connection-line line-2"></div>
                            <div class="connection-line line-3"></div>
                            
                            <!-- Automation Gear -->
                            <div class="gear">
                                <div class="gear-teeth">
                                    <div class="tooth"></div>
                                    <div class="tooth"></div>
                                    <div class="tooth"></div>
                                    <div class="tooth"></div>
                                    <div class="tooth"></div>
                                    <div class="tooth"></div>
                                    <div class="tooth"></div>
                                    <div class="tooth"></div>
                                </div>
                                <div class="gear-inner"></div>
                            </div>
                            
                            <!-- Data Transformation Arrow -->
                            <div class="transform-arrow">
                                <div class="arrow-line"></div>
                                <div class="arrow-head"></div>
                            </div>
                            
                            <!-- Performance Boost Elements -->
                            <div class="boost-element boost-1"></div>
                            <div class="boost-element boost-2"></div>
                            <div class="boost-element boost-3"></div>
                            
                            <!-- Speed Lines -->
                            <div class="speed-line speed-1"></div>
                            <div class="speed-line speed-2"></div>
                            <div class="speed-line speed-3"></div>
                        </div>
                    </div>
                    <div class="brand-content">
                        <h1 class="brand-title">DBbooster</h1>
                        <p class="brand-subtitle">Automated DBLEAVES Parser & Formatter</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button id="help-button" class="cta-button">
                        <i class="fas fa-rocket"></i>
                        <span class="hidden sm:inline">Get Started</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- NEW: Phase Navigation Bar -->
        <nav class="phase-nav-container">
            <!-- Desktop/Tablet Horizontal Scroll Nav -->
            <div class="hidden md:block">
                <div class="phase-nav-scroll" id="phase-nav-desktop">
                    <!-- Phase items will be injected here by JS -->
                </div>
            </div>
            <!-- Mobile Select Nav -->
            <div class="md:hidden">
                <select id="phase-nav-mobile" class="phase-nav-mobile">
                    <!-- Phase options will be injected here by JS -->
                </select>
            </div>
        </nav>
        <!-- END: Phase Navigation Bar -->

        <!-- Main Content -->
        <main class="main-content">
            <!-- ENHANCED Introduction Interface -->
            <div id="interface-introduction" class="interface-pane w-full max-w-full">
                <!-- ... content from phase 1 ... -->
                <div class="tech-header glass-card">
                    <h1 class="text-3xl md:text-4xl font-bold mb-3 md:mb-4">Welcome to DBbooster</h1>
                    <p class="text-lg md:text-xl text-gray-200">Streamline your geotechnical and structural simulation data workflows with cutting-edge automation</p>
                </div>
                <section class="intro-section glass-card p-6">
                    <h2>Core Features</h2>
                     <p>Select a module to get started with our powerful data processing capabilities:</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mt-6">
                        <!-- ... feature cards ... -->
                         <div class="feature-card">
                            <div class="feature-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                <div class="initial-stress-icon">
                                    <div class="stress-block">
                                        <div class="stress-lines">
                                            <div class="stress-line line-1"></div>
                                            <div class="stress-line line-2"></div>
                                            <div class="stress-line line-3"></div>
                                            <div class="stress-line line-4"></div>
                                        </div>
                                        <div class="stress-arrows">
                                            <div class="arrow-top"></div>
                                            <div class="arrow-bottom"></div>
                                            <div class="arrow-left"></div>
                                            <div class="arrow-right"></div>
                                        </div>
                                        <div class="stress-center"></div>
                                    </div>
                                </div>
                            </div>
                            <h3 class="text-lg md:text-xl font-semibold mb-2">Initial Stress</h3>
                            <p class="text-gray-300 text-sm md:text-base mb-3 flex-grow">Process stress data (<span class="code-inline">.xlsx</span>/<span class="code-inline">.csv</span>), calculate averages per solid, and generate formatted output.</p>
                            <div class="tech-badge">Upload → Edit → Analyze → Output</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <h3 class="text-lg md:text-xl font-semibold mb-2">CM Parameters</h3>
                            <p class="text-gray-300 text-sm md:text-base mb-3 flex-grow">Define constitutive model parameters for materials and generate fixed-width output lines.</p>
                            <div class="tech-badge">Input Parameters → Generate Output</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <h3 class="text-lg md:text-xl font-semibold mb-2">Model Configuration</h3>
                            <p class="text-gray-300 text-sm md:text-base mb-3 flex-grow">Parse S2K files, inspect tables, apply substitutions, and build custom output formats.</p>
                            <div class="tech-badge">Load S2K → Parse → Inspect/Edit → Build Format → Output</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon" style="background: linear-gradient(135deg, #ff8a00, #e52e71);">
                                <i class="fas fa-border-all"></i>
                            </div>
                            <h3 class="text-lg md:text-xl font-semibold mb-2">Equal Disp Boundary</h3>
                            <p class="text-gray-300 text-sm md:text-base mb-3 flex-grow">Load multiple spreadsheet files, extract columns, and consolidate into a single formatted output.</p>
                            <div class="tech-badge">Upload Files → Consolidate → Format → Output</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon" style="background: linear-gradient(135deg, #00c6ff, #0072ff);">
                                <i class="fas fa-wave-square"></i>
                            </div>
                            <h3 class="text-lg md:text-xl font-semibold mb-2">Earthquake Step Setting</h3>
                            <p class="text-gray-300 text-sm md:text-base mb-3 flex-grow">Generate formatted text lines for seismic analysis steps based on a specified step count.</p>
                            <div class="tech-badge">Input Step Count → Generate Output</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon" style="background: linear-gradient(135deg, #8a2be2, #5f9ea0);">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3 class="text-lg md:text-xl font-semibold mb-2">Ru-Acc-Time Diagram</h3>
                            <p class="text-gray-300 text-sm md:text-base mb-3 flex-grow">Visualize and analyze Ru-Acc-Time relationships for seismic analysis with interactive charts.</p>
                            <div class="tech-badge">Import Data → Visualize → Analyze → Export</div>
                        </div>
                    </div>
                </section>
                <section class="intro-section glass-card p-6">
                    <h2>Workflow Overview</h2>
                    <p>Most modules follow this general workflow for optimal data processing:</p>
                    <div class="workflow-diagram">
                        <!-- ... workflow steps ... -->
                        <div class="workflow-step">
                            <div class="step-number">1</div>
                            <h4 class="font-semibold text-base md:text-lg mb-1">Load Data</h4>
                            <p class="text-gray-300 text-xs md:text-sm">(File/Paste)</p>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">2</div>
                            <h4 class="font-semibold text-base md:text-lg mb-1">Parse/Process</h4>
                            <p class="text-gray-300 text-xs md:text-sm">(Extract Info)</p>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">3</div>
                            <h4 class="font-semibold text-base md:text-lg mb-1">Inspect & Edit</h4>
                            <p class="text-gray-300 text-xs md:text-sm">(Verify/Clean)</p>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">4</div>
                            <h4 class="font-semibold text-base md:text-lg mb-1">Configure Format</h4>
                            <p class="text-gray-300 text-xs md:text-sm">(Layout Rules)</p>
                        </div>
                        <div class="workflow-step">
                            <div class="step-number">5</div>
                            <h4 class="font-semibold text-base md:text-lg mb-1">Generate Output</h4>
                            <p class="text-gray-300 text-xs md:text-sm">(Copy/Download)</p>
                        </div>
                    </div>
                    <h3>Data Handling</h3>
                    <p>Files are processed locally in your browser using JavaScript. No data is uploaded to a server.</p>
                    <div class="data-flow">
                        <!-- ... data flow items ... -->
                        <div class="data-item">
                            <i class="fas fa-file-upload text-xl md:text-2xl mb-2 text-blue-400"></i>
                            <div class="font-semibold text-sm md:text-base">File Input</div>
                        </div>
                        <div class="data-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="data-item">
                            <i class="fas fa-microchip text-xl md:text-2xl mb-2 text-green-400"></i>
                            <div class="font-semibold text-sm md:text-base">Browser Processing</div>
                            <div class="text-xs text-gray-400 mt-1">(JS Libraries)</div>
                        </div>
                        <div class="data-arrow">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div class="data-item">
                            <i class="fas fa-file-code text-xl md:text-2xl mb-2 text-purple-400"></i>
                            <div class="font-semibold text-sm md:text-base">Formatted Text</div>
                            <div class="text-xs text-gray-400 mt-1">(Output)</div>
                        </div>
                    </div>
                </section>
                <section class="intro-section glass-card p-6">
                    <h2>Key Concepts</h2>
                    <div class="concept-list">
                        <!-- ... concept items ... -->
                        <div class="concept-item">
                            <strong>S2K File</strong>
                            Text format for structural analysis software (e.g., SAP2000).
                        </div>
                        <div class="concept-item">
                            <strong>DBLEAVES Columns</strong>
                            Specific columns in S2K tables targeted for extraction.
                        </div>
                        <div class="concept-item">
                            <strong>CM Parameters</strong>
                            Values defining material behavior for constitutive models.
                        </div>
                        <div class="concept-item">
                            <strong>Delimiter</strong>
                            Character(s) (space, comma, '=') separating data in S2K lines.
                        </div>
                        <div class="concept-item">
                            <strong>Output Columns</strong>
                            <span class="code-inline">Source</span>: Directly from input data.<br>
                            <span class="code-inline">Calculated</span>: Derived using conditional logic.<br>
                            <span class="code-inline">Uniform</span>: Fixed value for all rows.
                        </div>
                        <div class="concept-item">
                            <strong>Ru-Acc-Time</strong>
                            Relationship between Ru (Utilization Ratio), Acceleration, and Time in seismic analysis.
                        </div>
                    </div>
                </section>
                <section class="intro-section glass-card p-6">
                    <h2>Getting Started</h2>
                    <ol class="getting-started-steps">
                        <!-- ... steps ... -->
                        <li>Choose a module from the sidebar navigation.</li>
                        <li>Follow the numbered steps: Load data → Process → Configure → Generate.</li>
                        <li>Use inspect/edit tools to refine data.</li>
                        <li>Copy or download your formatted output.</li>
                    </ol>
                </section>
            </div>
            <!-- END ENHANCED Introduction Interface -->

            <!-- PHASE 2 (INITIAL STRESS) INTERFACE -->
            <div id="interface-initialStress" class="interface-pane hidden p-6">
                <div class="space-y-8">
                    <!-- ... content from phase 2 ... -->
                    <section class="card">
                        <h2 class="card-title">1. Load Stress Data (.xlsx, .csv)</h2>
                        <div class="flex flex-col md:flex-row items-center gap-4">
                            <label for="file-upload-initialStress" class="cursor-pointer btn-primary">
                                Upload Stress File
                            </label>
                            <input type="file" id="file-upload-initialStress" class="hidden" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                            <span id="file-name-initialStress" class="text-gray-400">No file selected</span>
                            <button id="clear-data-btn-initialStress" class="btn-danger hidden">Clear</button>
                            <div id="loading-indicator-initialStress" class="hidden">
                                <div class="spinner"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Upload file with stress data. Expects data in columns A, F, G, and H (Stresses) starting from row 4.</p>
                    </section>
                    <section id="data-view-section-initialStress" class="card hidden">
                        <h2 class="card-title">2. Review & Edit Data</h2>
                        <div id="summary-stats-initialStress" class="text-sm text-gray-400 bg-gray-800 p-3 rounded-lg mb-4"></div>
                        <div id="data-grid-container-initialStress" class="data-grid-container hidden">
                            <table class="data-grid">
                                <thead id="grid-head-initialStress"></thead>
                                <tbody id="grid-body-initialStress"></tbody>
                            </table>
                        </div>
                        <p id="grid-placeholder-initialStress" class="text-gray-600 text-center p-8">Upload a file to see data.</p>
                        <div id="pagination-controls-initialStress" class="flex justify-between items-center hidden mt-4">
                            <div class="flex items-center gap-2">
                                <label for="rows-per-page-initialStress" class="text-sm font-medium text-gray-400">Rows:</label>
                                <select id="rows-per-page-initialStress" class="config-select !text-sm">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="prev-page-initialStress" class="btn-secondary disabled:opacity-50">&larr; Prev</button>
                                <span id="page-info-initialStress" class="text-sm text-gray-400">Page 1 of 1</span>
                                <button id="next-page-initialStress" class="btn-secondary disabled:opacity-50">Next &rarr;</button>
                            </div>
                        </div>
                    </section>
                    <section id="stress-analysis-section-initialStress" class="card hidden">
                        <h2 class="card-title">3. Stress Analysis</h2>
                        <button id="run-analysis-btn-initialStress" class="w-full btn-success py-3 text-lg font-semibold">
                            Run Stress Analysis
                        </button>
                        <h3 class="font-semibold text-gray-300 mt-6 mb-3">Average Stress per Solid</h3>
                        <div class="data-grid-container max-h-64">
                            <table class="data-grid">
                                <thead id="avg-stress-head"></thead>
                                <tbody id="avg-stress-body"></tbody>
                            </table>
                        </div>
                        <p id="avg-stress-placeholder" class="text-gray-600 text-center p-8">Run analysis to see results.</p>
                    </section>
                    <section id="concatenation-module-section" class="card hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="card-title mb-0">4. Concatenation Module</h2>
                            <button id="copy-concat-btn" class="btn-primary">Copy Output</button>
                        </div>
                        <button id="generate-concatenation-btn" class="w-full btn-warning py-3 text-lg font-semibold mb-6">
                            Generate Formatted Output
                        </button>
                        <h3 class="font-semibold text-gray-300 mb-3">Preview</h3>
                        <div class="data-grid-container max-h-96">
                            <table class="data-grid">
                                <thead>
                                    <tr>
                                        <th>Solid</th>
                                        <th>F (abs)</th>
                                        <th>G (abs)</th>
                                        <th>H (abs)</th>
                                        <th>Add'l 1</th>
                                        <th>Add'l 2</th>
                                        <th>Add'l 3</th>
                                        <th>Concatenated Line</th>
                                    </tr>
                                </thead>
                                <tbody id="concat-preview-body"></tbody>
                            </table>
                        </div>
                        <p id="concat-preview-placeholder" class="text-gray-600 text-center p-8">Generate output to see preview.</p>
                    </section>
                </div>
            </div>
            <!-- END: PHASE 2 (INITIAL STRESS) INTERFACE -->

            <!-- PHASE 3 (CM PARAMETERS) INTERFACE -->
            <div id="interface-cmParams" class="interface-pane hidden">
                <div class="p-6 flex flex-col min-h-full">
                    <div class="flex border-b border-slate-700 mb-4">
                        <div id="cm-params-tabs-nav" class="flex space-x-1"></div>
                        <button id="add-cm-material-btn" class="ml-4 text-blue-400 hover:text-blue-300 font-bold text-2xl" title="Add New Material">+</button>
                    </div>
                    <div class="flex flex-col lg:flex-row gap-6">
                        <div id="cm-params-content" class="flex-grow overflow-auto space-y-6 lg:w-1/2"></div>
                        <div class="lg:w-1/2">
                            <h2 class="text-xl font-semibold mb-4 text-blue-400">Suggested CM Parameters Range</h2>
                            <div class="reference-table-container">
                                <table class="reference-table">
                                    <thead>
                                        <tr class="sticky-header">
                                            <th>Variable Name</th>
                                            <th>Symbol</th>
                                            <th>Bin (2007) Toyoura Sand (Dr=44%)</th>
                                            <th>Bin (2007) Toyoura Sand (Dr=75%)</th>
                                            <th>Bin (2007) Toyoura Sand (Dr=92%)</th>
                                            <th>Bao (2012) Sand</th>
                                            <th>Bao (2012) Clay</th>
                                            <th>Xiong (2014) Shirasu</th>
                                            <th>Xiong (2014) Silty Clay</th>
                                            <th>Xie (2023) Sand</th>
                                            <th>Xie (2023) Clay</th>
                                            <th>Bin (2023) Toyoura Sand</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Initial Void Ratio</td>
                                            <td>$$e_0$$</td>
                                            <td>0.81</td>
                                            <td>0.7</td>
                                            <td>0.63</td>
                                            <td>0.9</td>
                                            <td>—</td>
                                            <td>1.47 ~ 1.57</td>
                                            <td>—</td>
                                            <td>0.45 ~ 0.54</td>
                                            <td>0.84</td>
                                            <td>—</td>
                                        </tr>
                                        <tr>
                                            <td>ZRAMDA</td>
                                            <td>$$\lambda$$</td>
                                            <td>—</td>
                                            <td>0.05</td>
                                            <td>—</td>
                                            <td>0.022</td>
                                            <td>0.008</td>
                                            <td>0.105</td>
                                            <td>0.123</td>
                                            <td>0.035</td>
                                            <td>0.341</td>
                                            <td>0.05</td>
                                        </tr>
                                        <tr>
                                            <td>ZKAPA</td>
                                            <td>$$\kappa$$</td>
                                            <td>—</td>
                                            <td>0.006</td>
                                            <td>—</td>
                                            <td>0.008</td>
                                            <td>0.002</td>
                                            <td>0.007</td>
                                            <td>0.012</td>
                                            <td>0.008</td>
                                            <td>0.019</td>
                                            <td>0.0064</td>
                                        </tr>
                                        <tr>
                                            <td>ZMF</td>
                                            <td>$$M$$</td>
                                            <td>—</td>
                                            <td>1.3</td>
                                            <td>—</td>
                                            <td>2.5</td>
                                            <td>2.5</td>
                                            <td>0.47</td>
                                            <td>1.23</td>
                                            <td>1.3</td>
                                            <td>1.2</td>
                                            <td>1.3</td>
                                        </tr>
                                        <tr>
                                            <td>EPSO</td>
                                            <td>$$N$$</td>
                                            <td>—</td>
                                            <td>0.74</td>
                                            <td>—</td>
                                            <td>0.9</td>
                                            <td>0.88</td>
                                            <td>1.59</td>
                                            <td>0.81</td>
                                            <td>0.58</td>
                                            <td>0.98</td>
                                            <td>0.87</td>
                                        </tr>
                                        <tr>
                                            <td>POI</td>
                                            <td>$$\nu$$</td>
                                            <td>—</td>
                                            <td>0.3</td>
                                            <td>—</td>
                                            <td>0.3</td>
                                            <td>0.4</td>
                                            <td>0.3</td>
                                            <td>0.3</td>
                                            <td>0.3</td>
                                            <td>0.3</td>
                                            <td>0.3</td>
                                        </tr>
                                        <tr>
                                            <td>ZM</td>
                                            <td>$$m_R$$</td>
                                            <td>—</td>
                                            <td>0.1</td>
                                            <td>—</td>
                                            <td>2.5</td>
                                            <td>1.1</td>
                                            <td>1</td>
                                            <td>1</td>
                                            <td>0.1</td>
                                            <td>10</td>
                                            <td>0.01</td>
                                        </tr>
                                        <tr>
                                            <td>ZMS</td>
                                            <td>$$m_R^*$$</td>
                                            <td>—</td>
                                            <td>2.2</td>
                                            <td>—</td>
                                            <td>2.5</td>
                                            <td>0.02</td>
                                            <td>5</td>
                                            <td>5</td>
                                            <td>1.5</td>
                                            <td>0.5</td>
                                            <td>0.5</td>
                                        </tr>
                                        <tr>
                                            <td>RSO</td>
                                            <td>$$R_0$$</td>
                                            <td>0.01</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                        </tr>
                                        <tr>
                                            <td></td>
                                            <td>$$R_0^*$$</td>
                                            <td>—</td>
                                            <td>0.4</td>
                                            <td>0.7</td>
                                            <td>0.75</td>
                                            <td>0.75</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>0.2</td>
                                            <td>0.2</td>
                                            <td>0.75</td>
                                        </tr>
                                        <tr>
                                            <td>ZETAO</td>
                                            <td>$$\zeta_0$$</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>0</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                        </tr>
                                        <tr>
                                            <td>ZBR</td>
                                            <td>$$b_r$$</td>
                                            <td>—</td>
                                            <td>1.5</td>
                                            <td>—</td>
                                            <td>1.5</td>
                                            <td>—</td>
                                            <td>0.5</td>
                                            <td>—</td>
                                            <td>1.5</td>
                                            <td>1.5</td>
                                            <td>1.5</td>
                                        </tr>
                                        <tr>
                                            <td>ZMB</td>
                                            <td>$$b_l$$</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>0.95</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                            <td>—</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="mt-12 pt-6 border-t border-slate-700">
                        <h2 class="text-xl font-semibold mb-4 text-blue-400">Concatenated Output (All Materials)</h2>
                        <div class="flex flex-wrap items-center mb-4">
                            <button id="concat-cm-params-btn" class="bg-gradient-to-r from-blue-600 to-blue-800 text-white px-4 py-2 rounded-lg text-sm font-medium hover:from-blue-700 hover:to-blue-900 transition shadow-md mr-4 mb-2 sm:mb-0">Generate Lines for All Materials</button>
                            <button id="copy-output-btn" class="bg-gradient-to-r from-green-600 to-green-800 text-white px-4 py-2 rounded-lg text-sm font-medium hover:from-green-700 hover:to-green-900 transition shadow-md mb-2 sm:mb-0">Copy All</button>
                        </div>
                        <div class="mt-4">
                            <label for="concatenated-output" class="block text-sm font-medium text-slate-300 mb-1">Result:</label>
                            <textarea id="concatenated-output" readonly class="w-full h-64 p-3 border border-slate-600 rounded-lg font-mono text-xs shadow-inner bg-slate-800 text-blue-300" placeholder="Click 'Generate...'"></textarea>
                        </div>
                        <p class="text-xs text-slate-400 mt-2">Line 1-3 for each material, listed sequentially.</p>
                    </div>
                </div>
            </div>
            <!-- END: PHASE 3 (CM PARAMETERS) INTERFACE -->

            <!-- PHASE 4 (MODEL CONFIG) INTERFACE -->
            <div id="interface-modelConfig" class="interface-pane hidden">
                <div class="grid grid-cols-1 gap-0">
                    <!-- Step 1: Load Source Data -->
                    <div class="p-6 border-b border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">1. Load Source Data</h2>
                        <textarea id="s2k-input-modelConfig" class="w-full h-48 p-3 border border-gray-600 rounded-lg font-mono text-sm shadow-inner bg-gray-900 text-gray-200" placeholder="Paste S2K..."></textarea>
                        <div class="flex justify-between items-center my-3">
                            <label for="file-upload-modelConfig" class="cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition">Upload S2K</label>
                            <input type="file" id="file-upload-modelConfig" class="hidden" accept=".s2k,.txt,.asc,.csv">
                            <button id="clear-data-btn-modelConfig" class="bg-gray-600 text-gray-100 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-700 transition">Clear</button>
                        </div>
                        <div class="my-6">
                            <h3 class="font-semibold mb-2 text-gray-300">Delimiter(s) <span class="text-xs font-normal text-gray-400">(data lines)</span></h3>
                            <div id="delimiter-options-modelConfig" class="flex flex-wrap gap-x-6 gap-y-2">
                                <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="delim-space-modelConfig" value=" " class="form-checkbox h-5 w-5 text-blue-500 rounded" checked> <span class="text-gray-300">Space</span></label>
                                <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="delim-equal-modelConfig" value="=" class="form-checkbox h-5 w-5 text-blue-500 rounded" checked> <span class="text-gray-300">Equals (=)</span></label>
                                <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="delim-comma-modelConfig" value="," class="form-checkbox h-5 w-5 text-blue-500 rounded"> <span class="text-gray-300">Comma (,)</span></label>
                            </div>
                        </div>
                        <button id="parse-btn-modelConfig" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg font-semibold hover:bg-green-700 transition shadow-lg">Parse S2K File</button>
                    </div>
                    
                    <!-- Step 2: Inspect & Edit Source Tables -->
                    <div class="p-6 border-b border-gray-700">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">2. Inspect & Edit Source Tables</h2>
                        <p class="text-sm text-gray-400 mb-4">DBLEAVES columns are selected automatically. Use the 'Convert' button in the Joint Restraints tab as needed.</p>
                        <div class="flex border-b border-gray-700 mb-4">
                            <div id="inspect-tabs-nav-modelConfig" class="flex space-x-1"></div>
                        </div>
                        <div id="inspect-tabs-content-modelConfig"></div>
                    </div>
                    
                    <!-- Step 3: Format Builder & Output -->
                    <div class="p-6 bg-gray-900">
                        <h2 class="text-xl font-semibold mb-4 text-gray-200">3. Format Builder & Output</h2>
                        <div class="flex border-b border-gray-700 mb-4">
                            <div id="format-tabs-nav-modelConfig" class="flex space-x-4"></div>
                            <button id="add-tab-btn-modelConfig" class="ml-4 text-blue-400 hover:text-blue-300 font-bold text-lg" title="Add New Format Tab">+</button>
                        </div>
                        <div id="format-tabs-content-modelConfig"></div>
                    </div>
                </div>
            </div>
            <!-- END: PHASE 4 (MODEL CONFIG) INTERFACE -->

            <!-- PHASE 5 (EQUAL DISP BOUNDARY) INTERFACE -->
            <div id="interface-equalDisp" class="interface-pane hidden">
                <!-- File Upload Section -->
                <section class="glass-card p-6 neon-glow">
                    <h2 class="section-header text-2xl">1. Load Files (.xlsx, .csv)</h2>
                    <div id="drop-zone-equalDisp" class="drop-zone">
                        <div class="flex flex-col items-center justify-center gap-4">
                            <svg class="w-16 h-16 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <div>
                                <p class="text-lg font-medium">Drag & drop your files here</p>
                                <p class="text-blue-300 mt-2">or <label for="file-upload-equalDisp" class="font-medium text-blue-400 hover:text-blue-300 cursor-pointer underline">browse files</label></p>
                            </div>
                            <p class="text-sm text-slate-400">Supports XLSX and CSV formats</p>
                        </div>
                        <input type="file" id="file-upload-equalDisp" class="hidden" multiple accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                    </div>
                    <div class="mt-4 flex justify-center">
                        <button id="clear-files-btn-equalDisp" class="action-button danger-button flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Clear All Files
                        </button>
                    </div>
                </section>
                
                <!-- Loaded Files Section -->
                <section class="glass-card p-6 neon-glow">
                    <h2 class="section-header text-2xl">2. Loaded Files</h2>
                    <p class="text-slate-300 mb-4">Select a loaded file to view its source data. Format Builder combines <span class="font-bold text-blue-300">all</span> files.</p>
                    <div id="source-columns-container-equalDisp" class="source-column-container">
                        <div id="file-tabs-equalDisp" class="flex flex-wrap gap-2 mb-4"></div>
                        <div id="source-column-list-equalDisp" class="source-column-list">
                            <p class="text-slate-400">Upload a file to see its extracted column here.</p>
                        </div>
                    </div>
                    <div id="data-view-container-equalDisp" class="w-full h-64 p-4 border border-slate-700 rounded-lg bg-slate-900/50 overflow-auto mt-4">
                        <pre id="data-view-content-equalDisp" class="font-mono text-sm">No data loaded.</pre>
                    </div>
                </section>
                
                <!-- Format Builder Section -->
                <section id="format-builder-equalDisp" class="glass-card p-6 neon-glow">
                    <h2 class="section-header text-2xl">3. Format Builder & Output</h2>
                    <div class="flex flex-wrap justify-between items-center gap-4 mb-6">
                        <div class="flex flex-wrap gap-3">
                            <button id="import-all-cols-btn-equalDisp" class="action-button success-button flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Import All Columns
                            </button>
                            <button id="add-manual-col-btn-equalDisp" class="action-button warning-button flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add Manual Column
                            </button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="undo-btn-equalDisp" class="action-button secondary-button flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                                Undo
                            </button>
                            <button id="redo-btn-equalDisp" class="action-button secondary-button flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                                </svg>
                                Redo
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold mb-4 text-slate-200">Consolidated Data Grid</h3>
                    <div id="data-grid-container-equalDisp" class="data-grid-container">
                        <table class="data-grid" id="data-grid-equalDisp">
                            <thead id="grid-head-equalDisp"></thead>
                            <tbody id="grid-body-equalDisp"></tbody>
                        </table>
                    </div>
                    <p id="grid-placeholder-equalDisp" class="text-slate-400 text-center p-12">Upload files and click 'Import All Columns' to begin.</p>
                    
                    <h3 class="text-xl font-semibold mt-8 mb-4 text-slate-200">Preview (First 10 Rows)</h3>
                    <pre id="output-preview-equalDisp" class="w-full h-40 p-4 rounded-lg bg-slate-900/50 overflow-auto"></pre>
                    
                    <h3 class="text-xl font-semibold mt-8 mb-4 text-slate-200">Final Output</h3>
                    <div class="flex gap-3 mb-3">
                        <button id="generate-output-btn-equalDisp" class="action-button primary-button flex-1 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Generate Output
                        </button>
                    </div>
                    <textarea id="final-output-equalDisp" class="w-full h-48 p-4 rounded-lg font-mono text-sm shadow-inner" placeholder="Click 'Generate' to create output..."></textarea>
                    
                    <div class="flex gap-4 mt-4">
                        <button id="copy-btn-equalDisp" class="action-button secondary-button flex-1 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                            Copy to Clipboard
                        </button>
                        <button id="download-btn-equalDisp" class="action-button secondary-button flex-1 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Download File
                        </button>
                    </div>
                </section>
            </div>
            <!-- END: PHASE 5 (EQUAL DISP BOUNDARY) INTERFACE -->

        </main>
        
        <!-- Footer -->
        <footer class="footer-container glass-card">
            <p>&copy; DBbooster 2025 | Developed by Minze Chen | All Rights Reserved</p>
            <p class="mt-1">Powered by advanced data processing and visualization technologies</p>
        </footer>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- START: PHASE 2 (INITIAL STRESS) SCRIPT ---
            // This logic is copied and merged from Phase 2 Initial stress.txt

            /**
             * Creates the initial state object for the Initial Stress interface.
             */
            function createInitialStressState() {
                 return {
                     fileName: null,
                     originalHeaders: [], // Store original header names corresponding to A, F, G, H
                     data: [], // Array of arrays, e.g., [[valA1, valF1, valG1, valH1], ...]
                     editedData: {}, // Store edits: { "row_col": newValue }
                     filters: {}, // { colIndex: filterValue }
                     currentPage: 1,
                     rowsPerPage: 25,
                     totalRows: 0,
                     filteredRows: 0,
                     analysisResults: { 
                        averageStressPerSolid: [], // [{ solid: '...', avgF: ..., avgG: ..., avgH: ... }]
                        patternAnalysis: [] // [{ solid: '...', startRow: ..., endRow: ..., count: ..., avgCombined: ... }]
                     },
                     concatenatedOutput: null // Store the final string output
                 };
            }
            
            // --- START: PHASE 3 (CM PARAMETERS) SCRIPT ---
            
            /**
             * Creates the initial state object for the CM Parameters interface.
             */
            function createCmParamsState() {
                return {
                    materials: [
                        {
                            id: 1,
                            name: "Material 1",
                            values: [
                                Array(8).fill(''),
                                Array(6).fill(''),
                                Array(6).fill('')
                            ]
                        }
                    ],
                    activeMaterialId: 1,
                    nextMaterialId: 2
                };
            }
            
            // --- START: PHASE 4 (MODEL CONFIG) SCRIPT ---
            
            /**
             * Creates a default state object for Model Configuration
             */
            function createModelConfigState() {
                return {
                    rawData: "", delimiters: [],
                    tableSchemas: {
                        jointCoordinates: { key: 'jointCoordinates', name: 'JOINT COORDINATES', headers: ['Joint', 'X', 'Y', 'Z', 'C5', 'C6'] },
                        connectivitySolid: { key: 'connectivitySolid', name: 'CONNECTIVITY - SOLID', headers: ['Solid', 'J1', 'J2', 'J3', 'J4', 'J5', 'J6', 'J7', 'J8'] },
                        jointRestraints: { key: 'jointRestraints', name: 'JOINT RESTRAINT ASSIGNMENTS', headers: ['Joint', 'UX', 'UY', 'UZ', 'RX', 'RY', 'RZ'] },
                        solidProperties: { key: 'solidProperties', name: 'SOLID PROPERTY ASSIGNMENTS', headers: ['Solid', 'Material'] }
                    },
                    tables: { jointCoordinates: [], connectivitySolid: [], jointRestraints: [], solidProperties: [] },
                    editedSourceData: {}, activeInspectTab: 'jointCoordinates', sourceColumnSelections: {}, sourceSubstitutions: {},
                    convertedSourceData: {}, 
                    formats: [ { id: 1, name: "Node format", primaryBaseTable: "jointCoordinates", secondaryBaseTable: "jointRestraints", columns: [], editedData: {} }, { id: 2, name: "Element format", primaryBaseTable: "connectivitySolid", secondaryBaseTable: "solidProperties", columns: [], editedData: {} } ],
                    activeFormatId: 1, nextFormatId: 3, draggedHeaderIndex: null,
                };
            }

            // --- START: PHASE 5 (EQUAL DISP BOUNDARY) SCRIPT ---
            
            // Global state for Equal Disp interface
            function createEqualDispState() {
                return {
                    files: [],
                    activeFileIndex: 0,
                    formats: [{
                        id: 1,
                        name: "Equal Disp Format",
                        columns: [],
                        editedData: {}
                    }],
                    activeFormatId: 1,
                    draggedHeaderIndex: null,
                    history: [],
                    historyIndex: -1
                };
            }

            // --- END: PHASE 5 SCRIPT (definitions) ---


            // --- MERGED GLOBAL STATE ---
            let globalState = { 
                activeInterface: 'phase1', // Default to phase 1
                interfaces: { 
                    initialStress: createInitialStressState(),
                    cmParams: createCmParamsState(),
                    modelConfig: createModelConfigState(),
                    equalDisp: createEqualDispState()
                    // Future phases will be added here
                } 
            };
           
            /**
             * Renamed from initialize() to avoid conflicts.
             * This sets up all listeners and default renders for Phase 2.
             */
            function initializePhase2() { 
                renderInitialStressGrid(); 
                renderStressAnalysisResults(); 
                renderConcatenationModule(); 

                // --- EVENT LISTENERS ---
                attachInitialStressListeners(); // Attach new listeners
            }

            // --- Initial Stress Functions ---
            
            /**
             * Attaches all event listeners for the Initial Stress interface.
             */
            function attachInitialStressListeners() {
                const fileInput = document.getElementById('file-upload-initialStress');
                const clearButton = document.getElementById('clear-data-btn-initialStress');
                const rowsSelect = document.getElementById('rows-per-page-initialStress');
                const prevButton = document.getElementById('prev-page-initialStress');
                const nextButton = document.getElementById('next-page-initialStress');
                const runAnalysisButton = document.getElementById('run-analysis-btn-initialStress'); 
                const generateConcatButton = document.getElementById('generate-concatenation-btn');
                const copyConcatButton = document.getElementById('copy-concat-btn');
                
                fileInput?.addEventListener('change', handleInitialStressFileUpload);
                clearButton?.addEventListener('click', clearInitialStressData);
                rowsSelect?.addEventListener('change', handleInitialStressRowsChange);
                prevButton?.addEventListener('click', () => handleInitialStressPagination('prev'));
                nextButton?.addEventListener('click', () => handleInitialStressPagination('next'));
                runAnalysisButton?.addEventListener('click', performStressAnalysis); 
                generateConcatButton?.addEventListener('click', generateConcatenatedOutput);
                copyConcatButton?.addEventListener('click', copyConcatenatedOutput);
            }
             
            /**
             * Handles the file upload event for the Initial Stress interface.
             */
            function handleInitialStressFileUpload(event) {
                 const file = event.target.files[0];
                 const fileNameDisplay = document.getElementById('file-name-initialStress');
                 const clearButton = document.getElementById('clear-data-btn-initialStress');
                 const loadingIndicator = document.getElementById('loading-indicator-initialStress');
                 const dataViewSection = document.getElementById('data-view-section-initialStress');
                 const analysisSection = document.getElementById('stress-analysis-section-initialStress'); 
                 const concatSection = document.getElementById('concatenation-module-section');

                 if (!file) {
                     fileNameDisplay.textContent = 'No file selected';
                     clearButton.classList.add('hidden');
                     dataViewSection.classList.add('hidden');
                     analysisSection?.classList.add('hidden'); 
                     concatSection?.classList.add('hidden'); 
                     return;
                 }

                 const allowedExtensions = /(\.xlsx|\.csv)$/i;
                 if (!allowedExtensions.exec(file.name)) {
                     showToast("Invalid file format. Please upload .xlsx or .csv", "error");
                     event.target.value = ''; 
                     fileNameDisplay.textContent = 'Invalid file format';
                     clearButton.classList.add('hidden');
                     dataViewSection.classList.add('hidden');
                     analysisSection?.classList.add('hidden'); 
                     concatSection?.classList.add('hidden'); 
                     return;
                 }

                 fileNameDisplay.textContent = file.name;
                 clearButton.classList.remove('hidden');
                 loadingIndicator.classList.remove('hidden');
                 dataViewSection.classList.remove('hidden'); 
                 analysisSection?.classList.remove('hidden'); 
                 concatSection?.classList.remove('hidden'); 
                 
                 globalState.interfaces.initialStress = createInitialStressState(); 
                 globalState.interfaces.initialStress.fileName = file.name;
                 renderInitialStressGrid(); 
                 renderStressAnalysisResults(); 
                 renderConcatenationModule(); 

                 const reader = new FileReader();

                 reader.onload = function (e) {
                     try {
                         const data = e.target.result;
                         let workbook;
                         if (file.name.endsWith('.xlsx')) {
                             workbook = XLSX.read(data, { type: 'binary' });
                         } else { 
                             workbook = XLSX.read(data, { type: 'string', raw: true }); 
                         }
                         const firstSheetName = workbook.SheetNames[0];
                         const worksheet = workbook.Sheets[firstSheetName];
                         
                         const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", rawNumbers: false }); 

                         const extractedData = [];
                         const headerRow = jsonData[0] || []; 
                         const headers = [
                             headerRow[0] ?? 'A', 
                             headerRow[5] ?? 'F', 
                             headerRow[6] ?? 'G', 
                             headerRow[7] ?? 'H'  
                         ];
                         
                         for (let i = 3; i < jsonData.length; i++) {
                             const row = jsonData[i];
                             const hasValue = row && (
                                 (row[0] !== undefined && row[0] !== "") || 
                                 (row[5] !== undefined && row[5] !== "") || 
                                 (row[6] !== undefined && row[6] !== "") || 
                                 (row[7] !== undefined && row[7] !== "")
                             );

                             if (hasValue) {
                                 extractedData.push([
                                     row[0] ?? "", 
                                     row[5] ?? "", 
                                     row[6] ?? "", 
                                     row[7] ?? ""  
                                 ]);
                             }
                         }

                         const state = globalState.interfaces.initialStress;
                         state.originalHeaders = headers; 
                         state.data = extractedData;
                         state.totalRows = extractedData.length;
                         state.filteredRows = extractedData.length; 
                         state.currentPage = 1; 
                         state.filters = {}; 
                         state.editedData = {}; 
                         state.analysisResults = { averageStressPerSolid: [], patternAnalysis: [] }; 

                         renderInitialStressGrid(); 
                         updateInitialStressSummary(); 
                         renderStressAnalysisResults(); 
                         renderConcatenationModule(); 
                         showToast(`Successfully processed ${state.totalRows} rows from ${file.name}.`, "success");

                     } catch (error) {
                         console.error("Error processing file:", error);
                         showToast(`Error processing file: ${error.message}`, "error");
                         clearInitialStressData(); 
                     } finally {
                         loadingIndicator.classList.add('hidden');
                         event.target.value = ''; 
                     }
                 };

                 reader.onerror = function (e) {
                     console.error("FileReader error:", e);
                     showToast("Error reading file.", "error");
                     loadingIndicator.classList.add('hidden');
                     clearInitialStressData();
                     event.target.value = ''; 
                 };

                 if (file.name.endsWith('.xlsx')) {
                     reader.readAsBinaryString(file);
                 } else {
                     reader.readAsText(file); 
                 }
            }

            /**
             * Clears all data, filters, and edits from the Initial Stress state
             * and resets the UI.
             */
            function clearInitialStressData() {
                 globalState.interfaces.initialStress = createInitialStressState();
                 document.getElementById('file-upload-initialStress').value = '';
                 document.getElementById('file-name-initialStress').textContent = 'No file selected';
                 document.getElementById('clear-data-btn-initialStress').classList.add('hidden');
                 document.getElementById('data-view-section-initialStress').classList.add('hidden');
                 document.getElementById('loading-indicator-initialStress').classList.add('hidden');
                 document.getElementById('stress-analysis-section-initialStress')?.classList.add('hidden'); 
                 document.getElementById('concatenation-module-section')?.classList.add('hidden'); 
                 renderInitialStressGrid(); 
                 renderStressAnalysisResults(); 
                 renderConcatenationModule(); 
                 showToast("Data cleared.", "info");
            }

            /**
             * Updates the summary statistics display (file name, row counts, page counts).
             */
            function updateInitialStressSummary() {
                const state = globalState.interfaces.initialStress;
                const summaryEl = document.getElementById('summary-stats-initialStress');
                if (summaryEl) {
                    const totalPages = Math.ceil(state.filteredRows / state.rowsPerPage) || 1;
                    summaryEl.innerHTML = `
                        <strong>File:</strong> ${state.fileName || 'N/A'} | 
                        <strong>Total Rows Imported:</strong> ${state.totalRows} | 
                        <strong>Rows Displayed:</strong> ${state.filteredRows} 
                        (${totalPages} pages)
                    `;
                }
            }

            /**
             * Renders the data grid for the Initial Stress interface based on
             * the current state (filters, pagination, edits).
             */
            function renderInitialStressGrid() {
                 const state = globalState.interfaces.initialStress;
                 const head = document.getElementById('grid-head-initialStress');
                 const body = document.getElementById('grid-body-initialStress');
                 const placeholder = document.getElementById('grid-placeholder-initialStress');
                 const gridContainer = document.getElementById('data-grid-container-initialStress');
                 const paginationControls = document.getElementById('pagination-controls-initialStress');

                 if (!head || !body || !placeholder || !gridContainer || !paginationControls) return;

                 head.innerHTML = '';
                 body.innerHTML = '';

                 if (state.data.length === 0) {
                     placeholder.classList.remove('hidden');
                     gridContainer.classList.add('hidden'); 
                     paginationControls.classList.add('hidden');
                     updateInitialStressSummary(); 
                     document.getElementById('stress-analysis-section-initialStress')?.classList.add('hidden'); 
                     document.getElementById('concatenation-module-section')?.classList.add('hidden'); 
                     return;
                 }

                 placeholder.classList.add('hidden');
                 gridContainer.classList.remove('hidden');
                 paginationControls.classList.remove('hidden');
                 document.getElementById('stress-analysis-section-initialStress')?.classList.remove('hidden');
                 document.getElementById('concatenation-module-section')?.classList.remove('hidden');

                 let filteredData = state.data;
                 Object.keys(state.filters).forEach(colIndex => {
                     const filterValue = String(state.filters[colIndex] || '').toLowerCase(); 
                     if (filterValue) {
                         filteredData = filteredData.filter(row => {
                            const cellValue = String(row[colIndex] ?? '').toLowerCase();
                            return cellValue.includes(filterValue);
                         });
                     }
                 });
                 state.filteredRows = filteredData.length; 

                 const totalPages = Math.ceil(state.filteredRows / state.rowsPerPage) || 1;
                 state.currentPage = Math.max(1, Math.min(state.currentPage, totalPages)); 
                 const startRow = (state.currentPage - 1) * state.rowsPerPage;
                 const endRow = startRow + state.rowsPerPage;
                 const paginatedData = filteredData.slice(startRow, endRow);

                 const trHead = head.insertRow();
                 state.originalHeaders.forEach((headerText, index) => {
                     const th = document.createElement('th');
                     th.style.minWidth = '150px'; 
                     th.innerHTML = `
                         <div>${headerText}</div>
                         <input type="text" 
                                class="is-filter-input config-input w-full mt-1" 
                                placeholder="Filter..." 
                                data-col-index="${index}"
                                value="${state.filters[index] || ''}">
                     `;
                     th.querySelector('.is-filter-input').addEventListener('input', handleInitialStressFilterChange);
                     trHead.appendChild(th);
                 });
                 
                 paginatedData.forEach((row) => {
                     const originalRowIndex = state.data.findIndex(originalRow => originalRow === row); 
                     if (originalRowIndex === -1) return; 

                     const tr = body.insertRow();
                     row.forEach((cellValue, colIndex) => {
                         const cellKey = `${originalRowIndex}_${colIndex}`;
                         const editedValue = state.editedData[cellKey];
                         const displayValue = editedValue !== undefined ? editedValue : cellValue;
                         
                         const td = tr.insertCell();
                         td.textContent = displayValue;
                         td.contentEditable = "true";
                         td.dataset.rowIndex = originalRowIndex; 
                         td.dataset.colIndex = colIndex;
                         td.addEventListener('blur', handleInitialStressCellEdit);
                         
                         if (editedValue !== undefined) {
                             td.style.backgroundColor = '#1e3a8a'; 
                             td.style.fontStyle = 'italic';
                         }
                     });
                 });

                 document.getElementById('page-info-initialStress').textContent = `Page ${state.currentPage} of ${totalPages}`;
                 document.getElementById('prev-page-initialStress').disabled = state.currentPage === 1;
                 document.getElementById('next-page-initialStress').disabled = state.currentPage === totalPages;
                 document.getElementById('rows-per-page-initialStress').value = state.rowsPerPage;
                 
                 updateInitialStressSummary(); 
             }
             
            /**
             * Handles changes to the filter inputs in the grid header.
             */
            function handleInitialStressFilterChange(event) {
                 const colIndex = event.target.dataset.colIndex;
                 const filterValue = event.target.value;
                 const state = globalState.interfaces.initialStress;
                 
                 if (filterValue) {
                     state.filters[colIndex] = filterValue;
                 } else {
                     delete state.filters[colIndex];
                 }
                 
                 state.currentPage = 1; 
                 renderInitialStressGrid();
            }

            /**
             * Handles the 'blur' event when editing a cell in the data grid.
             */
            function handleInitialStressCellEdit(event) {
                 const td = event.target;
                 const rowIndex = parseInt(td.dataset.rowIndex);
                 const colIndex = parseInt(td.dataset.colIndex);
                 if (isNaN(rowIndex) || isNaN(colIndex)) {
                     console.error("Invalid row or column index for editing:", td.dataset.rowIndex, td.dataset.colIndex);
                     return; 
                 }
                 const newValue = td.textContent.trim();
                 const state = globalState.interfaces.initialStress;
                 
                 if (!state.data[rowIndex]) {
                     console.error("Data not found for row index:", rowIndex);
                     const cellKeyFallback = `${rowIndex}_${colIndex}`;
                     td.textContent = state.editedData[cellKeyFallback] ?? ''; 
                     showToast("Error finding original data for edit.", "error");
                     return;
                 }

                 const originalValue = state.data[rowIndex][colIndex];
                 const cellKey = `${rowIndex}_${colIndex}`;

                 if ([1, 2, 3].includes(colIndex) && newValue !== "" && isNaN(Number(newValue))) {
                    showToast(`Invalid input for ${state.originalHeaders[colIndex]}. Please enter a number or leave blank.`, "warning");
                    td.textContent = state.editedData[cellKey] ?? originalValue ?? '';
                    return; 
                 }


                 if (newValue === String(originalValue ?? '')) {
                     delete state.editedData[cellKey];
                     td.style.backgroundColor = ''; 
                     td.style.fontStyle = '';
                 } else {
                     state.editedData[cellKey] = newValue;
                     td.style.backgroundColor = '#1e3a8a'; 
                     td.style.fontStyle = 'italic';
                     showToast(`Cell [Row ${rowIndex+1}, Col ${state.originalHeaders[colIndex]}] updated. Clear analysis results.`, "info");
                 }
                 clearStressAnalysisResults(); 
                 clearConcatenationResults(); 
            }

            /**
             * Handles changing the number of rows displayed per page.
             */
            function handleInitialStressRowsChange(event) {
                 const state = globalState.interfaces.initialStress;
                 state.rowsPerPage = parseInt(event.target.value);
                 state.currentPage = 1; 
                 renderInitialStressGrid();
            }

            /**
             * Handles the 'Previous' and 'Next' page buttons.
             */
            function handleInitialStressPagination(direction) {
                 const state = globalState.interfaces.initialStress;
                 const totalPages = Math.ceil(state.filteredRows / state.rowsPerPage) || 1; 
                 if (direction === 'prev' && state.currentPage > 1) {
                     state.currentPage--;
                 } else if (direction === 'next' && state.currentPage < totalPages) {
                     state.currentPage++;
                 }
                 renderInitialStressGrid();
            }
             
            // --- Stress Analysis Functions ---

            /**
             * Clears the analysis results from the state.
             */
            function clearStressAnalysisResults() {
                 const state = globalState.interfaces.initialStress;
                 state.analysisResults = { averageStressPerSolid: [], patternAnalysis: [] };
                 renderStressAnalysisResults(); 
                 clearConcatenationResults(); 
            }

            /**
             * Performs the stress analysis calculation.
             */
            function performStressAnalysis() {
                 const state = globalState.interfaces.initialStress;
                 if (state.data.length === 0) {
                     showToast("No data loaded to analyze.", "warning");
                     return;
                 }
                 
                 showToast("Running stress analysis...", "info");

                 const getDataWithEdits = () => {
                     return state.data.map((row, rowIndex) => {
                         return row.map((originalValue, colIndex) => {
                             const cellKey = `${rowIndex}_${colIndex}`;
                             return state.editedData[cellKey] !== undefined ? state.editedData[cellKey] : originalValue;
                         });
                     });
                 };
                 const currentData = getDataWithEdits();

                 const stressPerSolid = {}; 
                 
                 currentData.forEach(row => {
                    const solidId = row[0]; 
                    const stressF = parseFloat(row[1]); 
                    const stressG = parseFloat(row[2]); 
                    const stressH = parseFloat(row[3]); 

                    if (solidId === "" || solidId === undefined) return; 

                    if (!stressPerSolid[solidId]) {
                        stressPerSolid[solidId] = { f: [], g: [], h: [] };
                    }
                    if (!isNaN(stressF)) stressPerSolid[solidId].f.push(stressF);
                    if (!isNaN(stressG)) stressPerSolid[solidId].g.push(stressG);
                    if (!isNaN(stressH)) stressPerSolid[solidId].h.push(stressH);
                 });

                 state.analysisResults.averageStressPerSolid = Object.keys(stressPerSolid).map(solidId => {
                     const stresses = stressPerSolid[solidId];
                     const avgF = stresses.f.length ? stresses.f.reduce((a, b) => a + b, 0) / stresses.f.length : NaN;
                     const avgG = stresses.g.length ? stresses.g.reduce((a, b) => a + b, 0) / stresses.g.length : NaN;
                     const avgH = stresses.h.length ? stresses.h.reduce((a, b) => a + b, 0) / stresses.h.length : NaN;
                     return { solid: solidId, avgF: avgF, avgG: avgG, avgH: avgH };
                 }).sort((a,b) => String(a.solid).localeCompare(String(b.solid), undefined, {numeric: true})); 

                 renderStressAnalysisResults(); 
                 clearConcatenationResults(); 
                 showToast("Stress analysis complete.", "success");
            }

            /**
             * Renders the "Average Stress per Solid" table.
             */
            function renderStressAnalysisResults() {
                 const state = globalState.interfaces.initialStress;
                 const avgHead = document.getElementById('avg-stress-head');
                 const avgBody = document.getElementById('avg-stress-body');
                 const avgPlaceholder = document.getElementById('avg-stress-placeholder');

                 if (!avgHead || !avgBody || !avgPlaceholder) return;

                 avgHead.innerHTML = '';
                 avgBody.innerHTML = '';
                 avgPlaceholder.classList.toggle('hidden', state.analysisResults.averageStressPerSolid.length > 0);

                 if (state.analysisResults.averageStressPerSolid.length > 0) {
                     avgHead.innerHTML = `<tr><th>Solid ID</th><th>Avg Stress F</th><th>Avg Stress G</th><th>Avg Stress H</th></tr>`;
                     state.analysisResults.averageStressPerSolid.forEach(result => {
                         const tr = avgBody.insertRow();
                         tr.insertCell().textContent = result.solid;
                         tr.insertCell().textContent = isNaN(result.avgF) ? 'N/A' : result.avgF.toFixed(3); 
                         tr.insertCell().textContent = isNaN(result.avgG) ? 'N/A' : result.avgG.toFixed(3);
                         tr.insertCell().textContent = isNaN(result.avgH) ? 'N/A' : result.avgH.toFixed(3);
                     });
                 }
            }

            // --- Concatenation Module Functions ---

            /**
             * Clears the concatenation preview table.
             */
            function clearConcatenationResults() {
                 const concatPreviewBody = document.getElementById('concat-preview-body');
                 const concatPreviewPlaceholder = document.getElementById('concat-preview-placeholder');
                 
                 if (concatPreviewBody) concatPreviewBody.innerHTML = '';
                 if (concatPreviewPlaceholder) concatPreviewPlaceholder.classList.remove('hidden');
                 globalState.interfaces.initialStress.concatenatedOutput = null; // Clear stored output
            }

            /**
             * Initializes the concatenation module section.
             */
            function renderConcatenationModule() {
                 const concatSection = document.getElementById('concatenation-module-section');
                 if (concatSection) {
                     return;
                 }
            }

            /**
             * Generates the final formatted text output.
             */
            function generateConcatenatedOutput() {
                 const state = globalState.interfaces.initialStress;
                 const concatPreviewBody = document.getElementById('concat-preview-body');
                 const concatPreviewPlaceholder = document.getElementById('concat-preview-placeholder');
                 
                 if (!state.analysisResults.averageStressPerSolid || state.analysisResults.averageStressPerSolid.length === 0) {
                     showToast("No analysis results available. Run stress analysis first.", "error");
                     return;
                 }
                 
                 try {
                     const results = state.analysisResults.averageStressPerSolid;
                     const lines = [];
                     
                     if (concatPreviewBody) concatPreviewBody.innerHTML = '';
                     if (concatPreviewPlaceholder) concatPreviewPlaceholder.classList.add('hidden');
                     
                     results.forEach((result, index) => {
                         const solidId = result.solid;
                         if (solidId === undefined || solidId === null || solidId === "") {
                             throw new Error(`Missing solid ID at row ${index + 1}`);
                         }
                         
                         const formattedSolidId = parseInt(solidId, 10).toString().padStart(5, '0');
                         
                         const avgF = result.avgF;
                         const avgG = result.avgG;
                         const avgH = result.avgH;
                         
                         if (isNaN(avgF) || isNaN(avgG) || isNaN(avgH)) {
                             throw new Error(`Invalid stress values for solid ${solidId}`);
                         }
                         
                         const absF = Math.abs(avgF);
                         const absG = Math.abs(avgG);
                         const absH = Math.abs(avgH);
                         
                         const formatStress = (value) => {
                             const fixed = value.toFixed(3);
                             const parts = fixed.split('.');
                             const integerPart = parts[0].padStart(3, '0');
                             return `${integerPart}.${parts[1]}`;
                         };
                         
                         const formattedF = formatStress(absF);
                         const formattedG = formatStress(absG);
                         const formattedH = formatStress(absH);
                         
                         const additional1 = "000.000";
                         const additional2 = "000.000";
                         const additional3 = "000.000";
                         
                         const concatenatedLine = `${formattedSolidId}   ${formattedF}   ${formattedG}   ${formattedH}   ${additional1}   ${additional2}   ${additional3}`;
                         lines.push(concatenatedLine);
                         
                         if (concatPreviewBody) {
                             const tr = document.createElement('tr');
                             tr.innerHTML = `
                                 <td>${formattedSolidId}</td>
                                 <td>${formattedF}</td>
                                 <td>${formattedG}</td>
                                 <td>${formattedH}</td>
                                 <td>${additional1}</td>
                                 <td>${additional2}</td>
                                 <td>${additional3}</td>
                                 <td class="font-mono">${concatenatedLine}</td>
                             `;
                             concatPreviewBody.appendChild(tr);
                         }
                     });
                     
                     globalState.interfaces.initialStress.concatenatedOutput = lines.join('\n');
                     
                     showToast(`Generated concatenated output for ${lines.length} solids.`, "success");
                     
                 } catch (error) {
                     console.error("Concatenation error:", error);
                     showToast(`Error generating output: ${error.message}`, "error");
                     clearConcatenationResults();
                 }
            }

            /**
             * Copies the final concatenated output to the clipboard.
             */
            function copyConcatenatedOutput() {
                 if (!globalState.interfaces.initialStress.concatenatedOutput) {
                     showToast("Nothing to copy. Generate output first.", "error");
                     return;
                 }
                 
                 try {
                     const textArea = document.createElement('textarea');
                     textArea.value = globalState.interfaces.initialStress.concatenatedOutput;
                     document.body.appendChild(textArea);
                     textArea.select();
                     textArea.setSelectionRange(0, 99999);
                     document.execCommand('copy');
                     document.body.removeChild(textArea);
                     showToast("Copied to clipboard!", "success");
                 } catch (err) {
                     showToast("Copy failed.", "error");
                 }
            }
            
            // --- END: PHASE 2 SCRIPT ---


            // --- START: PHASE 3 (CM PARAMETERS) SCRIPT ---
            
            /**
             * Initializes the CM Parameters interface.
             */
            function initializePhase3() {
                renderCmParamsInterface();
                
                // Attach Event Listeners
                document.getElementById('concat-cm-params-btn')?.addEventListener('click', generateCmParamsConcatenatedLine);
                document.getElementById('add-cm-material-btn')?.addEventListener('click', addCmMaterial);
                document.getElementById('copy-output-btn')?.addEventListener('click', copyOutputToClipboard);
                
                // Trigger MathJax rendering for LaTeX
                if (typeof MathJax !== 'undefined') {
                    MathJax.typesetPromise && MathJax.typesetPromise();
                }
            }

            function renderCmParamsInterface() {
                renderCmParamsTabs();
                renderCmParamsSections();
            }

            function renderCmParamsTabs() {
                const state = globalState.interfaces.cmParams;
                const nav = document.getElementById('cm-params-tabs-nav');
                if (!nav) return;
                
                nav.innerHTML = "";
                
                state.materials.forEach(material => {
                    const btn = document.createElement('button');
                    btn.className = `cm-tab-btn ${material.id === state.activeMaterialId ? 'active' : ''}`;
                    btn.textContent = material.name;
                    btn.dataset.id = material.id;
                    btn.addEventListener('click', switchCmMaterialTab);
                    
                    if (state.materials.length > 1) {
                        const deleteBtn = document.createElement('span');
                        deleteBtn.className = 'delete-material-btn';
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.title = 'Delete Material';
                        deleteBtn.dataset.id = material.id;
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            deleteCmMaterial(material.id);
                        };
                        btn.appendChild(deleteBtn);
                    }
                    
                    nav.appendChild(btn);
                });
            }

            function renderCmParamsSections() {
                const state = globalState.interfaces.cmParams;
                const content = document.getElementById('cm-params-content');
                if (!content) return;
                
                content.innerHTML = "";
                
                state.materials.forEach(m => {
                    const section = createCmMaterialSection(m);
                    section.classList.toggle('hidden', m.id !== state.activeMaterialId);
                    content.appendChild(section);
                });
            }

            function createCmMaterialSection(material) {
                const section = document.createElement('div');
                section.id = `cm-material-section-${material.id}`;
                section.className = 'cm-material-section';
                
                section.innerHTML = `
                    <h3 class="text-lg font-medium mb-4 text-blue-300">${material.name} Parameters</h3>
                    <div class="param-grid-container">
                        <div class="param-ruler">     |    |         |         |         |         |         |         |\n1    5    10        20        30        40        50        60        70</div>
                        <div class="param-row-labels">
                            <span class="param-label w-5ch" title="MT (Material type)">MT</span>
                            <span class="param-label w-5ch" title="MN (Material number)">MN</span>
                            <span class="param-label w-10ch" title="Rf (Ratio of critical principle stresses)">Rf</span>
                            <span class="param-label w-10ch" title="ν (Poisson's ratio)">ν</span>
                            <span class="param-label w-10ch" title="ρ (Density)">ρ</span>
                            <span class="param-label w-10ch" title="K0 (Static earth pressure coefficient)">K0</span>
                            <span class="param-label w-10ch" title="e0 (Initial void ratio)">e0</span>
                            <span class="param-label w-10ch" title="bl (Anisotropy)">bl</span>
                        </div>
                        <div class="param-row-inputs">
                            ${material.values[0].map((v, i) => `
                                <div class="param-input-wrapper ${[0,1].includes(i) ? 'w-5ch' : 'w-10ch'}">
                                    <input type="number" 
                                           ${[2,3,4,5,6,7].includes(i) ? 'step="any"' : ''} 
                                           class="param-input" 
                                           maxlength="${[0,1].includes(i) ? '5' : '10'}" 
                                           data-material-id="${material.id}" 
                                           data-row="0" 
                                           data-col="${i}" 
                                           value="${v || ''}">
                                </div>
                            `).join('')}
                        </div>
                        <div class="param-row-labels">
                            <span class="param-spacer w-10ch"></span>
                            <span class="param-label w-10ch" title="λ (Consolidation index)">λ</span>
                            <span class="param-label w-10ch" title="κ (Expansion index)">κ</span>
                            <span class="param-label w-10ch" title="h1 (Attenuation index for mass)">h1</span>
                            <span class="param-label w-10ch" title="h2 (Attenuation index for stiffness)">h2</span>
                            <span class="param-label w-10ch" title="k (Permeability coefficient)">k</span>
                            <span class="param-label w-10ch" title="Kf (Volume elasticity of water)">Kf</span>
                        </div>
                        <div class="param-row-inputs">
                            <span class="param-spacer w-10ch"></span>
                            ${material.values[1].map((v, i) => `
                                <div class="param-input-wrapper w-10ch">
                                    <input type="number" 
                                           step="any" 
                                           class="param-input" 
                                           maxlength="10" 
                                           data-material-id="${material.id}" 
                                           data-row="1" 
                                           data-col="${i}" 
                                           value="${v || ''}">
                                </div>
                            `).join('')}
                        </div>
                        <div class="param-row-labels">
                            <span class="param-spacer w-10ch"></span>
                            <span class="param-label w-10ch" title="ZM (Overconsolidation index)">ZM</span>
                            <span class="param-label w-10ch" title="-OCR (Overconsolidation ratio)">-OCR</span>
                            <span class="param-label w-10ch" title="ZMS (Structure index)">ZMS</span>
                            <span class="param-label w-10ch" title="R*0 (Initial structural ratio)">R*0</span>
                            <span class="param-label w-10ch" title="br (Anisotropy index)">br</span>
                            <span class="param-label w-10ch" title="ξ0 (Initial anisotropy)">ξ0</span>
                        </div>
                        <div class="param-row-inputs">
                            <span class="param-spacer w-10ch"></span>
                            ${material.values[2].map((v, i) => `
                                <div class="param-input-wrapper w-10ch">
                                    <input type="number" 
                                           step="any" 
                                           class="param-input" 
                                           maxlength="10" 
                                           data-material-id="${material.id}" 
                                           data-row="2" 
                                           data-col="${i}" 
                                           value="${v || ''}">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                section.querySelectorAll('.param-input').forEach(input => {
                    input.addEventListener('input', handleCmInputChange);
                });
                
                return section;
            }

            function handleCmInputChange(event) {
                const { materialId, row, col } = event.target.dataset;
                const value = event.target.value;
                
                const mat = globalState.interfaces.cmParams.materials.find(m => m.id === parseInt(materialId));
                if (mat?.values[row]?.[col] !== undefined) {
                    mat.values[row][col] = value;
                }
            }

            function switchCmMaterialTab(event) {
                const newId = parseInt(event.target.closest('button').dataset.id);
                if (newId !== globalState.interfaces.cmParams.activeMaterialId) {
                    globalState.interfaces.cmParams.activeMaterialId = newId;
                    renderCmParamsInterface();
                    
                    // Clear output when switching materials
                    const outputEl = document.getElementById('concatenated-output');
                    if (outputEl) outputEl.value = '';
                }
            }

            function addCmMaterial() {
                const state = globalState.interfaces.cmParams;
                const newId = state.nextMaterialId++;
                
                state.materials.push({
                    id: newId,
                    name: `Material ${newId}`,
                    values: [
                        Array(8).fill(''),
                        Array(6).fill(''),
                        Array(6).fill('')
                    ]
                });
                
                state.activeMaterialId = newId;
                renderCmParamsInterface();
            }

            function deleteCmMaterial(materialId) {
                const state = globalState.interfaces.cmParams;
                
                if (state.materials.length <= 1) {
                    showToast("Cannot delete last material.", "error");
                    return;
                }
                
                // NOTE: Replaced confirm() with direct deletion for iframe compatibility
                // if (confirm(`Are you sure you want to delete this material?`)) {
                    const index = state.materials.findIndex(m => m.id === materialId);
                    if (index === -1) return;
                    
                    const name = state.materials[index].name;
                    state.materials.splice(index, 1);
                    
                    if (state.activeMaterialId === materialId) {
                        state.activeMaterialId = state.materials[0].id;
                    }
                    
                    renderCmParamsInterface();
                    showToast(`Deleted "${name}".`, "success");
                // }
            }

            function generateCmParamsConcatenatedLine() {
                const { materials } = globalState.interfaces.cmParams;
                const outputEl = document.getElementById('concatenated-output');
                
                if (!outputEl) {
                    showToast("Error finding output area.", "error");
                    return;
                }
                
                // Define field lengths for each row
                const lengths = [
                    [5, 5, 10, 10, 10, 10, 10, 10],  // Row 1
                    [10, 10, 10, 10, 10, 10],       // Row 2
                    [10, 10, 10, 10, 10, 10]        // Row 3
                ];
                
                // Padding function
                const pad = (val, len, el) => {
                    const str = (val || "").toString();
                    
                    // Truncate if too long and highlight error
                    if (str.length > len) {
                        if (el) el.classList.add('border-red-500', 'shadow-outline-red');
                        return str.substring(str.length - len);
                    }
                    
                    // Remove error highlighting if corrected
                    if (el) el.classList.remove('border-red-500', 'shadow-outline-red');
                    
                    // Pad with leading spaces
                    return str.padStart(len, ' ');
                };
                
                // Generate lines for all materials
                const allLines = materials.flatMap(m => {
                    const section = document.getElementById(`cm-material-section-${m.id}`);
                    
                    // Map each row of values to a formatted line
                    return m.values.map((rowVals, rIdx) => {
                        // Add indentation for rows 2 and 3
                        const prefix = rIdx > 0 ? " ".repeat(10) : "";
                        
                        // Format each value in the row
                        const paddedVals = rowVals.map((v, cIdx) => {
                            const inputEl = section?.querySelector(`input[data-row="${rIdx}"][data-col="${cIdx}"]`);
                            return pad(v, lengths[rIdx][cIdx], inputEl);
                        });
                        
                        // Join values and prepend indentation
                        return prefix + paddedVals.join('');
                    });
                });
                
                // Update output textarea
                outputEl.value = allLines.join('\n');
                showToast(`Generated lines for ${materials.length} material(s).`, "success");
            }

            function copyOutputToClipboard() {
                const outputEl = document.getElementById('concatenated-output');
                if (!outputEl) {
                    showToast("Error finding output area.", "error");
                    return;
                }
                
                const textToCopy = outputEl.value;
                
                if (!textToCopy) {
                    showToast("Nothing to copy.", "warning");
                    return;
                }
    
                // Use document.execCommand('copy') for iframe compatibility
                try {
                    // Temporarily remove 'readonly' to allow selection
                    outputEl.readOnly = false;
                    
                    outputEl.select();
                    outputEl.setSelectionRange(0, 99999); // For mobile devices
    
                    // Execute copy command
                    const successful = document.execCommand('copy');
                    
                    // Restore 'readonly'
                    outputEl.readOnly = true;
    
                    // Deselect text
                    if (window.getSelection) {
                        window.getSelection().removeAllRanges();
                    } else if (document.selection) {
                        document.selection.empty();
                    }
    
                    if (successful) {
                        showToast("Copied to clipboard!", "success");
                    } else {
                        showToast("Failed to copy. Please copy manually.", "error");
                    }
                } catch (err) {
                    // Restore 'readonly' in case of error
                    outputEl.readOnly = true;
                    console.error("Copy failed: ", err);
                    showToast("Failed to copy. Please copy manually.", "error");
                }
            }
            
            // --- END: PHASE 3 SCRIPT ---


            // --- START: PHASE 4 (MODEL CONFIG) SCRIPT ---
            
            /**
             * Renamed from initialize() to avoid conflicts
             */
            function initializePhase4() {
                const interfaceKey = 'modelConfig';

                renderInspectPanel(interfaceKey);
                renderTabs(interfaceKey); 
                renderActiveFormatTabContent(interfaceKey);

                attachModelConfigListeners(interfaceKey);
            }

            /**
             * Attaches event listeners for MODEL CONFIGURATION interface
             */
            function attachModelConfigListeners(interfaceKey) {
                document.getElementById(`file-upload-${interfaceKey}`)?.addEventListener('change', (e) => handleFileUpload(e, interfaceKey));
                document.getElementById(`clear-data-btn-${interfaceKey}`)?.addEventListener('click', () => clearData(interfaceKey));
                document.getElementById(`parse-btn-${interfaceKey}`)?.addEventListener('click', () => parseData(interfaceKey));
                document.getElementById(`add-tab-btn-${interfaceKey}`)?.addEventListener('click', () => addNewFormatTab(interfaceKey));
            }
            
            // --- START: Format Tab Management (Step 3 Tabs) ---

            /**
             * Renders the navigation tabs for the Format Builder (Step 3).
             */
            function renderTabs(interfaceKey) {
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                const nav = document.getElementById(`format-tabs-nav-${interfaceKey}`);
                if (!nav) return;
                
                nav.innerHTML = "";
                state.formats.forEach(format => {
                    const btn = document.createElement('button');
                    btn.className = `tab-btn py-2 px-4 text-sm font-medium ${state.activeFormatId === format.id ? 'active' : 'text-gray-400 hover:text-gray-300'}`;
                    btn.textContent = format.name;
                    btn.dataset.id = format.id;
                    btn.addEventListener('click', (e) => switchFormatTab(interfaceKey, e));
                    
                    const span = document.createElement('span');
                    span.innerHTML = "&nbsp;&nbsp;&times;";
                    span.className = "text-red-500 hover:text-red-400 font-bold";
                    span.title = "Delete tab";
                    span.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteFormatTab(interfaceKey, format.id);
                    });
                    
                    btn.addEventListener('dblclick', (e) => renameFormatTab(interfaceKey, e));
                    btn.appendChild(span);
                    nav.appendChild(btn);
                });
            }

            /**
             * Renders the content (buttons, grid, preview) for the active format tab.
             */
            function renderActiveFormatTabContent(interfaceKey) {
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                const content = document.getElementById(`format-tabs-content-${interfaceKey}`);
                if (!content) return;
                
                const format = state.formats.find(f => f.id === state.activeFormatId);
                if (!format) {
                    content.innerHTML = "<p class='text-red-400 p-4'>Error: No active format found.</p>";
                    return;
                }
                
                const formatId = format.id;
                
                // Build options for base table selectors
                let baseTableOptions = '<option value="">-- Select --</option>';
                Object.values(state.tableSchemas).forEach(schema => {
                    const dataCount = state.tables[schema.key]?.length || 0;
                    baseTableOptions += `<option value="${schema.key}">${schema.name} (${dataCount} rows)</option>`;
                });
                
                content.innerHTML = `
                    <div class="bg-gray-800 p-4 rounded-lg shadow-inner border border-gray-700">
                        <!-- Base Table Selection -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="primary-base-select-${formatId}-${interfaceKey}" class="block text-sm font-medium text-gray-300 mb-1">Primary Base Table</label>
                                <select id="primary-base-select-${formatId}-${interfaceKey}" class="config-select w-full">${baseTableOptions}</select>
                            </div>
                            <div>
                                <label for="secondary-base-select-${formatId}-${interfaceKey}" class="block text-sm font-medium text-gray-300 mb-1">Secondary Base Table <span class="text-xs text-gray-500">(Optional)</span></label>
                                <select id="secondary-base-select-${formatId}-${interfaceKey}" class="config-select w-full">${baseTableOptions}</select>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-2 mb-4 border-b pb-4 border-gray-700">
                            <button id="import-cols-btn-${formatId}-${interfaceKey}" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition">Import Selected Columns</button>
                            <button id="add-calc-col-btn-${formatId}-${interfaceKey}" class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-teal-700 transition">Add Calculated Column</button>
                            <button id="add-uniform-col-btn-${formatId}-${interfaceKey}" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">Add Uniform Column</button>
                        </div>
                        
                        <!-- Format Grid -->
                        <div id="grid-container-${formatId}-${interfaceKey}" class="data-grid-container mb-4">
                            <table class="data-grid">
                                <thead id="grid-head-${formatId}-${interfaceKey}"></thead>
                                <tbody id="grid-body-${formatId}-${interfaceKey}"></tbody>
                            </table>
                            <div id="grid-placeholder-${formatId}-${interfaceKey}" class="p-4 text-center text-gray-400 italic"></div>
                        </div>

                        <!-- Preview -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-gray-200">Preview Output</h3>
                            <textarea id="preview-output-${formatId}-${interfaceKey}" class="w-full h-64 p-3 border border-gray-600 rounded-lg font-mono text-sm shadow-inner bg-gray-900 text-gray-200" readonly placeholder="Preview will appear here..."></textarea>
                            <button id="copy-preview-btn-${formatId}-${interfaceKey}" class="mt-2 bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-600 transition">Copy to Clipboard</button>
                        </div>
                    </div>
                `;

                // Set selected values for dropdowns
                const primarySelect = document.getElementById(`primary-base-select-${formatId}-${interfaceKey}`);
                const secondarySelect = document.getElementById(`secondary-base-select-${formatId}-${interfaceKey}`);
                if (primarySelect) primarySelect.value = format.primaryBaseTable || "";
                if (secondarySelect) secondarySelect.value = format.secondaryBaseTable || "";

                // Attach listeners
                primarySelect?.addEventListener('change', (e) => {
                    format.primaryBaseTable = e.target.value || null;
                    renderFormatGrid(interfaceKey, format);
                });
                secondarySelect?.addEventListener('change', (e) => {
                    format.secondaryBaseTable = e.target.value || null;
                    renderFormatGrid(interfaceKey, format);
                });
                
                document.getElementById(`import-cols-btn-${formatId}-${interfaceKey}`)?.addEventListener('click', () => importSelectedColumns(interfaceKey, formatId));
                document.getElementById(`add-calc-col-btn-${formatId}-${interfaceKey}`)?.addEventListener('click', () => addCalculatedColumn(interfaceKey, formatId));
                document.getElementById(`add-uniform-col-btn-${formatId}-${interfaceKey}`)?.addEventListener('click', () => addUniformColumn(interfaceKey, formatId));

                document.getElementById(`copy-preview-btn-${formatId}-${interfaceKey}`)?.addEventListener('click', () => {
                    const preview = document.getElementById(`preview-output-${formatId}-${interfaceKey}`);
                    if (preview && preview.value) {
                        preview.select();
                        try {
                            // Using execCommand as clipboard API may fail in sandboxed iframes
                            document.execCommand('copy');
                            showToast("Copied to clipboard!", "success");
                        } catch (err) {
                            showToast("Failed to copy.", "error");
                        }
                    }
                });

                // Initial render of the grid
                renderFormatGrid(interfaceKey, format);
            }

            function addNewFormatTab(interfaceKey, defaults = {}) { 
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey]; 
                const newId = state.nextFormatId++; 
                const newFormat = { 
                    id: newId, 
                    name: defaults.name || `Format ${newId}`, 
                    primaryBaseTable: defaults.primaryBaseTable || null, 
                    secondaryBaseTable: defaults.secondaryBaseTable || null, 
                    columns: [], 
                    editedData: {} 
                }; 
                state.formats.push(newFormat); 
                state.activeFormatId = newId; 
                renderTabs(interfaceKey); 
                renderActiveFormatTabContent(interfaceKey); 
            }
            
            function switchFormatTab(interfaceKey, event) { 
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey]; 
                const newId = parseInt(event.target.dataset.id, 10); 
                if (newId !== state.activeFormatId) { 
                    state.activeFormatId = newId; 
                    renderTabs(interfaceKey); 
                    renderActiveFormatTabContent(interfaceKey); 
                } 
            }
            
            function renameFormatTab(interfaceKey, event) { 
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey]; 
                const tabId = parseInt(event.target.dataset.id, 10); 
                const format = state.formats.find(f => f.id === tabId); 
                if (!format) return; 
                const newName = prompt("Enter new name:", format.name); 
                if (newName && newName.trim() !== "") { 
                    format.name = newName.trim(); 
                    renderTabs(interfaceKey); 
                } 
            }
            
            function deleteFormatTab(interfaceKey, tabId) { 
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey]; 
                if (state.formats.length <= 1) { 
                    showToast("Cannot delete last tab.", "error"); 
                    return; 
                } 
                if (confirm(`Delete "${state.formats.find(f => f.id === tabId).name}"?`)) { 
                    state.formats = state.formats.filter(f => f.id !== tabId); 
                    if (state.activeFormatId === tabId) { 
                        state.activeFormatId = state.formats[0].id; 
                    } 
                    renderTabs(interfaceKey); 
                    renderActiveFormatTabContent(interfaceKey); 
                } 
            }
            
            // --- END: Format Tab Management ---
            
            function handleFileUpload(event, interfaceKey) { 
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey]; 
                const s2kInput = document.getElementById(`s2k-input-${interfaceKey}`); 
                const file = event.target.files[0]; 
                if (file) { 
                    const reader = new FileReader(); 
                    reader.onload = (e) => { 
                        s2kInput.value = e.target.result; 
                        state.rawData = e.target.result; 
                    }; 
                    reader.readAsText(file); 
                } 
            }
            
            function clearData(interfaceKey) { 
                if (interfaceKey !== 'modelConfig') return;
                // Reset state to initial
                globalState.interfaces.modelConfig = createModelConfigState();
                const state = globalState.interfaces[interfaceKey]; 
                
                document.getElementById(`s2k-input-${interfaceKey}`).value = ""; 
                
                renderInspectPanel(interfaceKey); 
                renderTabs(interfaceKey);
                renderActiveFormatTabContent(interfaceKey); 
            }
            
            function resetParsedData(interfaceKey) { 
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey]; 
                state.tables = { jointCoordinates: [], connectivitySolid: [], jointRestraints: [], solidProperties: [] }; 
                state.editedSourceData = {}; 
                state.sourceColumnSelections = {}; 
                state.sourceSubstitutions = {}; 
                state.convertedSourceData = {}; 
            }
            
            function parseData(interfaceKey) { 
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey]; 
                state.rawData = document.getElementById(`s2k-input-${interfaceKey}`).value; 
                if (!state.rawData.trim()) { showToast("No data to parse.", "error"); return; } 
                state.delimiters = []; 
                document.querySelectorAll(`#delimiter-options-${interfaceKey} input[type="checkbox"]:checked`).forEach(cb => state.delimiters.push(cb.value)); 
                if (state.delimiters.length === 0) { showToast("Select delimiter(s).", "error"); return; } 
                const escapedDelimiters = state.delimiters.map(d => d.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')); 
                const regex = new RegExp(`[${escapedDelimiters.join('')}]+`); 
                resetParsedData(interfaceKey); 
                const lines = state.rawData.split('\n'); 
                let currentTableKey = null; 
                let dataLinesFound = 0; 
                for (const line of lines) { 
                    const trimmedLine = line.trim().toUpperCase(); 
                    if (trimmedLine.length === 0) continue; 
                    let foundHeader = false; 
                    for (const key in state.tableSchemas) { 
                        if (trimmedLine.includes(state.tableSchemas[key].name)) { 
                            currentTableKey = key; 
                            foundHeader = true; 
                            break; 
                        } 
                    } 
                    if (foundHeader) continue; 
                    if (currentTableKey) { 
                        // Check if line looks like a data line
                        if (line.trim().match(/^[A-Z0-9"'-]/i)) { 
                            state.tables[currentTableKey].push(line.split(regex).map(cell => cell.trim())); 
                            dataLinesFound++; 
                        } else { 
                            // If line doesn't look like data, stop capturing for this table
                            currentTableKey = null; 
                        } 
                    } 
                } 
                showToast(dataLinesFound === 0 ? "Parse complete, no S2K data found." : `Parse complete. Found ${dataLinesFound} lines.`, dataLinesFound === 0 ? "warning" : "success"); 
                state.formats.forEach(f => f.editedData = {}); 
                
                selectAllDBLeavesColumns(interfaceKey); 
                
                // --- MODIFICATION: Automate Yes/No conversion on parse ---
                autoConvertYesNo(interfaceKey, true); // Pass silent=true
                
                autoPopulateFormatColumns(interfaceKey);
                
                renderInspectPanel(interfaceKey); 
                renderActiveFormatTabContent(interfaceKey); 
            }
            
            function getColumnIndex(schema, colName) { let colIndex = schema.headers.indexOf(colName); if (colIndex === -1 && colName.startsWith('Col')) { const index = parseInt(colName.substring(3), 10) - 1; if (!isNaN(index) && index >= 0) colIndex = index; } return colIndex; }
            
            function selectAllDBLeavesColumns(interfaceKey) { 
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey]; 
                let totalSelectedCount = 0; 
                Object.keys(state.tableSchemas).forEach(tableKey => { 
                    totalSelectedCount += selectDBLeavesColumns(interfaceKey, tableKey); 
                }); 
                if (totalSelectedCount > 0) {
                    showToast(`Auto-selected ${totalSelectedCount} DBLEAVES columns.`, "success"); 
                }
            }
            
            function selectDBLeavesColumns(interfaceKey, tableKey) { 
                if (interfaceKey !== 'modelConfig') return 0;
                const state = globalState.interfaces[interfaceKey]; 
                const schema = state.tableSchemas[tableKey]; 
                if (!schema) return 0; 
                const dbLeavesSelections = { 
                    jointCoordinates: ['Y', 'Col9', 'Col11', 'Col13'], 
                    connectivitySolid: ['J2', 'J4', 'J6', 'J8', 'Col11', 'Col13', 'Col15', 'Col17', 'Col19'], 
                    jointRestraints: ['RX', 'RZ', 'Col9', 'Col11', 'Col13', 'Col15'], 
                    solidProperties: ['Col5'] 
                }; 
                const columnsToSelect = dbLeavesSelections[tableKey]; 
                if (!columnsToSelect) return 0; 
                let selectedCount = 0; 
                columnsToSelect.forEach(item => { 
                    const colIndex = getColumnIndex(schema, item); 
                    if (colIndex !== -1) { 
                        state.sourceColumnSelections[`${tableKey}_${colIndex}`] = true; 
                        selectedCount++; 
                    } 
                }); 
                return selectedCount; 
            }

            /**
             * Automatically imports selected columns into their respective default formats.
             */
            function autoPopulateFormatColumns(interfaceKey) {
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                
                state.formats.forEach(format => {
                    // Only auto-populate if the grid is empty
                    if (format.columns.length === 0) {
                        // Temporarily set activeFormatId to this format to pass checks
                        const originalActiveId = state.activeFormatId;
                        state.activeFormatId = format.id;
                        
                        importSelectedColumns(interfaceKey, format.id, true); // Pass 'true' for silent mode
                        
                        // Restore activeFormatId
                        state.activeFormatId = originalActiveId;
                    }
                });
            }
            
            /**
             * This function now stores the original value before converting.
             * Added silent flag to suppress toast on initial parse.
             */
            function autoConvertYesNo(interfaceKey, silent = false) {
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                const tableKey = 'jointRestraints';
                const data = state.tables[tableKey];
                if (!data || data.length === 0) {
                    if (!silent) showToast("No Joint Restraint data to convert.", "info");
                    return;
                }
                
                let conversionCount = 0;
                // --- FIX: Use defined RESTRAINT_COL_INDICES ---
                const RESTRAINT_COL_INDICES = [4, 6, 8, 10, 12, 14]; // RX, RZ, Col9, Col11, Col13, Col15

                data.forEach((row, rowIndex) => {
                    RESTRAINT_COL_INDICES.forEach(colIndex => {
                        const cellKey = `${tableKey}_${rowIndex}_${colIndex}`;
                        
                        // If cell is already manually edited or converted, skip.
                        if (state.editedSourceData[cellKey] !== undefined || state.convertedSourceData[cellKey] !== undefined) {
                            return; // skip this cell
                        }
                        
                        const originalValue = state.tables[tableKey]?.[rowIndex]?.[colIndex] ?? "";
                        const lowerCurrentValue = originalValue.toLowerCase().trim();
                        
                        let newValue = null;
                        if (lowerCurrentValue === 'yes') { newValue = '1'; } 
                        else if (lowerCurrentValue === 'no') { newValue = '0'; }
                        
                        if (newValue !== null) {
                            // Store the conversion
                            state.convertedSourceData[cellKey] = { original: originalValue, converted: newValue };
                            conversionCount++;
                        }
                    });
                });

                if (conversionCount > 0) {
                    if (!silent) {
                        showToast(`Converted ${conversionCount} 'Yes'/'No' values.`, "success");
                        renderInspectPanel(interfaceKey); // Re-render to show new styles
                        renderActiveFormatTabContent(interfaceKey); // Re-render to update downstream
                    }
                } else {
                    if (!silent) showToast("No new 'Yes'/'No' values found to convert.", "info");
                }
            }

            /**
             * Restores original "Yes"/"No" values
             */
            function restoreOriginalYesNo(interfaceKey) {
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                
                const restoreCount = Object.keys(state.convertedSourceData).length;
                if (restoreCount === 0) {
                    showToast("No values to restore.", "info");
                    return;
                }
                
                state.convertedSourceData = {};
                showToast(`Restored ${restoreCount} original values.`, "success");
                
                renderInspectPanel(interfaceKey); // Re-render to show original values
                renderActiveFormatTabContent(interfaceKey); // Re-render to update downstream
            }


            // --- START: Inspect Panel (Step 2) Rendering ---

            function renderInspectPanel(interfaceKey) { 
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey]; 
                const nav = document.getElementById(`inspect-tabs-nav-${interfaceKey}`); 
                const content = document.getElementById(`inspect-tabs-content-${interfaceKey}`); 
                if (!nav || !content) return; 
                nav.innerHTML = ""; 
                const keys = Object.keys(state.tableSchemas); 
                if (!keys.includes(state.activeInspectTab)) { 
                    state.activeInspectTab = keys[0] || 'jointCoordinates'; 
                } 
                Object.values(state.tableSchemas).forEach(schema => { 
                    const btn = document.createElement('button'); 
                    btn.className = `inspect-tab-btn py-2 px-4 text-sm font-medium ${state.activeInspectTab === schema.key ? 'active' : ''}`; 
                    btn.textContent = schema.name; 
                    btn.dataset.key = schema.key; 
                    nav.appendChild(btn); 
                }); 
                nav.querySelectorAll('.inspect-tab-btn').forEach(btn => btn.addEventListener('click', (e) => { 
                    state.activeInspectTab = e.target.dataset.key; 
                    renderInspectPanel(interfaceKey); 
                })); 
                content.innerHTML = ""; 
                const pane = document.createElement('div'); 
                pane.className = 'inspect-tab-pane p-4 border border-gray-700 border-t-0 rounded-b-lg rounded-tr-lg'; 
                
                if (state.activeInspectTab === 'jointRestraints') { 
                    const convertBtn = document.createElement('button');
                   convertBtn.id = `auto-convert-btn-${interfaceKey}`;
                   convertBtn.className = 'bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-teal-700 transition mb-4';
                   convertBtn.innerHTML = `
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                         <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1.12-10.32a.75.75 0 00-1.24 0l-2.5 4.5a.75.75 0 001.24.69L9 12.18V14.5a.75.75 0 001.5 0v-2.32l.38.68a.75.75 0 001.24-.69l-2.5-4.5z" clip-rule="evenodd" />
                       </svg>
                       Auto Convert Yes/No
                   `;
                   convertBtn.addEventListener('click', () => autoConvertYesNo(interfaceKey));

                   const restoreBtn = document.createElement('button');
                   restoreBtn.id = `restore-original-btn-${interfaceKey}`;
                   restoreBtn.className = 'bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-500 transition mb-4 ml-2';
                   restoreBtn.innerHTML = `
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1" viewBox="0 0 20 20" fill="currentColor">
                         <path fill-rule="evenodd" d="M15.323 11.223a.75.75 0 010 1.06l-4.5 4.5a.75.75 0 01-1.06-1.06l3.248-3.248H6.75a.75.75 0 010-1.5h6.26l-3.248-3.248a.75.75 0 011.06-1.06l4.5 4.5zM4.75 4.25a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5z" clip-rule="evenodd" />
                       </svg>
                       Restore Original
                   `;
                   restoreBtn.addEventListener('click', () => restoreOriginalYesNo(interfaceKey));

                   pane.appendChild(convertBtn);
                   pane.appendChild(restoreBtn);
                } 
                
                pane.appendChild(createSourceGridContent(interfaceKey, state.activeInspectTab)); 
                content.appendChild(pane); 
            }
            
            /**
             * Creates the data grid for the "Inspect" panel.
             */
            function createSourceGridContent(interfaceKey, tableKey) { 
                if (interfaceKey !== 'modelConfig') return document.createTextNode("Error: Invalid interface key.");
                const state = globalState.interfaces[interfaceKey]; 
                const schema = state.tableSchemas[tableKey]; 
                const data = state.tables[tableKey]; 
                if (!schema) return document.createTextNode("Invalid schema."); 
                if (!data || data.length === 0) { 
                    const msg = document.createElement('p'); 
                    msg.className = 'text-gray-400 italic p-4'; 
                    msg.textContent = 'No data parsed.'; 
                    return msg; 
                } 
                const container = document.createElement('div'); 
                container.className = 'data-grid-container'; 
                const table = document.createElement('table'); 
                table.className = 'data-grid'; 
                const thead = document.createElement('thead'); 
                const trHead = document.createElement('tr'); 
                const maxCols = Math.max(schema.headers.length, ...data.map(row => row?.length ?? 0)); 
                
                // thead loop
                for (let i = 0; i < maxCols; i++) { 
                    const th = document.createElement('th'); 
                    th.className = 'source-grid-header'; 
                    const colKey = `${tableKey}_${i}`; 
                    const isSelected = !!state.sourceColumnSelections[colKey]; 
                    
                    if (isSelected) th.classList.add('selected');
                    
                    const headerContent = document.createElement('div'); 
                    headerContent.className = 'source-header-content'; 
                    const checkbox = document.createElement('input'); 
                    checkbox.type = 'checkbox'; 
                    checkbox.className = 'form-checkbox text-blue-500 rounded'; 
                    checkbox.checked = isSelected; 
                    checkbox.dataset.key = colKey; 
                    checkbox.addEventListener('change', (e) => { 
                        const key = e.target.dataset.key; 
                        state.sourceColumnSelections[key] = e.target.checked; 
                        th.classList.toggle('selected', e.target.checked);
                    }); 
                    const title = document.createElement('span'); 
                    title.textContent = schema.headers[i] || `Col ${i + 1}`; 
                    headerContent.appendChild(checkbox); 
                    headerContent.appendChild(title); 
                    const subContainer = document.createElement('div'); 
                    subContainer.className = 'mt-2 space-y-1'; 
                    (state.sourceSubstitutions[colKey] || []).forEach(sub => subContainer.appendChild(createSubRow(interfaceKey, colKey, sub.id, sub.find, sub.replace))); 
                    const addSubBtn = document.createElement('button'); 
                    addSubBtn.textContent = '+ Add Sub'; 
                    addSubBtn.className = 'text-blue-400 hover:text-blue-300 text-xs font-medium mt-1'; 
                    addSubBtn.dataset.key = colKey; 
                    addSubBtn.addEventListener('click', (e) => { 
                        const key = e.target.dataset.key; 
                        const newId = Date.now(); 
                        state.sourceSubstitutions[key] = state.sourceSubstitutions[key] || []; 
                        state.sourceSubstitutions[key].push({ id: newId, find: "", replace: "" }); 
                        e.target.previousElementSibling.appendChild(createSubRow(interfaceKey, key, newId, "", "")); 
                    }); 
                    th.appendChild(headerContent); 
                    th.appendChild(subContainer); 
                    th.appendChild(addSubBtn); 
                    trHead.appendChild(th); 
                } 
                thead.appendChild(trHead); 
                table.appendChild(thead); 
                
                // tbody loop
                const tbody = document.createElement('tbody'); 
                data.forEach((row, rowIndex) => { 
                    const tr = document.createElement('tr'); 
                    for (let i = 0; i < maxCols; i++) { 
                        const td = document.createElement('td'); 
                        const cellKey = `${tableKey}_${rowIndex}_${i}`; 
                        const originalValue = row?.[i] ?? ""; 
                        const editedValue = state.editedSourceData[cellKey]; 
                        
                        const conversion = state.convertedSourceData[cellKey];
                        const currentValue = editedValue ?? conversion?.converted ?? originalValue;

                        td.textContent = currentValue;
                        td.contentEditable = "true"; 
                        td.addEventListener('blur', (e) => handleSourceCellEdit(e, interfaceKey, tableKey, rowIndex, i)); 

                        // Styling precedence
                        if (editedValue !== undefined) { 
                            td.style.backgroundColor = '#422006'; // dark-yellow
                            td.style.fontStyle = 'italic'; 
                        } else if (conversion !== undefined) {
                            td.style.backgroundColor = '#1e3a8a'; // dark-blue
                            td.style.fontStyle = 'italic';
                            td.title = `Converted from "${conversion.original}"`;
                        }
                        tr.appendChild(td); 
                    } 
                    tbody.appendChild(tr); 
                }); 
                table.appendChild(tbody); 
                container.appendChild(table); 
                return container; 
            }
            
            /**
             * Creates a UI row for a Find/Replace substitution.
             */
            function createSubRow(interfaceKey, colKey, subId, findVal, replaceVal) {
                const state = globalState.interfaces[interfaceKey];
                const subRow = document.createElement('div');
                subRow.className = 'sub-row';
                
                const findInput = document.createElement('input');
                findInput.type = 'text';
                findInput.className = 'config-input';
                findInput.placeholder = 'Find';
                findInput.value = findVal;
                findInput.addEventListener('change', (e) => {
                    const sub = state.sourceSubstitutions[colKey].find(s => s.id === subId);
                    if (sub) sub.find = e.target.value;
                });
                
                const arrow = document.createElement('span');
                arrow.textContent = '→';
                
                const replaceInput = document.createElement('input');
                replaceInput.type = 'text';
                replaceInput.className = 'config-input';
                replaceInput.placeholder = 'Replace';
                replaceInput.value = replaceVal;
                replaceInput.addEventListener('change', (e) => {
                    const sub = state.sourceSubstitutions[colKey].find(s => s.id === subId);
                    if (sub) sub.replace = e.target.value;
                });
                
                const removeBtn = document.createElement('span');
                removeBtn.className = 'sub-remove-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.title = 'Remove Substitution';
                removeBtn.addEventListener('click', () => {
                    state.sourceSubstitutions[colKey] = state.sourceSubstitutions[colKey].filter(s => s.id !== subId);
                    subRow.remove();
                });
                
                subRow.appendChild(findInput);
                subRow.appendChild(arrow);
                subRow.appendChild(replaceInput);
                subRow.appendChild(removeBtn);
                
                return subRow;
            }
            
            function handleSourceCellEdit(event, interfaceKey, tableKey, rowIndex, colIndex) {
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                
                if (!state.tables || !state.tables[tableKey] || !state.tables[tableKey][rowIndex]) {
                     event.target.textContent = '';
                     showToast("Parse S2K data before editing.", "warning");
                     return; 
                }
                
                const cellKey = `${tableKey}_${rowIndex}_${colIndex}`;
                let newValue = event.target.textContent.trim();
                const originalValue = state.tables[tableKey]?.[rowIndex]?.[colIndex] ?? ""; 
                
                // If this cell was previously converted, remove the conversion.
                // The manual edit now takes precedence.
                if (state.convertedSourceData[cellKey] !== undefined) {
                    delete state.convertedSourceData[cellKey];
                }

                event.target.classList.remove('invalid');
                event.target.textContent = newValue; 

                if (newValue === originalValue) {
                    delete state.editedSourceData[cellKey];
                    event.target.style.backgroundColor = '';
                    event.target.style.fontStyle = '';
                } else {
                    state.editedSourceData[cellKey] = newValue;
                    event.target.style.backgroundColor = '#422006'; // dark-yellow
                    event.target.style.fontStyle = 'italic';
                }
                
                // Selectively update only the affected row in the active format grid and the preview.
                const format = state.formats.find(f => f.id === state.activeFormatId);
                if (format) {
                    updateAffectedFormatCells(interfaceKey, tableKey, rowIndex, colIndex, format);
                    updatePreview(interfaceKey, format.id);
                }
            }
            
            // --- END: Inspect Panel (Step 2) Rendering ---

            // --- START: Format Builder (Step 3) Core Logic ---

            /**
             * Selectively updates a single row in the format grid
             * when a dependent cell in the source grid (Step 2) is edited.
             */
            function updateAffectedFormatCells(interfaceKey, tableKey, rowIndex, colIndex, format) {
                const state = globalState.interfaces[interfaceKey];
                const gridBody = document.getElementById(`grid-body-${format.id}-${interfaceKey}`);
                if (!gridBody || !gridBody.rows[rowIndex]) return;
                
                const row = gridBody.rows[rowIndex];
                const primaryRef = (format.primaryBaseTable === tableKey) ? 'primary' : null;
                const secondaryRef = (format.secondaryBaseTable === tableKey) ? 'secondary' : null;

                format.columns.forEach((col, cIdx) => {
                    let isAffected = false;

                    // Check if a source column is affected
                    if (col.type === 'source' && col.source.table === tableKey && col.source.colIndex == colIndex) {
                        isAffected = true;
                    }
                    // Check if a calculated column is affected
                    else if (col.type === 'calculated' && col.calcRefCol) {
                        const [refType, refIdx] = col.calcRefCol.split('_');
                        if (refType === primaryRef && refIdx == colIndex) {
                            isAffected = true;
                        } else if (refType === secondaryRef && refIdx == colIndex) {
                            isAffected = true;
                        }
                    }

                    // If this column depends on the edited cell, re-render it
                    if (isAffected) {
                        const td = row.cells[cIdx];
                        const val = getGridCellValue(col, format, rowIndex, cIdx, interfaceKey);
                        const { formattedValue, error } = applyFormat(val, col.format);
                        
                        td.textContent = formattedValue;
                        styleFormatCell(td, col, rowIndex, cIdx, interfaceKey, format, error);
                    }
                });
            }


            /**
             * Centralizes cell styling for the format grid.
             * Applies styles for invalid/error states, Step 3 overrides, and Step 2 edits.
             */
            function styleFormatCell(td, col, rIdx, cIdx, interfaceKey, format, validationError) {
                const state = globalState.interfaces[interfaceKey];
                
                // Reset styles
                td.style.backgroundColor = '';
                td.style.fontStyle = '';
                td.classList.remove('invalid');
                td.title = '';

                // Apply validation error style first
                if (validationError) {
                    td.classList.add('invalid');
                }

                let fmtKey, srcKey;

                if (col.type === 'calculated') {
                    fmtKey = `${rIdx}_calculated_${cIdx}`;
                } else if (col.type === 'uniform') {
                    fmtKey = `${rIdx}_uniform_${cIdx}`;
                } else {
                    const { table, colIndex } = col.source;
                    srcKey = `${table}_${rIdx}_${colIndex}`;
                    fmtKey = `${rIdx}_${table}_${colIndex}`;
                }

                // Style for Step 3 override (highest priority)
                if (format.editedData[fmtKey] !== undefined) {
                    td.style.backgroundColor = '#1e40af'; // dark-blue-800
                    td.style.fontStyle = 'italic';
                } 
                // Style for Step 2 edit dependency (second priority)
               else if (col.type === 'source') {
                   // srcKey is already defined
                   
                   // 1. Check for manual edit (highest precedence)
                   if (state.editedSourceData[srcKey] !== undefined) {
                       td.style.backgroundColor = '#422006'; // dark-yellow
                       td.style.fontStyle = 'italic';
                   }
                   // 2. Check for conversion
                   else {
                       const conversion = state.convertedSourceData[srcKey];
                       if (conversion !== undefined) {
                           td.style.backgroundColor = '#1e3a8a'; // dark-blue-900
                           td.style.fontStyle = 'italic';
                           td.title = `Converted from "${conversion.original}"`;
                       }
                   }
                }
            }

            function handleFormatCellEdit(event, interfaceKey, formatId, rowIndex, sourceTable, sourceColIndex) { 
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey]; 
                const format = state.formats.find(f => f.id === formatId); 
                if (!format) return; 
                
                // Find the column object
                let col, colIndex;
                if (sourceTable === 'calculated' || sourceTable === 'uniform') {
                    colIndex = sourceColIndex;
                    col = format.columns[colIndex];
                } else {
                    col = format.columns.find(c => c.type === 'source' && c.source.table === sourceTable && c.source.colIndex === sourceColIndex);
                    colIndex = format.columns.indexOf(col);
                }
                if (!col) return; // Column not found

                const newValue = event.target.textContent.trim(); 
                let cellKey, originalValue; 
                
                if (sourceTable === 'calculated') { 
                    cellKey = `${rowIndex}_calculated_${colIndex}`; 
                    originalValue = evaluateFormula(col, format, rowIndex, interfaceKey); 
                } else if (sourceTable === 'uniform') { 
                    cellKey = `${rowIndex}_uniform_${colIndex}`; 
                    originalValue = col.value; 
                } else { 
                    cellKey = `${rowIndex}_${sourceTable}_${sourceColIndex}`; 
                    originalValue = getResolvedValue(interfaceKey, sourceTable, rowIndex, sourceColIndex);
                } 
                
                // Get the raw value for formatting validation
                let rawValue = newValue;
                
                if (newValue === originalValue) { 
                    delete format.editedData[cellKey]; 
                    // If deleting an override, get the underlying value for validation
                    rawValue = getGridCellValue(col, format, rowIndex, colIndex, interfaceKey);
                } else { 
                    format.editedData[cellKey] = newValue; 
                } 
                
                // Re-validate and re-style the cell after editing
                // We use rawValue to check if the new value (or restored original) is valid
                const { formattedValue: validatedFormattedValue, error } = applyFormat(rawValue, col.format);
                
                // If the user's edit was valid, but not identical to the formatted string,
                // keep the user's value. But if it was invalid, show the error.
                if (error) {
                    event.target.textContent = rawValue; // Show the original (invalid) value
                    styleFormatCell(event.target, col, rowIndex, colIndex, interfaceKey, format, true);
                } else {
                    // If user types '1' but format is '00000', the formattedValue is '00000'.
                    // The override in editedData stores '1'.
                    // Here, we want to show the *formatted* value of the override.
                    const { formattedValue: finalFormattedValue, error: finalError } = applyFormat(newValue, col.format);
                    event.target.textContent = finalFormattedValue;
                    styleFormatCell(event.target, col, rowIndex, colIndex, interfaceKey, format, finalError);
                }

                updatePreview(interfaceKey, formatId); 
            }
            
            function applySubstitutions(value, substitutions) { 
                if (!substitutions || substitutions.length === 0) return value; 
                const trimmedValue = value.toString().trim(); 
                for (const sub of substitutions) { 
                    if (sub.find.trim() === "") continue; // Don't replace empty string
                    if (trimmedValue === sub.find) return sub.replace; 
                } 
                return value; 
            }
            
            /**
             * Updates a column's configuration when its header controls are changed.
             */
            function updateColumnConfig(interfaceKey, formatId, colIndex, key, value) {
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                const format = state.formats.find(f => f.id === formatId);
                if (!format || !format.columns[colIndex]) return;
                
                // Ensure numeric values for spaces
                if (key === 'spacesBefore') {
                    value = parseInt(value, 10) || 0;
                }
                
                format.columns[colIndex][key] = value;
                
                // Re-render the grid and preview to reflect changes
                renderFormatGrid(interfaceKey, format);
            }

            /**
             * Removes a column from the format.
             */
            function removeColumn(interfaceKey, formatId, colIndex) {
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                const format = state.formats.find(f => f.id === formatId);
                if (!format || !format.columns[colIndex]) return;
                
                format.columns.splice(colIndex, 1);
                
                // Re-render
                renderFormatGrid(interfaceKey, format);
            }
            
            function addCalculatedColumn(interfaceKey, formatId) { 
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey]; 
                const format = state.formats.find(f => f.id === formatId); 
                if (!format) return; 
                if (!format.primaryBaseTable) { showToast("Select Primary Base first.", "error"); return; } 
                const count = format.columns.filter(c => c.type === 'calculated').length + 1; 
                let ref = ""; 
                if (format.secondaryBaseTable === 'solidProperties') { 
                    // Try to find the 'Material' column (index 1) or Col 5 (index 4)
                    const schema = state.tableSchemas.solidProperties;
                    const matIdx = getColumnIndex(schema, 'Material'); // 1
                    const col5Idx = getColumnIndex(schema, 'Col5'); // 4
                    
                    if (col5Idx !== -1) {
                         ref = `secondary_${col5Idx}`;
                         showToast("Defaulting Calc Ref to Col 5 (Solid Props).", "info"); 
                    } else if (matIdx !== -1) {
                         ref = `secondary_${matIdx}`;
                         showToast("Defaulting Calc Ref to Material (Solid Props).", "info"); 
                    }
                } 
                const col = { 
                    type: 'calculated', name: `Calc ${count}`, 
                    calcFunction: 'if',
                    calcRefCol: ref, calcCompareVal: '', calcOrVal: '', calcTrueVal: '', calcFalseVal: '', 
                    spacesBefore: 0, format: 'none' 
                }; 
                format.columns.push(col); 
                renderFormatGrid(interfaceKey, format); 
            }

            /**
             * Adds a new uniform column to the format.
             */
            function addUniformColumn(interfaceKey, formatId) {
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                const format = state.formats.find(f => f.id === formatId);
                if (!format) return;
                if (!format.primaryBaseTable) { showToast("Select Primary Base first.", "error"); return; }
                
                const count = format.columns.filter(c => c.type === 'uniform').length + 1;
                const col = {
                    type: 'uniform',
                    name: `Uniform ${count}`,
                    value: '1',
                    spacesBefore: 0,
                    format: 'none'
                };
                format.columns.push(col);
                renderFormatGrid(interfaceKey, format);
            }
            
            function getResolvedValue(interfaceKey, tableKey, rowIndex, colIndex) { 
                if (interfaceKey !== 'modelConfig') return "";
                const state = globalState.interfaces[interfaceKey]; 
                const cellKey = `${tableKey}_${rowIndex}_${colIndex}`; // Use this key for all lookups

               // 1. Check for a manual edit first (highest priority)
               const editedValue = state.editedSourceData[cellKey];
               if (editedValue !== undefined) {
                   // Manual edit exists. Apply substitutions to it and return.
                   const colKey = `${tableKey}_${colIndex}`; 
                   const subs = state.sourceSubstitutions[colKey] || []; 
                   return applySubstitutions(editedValue, subs);
               }

               // 2. No manual edit. Check for a conversion.
               const conversion = state.convertedSourceData[cellKey];
               if (conversion !== undefined) {
                   // Return the converted value. Do NOT apply substitutions.
                   return conversion.converted;
               }

               // 3. No edit, no conversion. Get original value.
               const originalValue = state.tables[tableKey]?.[rowIndex]?.[colIndex] ?? "";
               
               // 4. Apply substitutions to the original value.
               const colKey = `${tableKey}_${colIndex}`; 
               const subs = state.sourceSubstitutions[colKey] || []; 
               return applySubstitutions(originalValue, subs); 
            }
            
            function getGridCellValue(col, format, rowIndex, colIndex, interfaceKey) { 
                if (interfaceKey !== 'modelConfig') return "";
                const state = globalState.interfaces[interfaceKey]; 
                if (col.type === 'calculated') { 
                    const key = `${rowIndex}_calculated_${colIndex}`; 
                    return format.editedData[key] ?? evaluateFormula(col, format, rowIndex, interfaceKey); 
                } else if (col.type === 'uniform') { 
                    const key = `${rowIndex}_uniform_${colIndex}`; 
                    return format.editedData[key] ?? col.value; 
                } else { 
                    const { table, colIndex: srcIdx } = col.source; 
                    const key = `${rowIndex}_${table}_${srcIdx}`; 
                    return format.editedData[key] ?? getResolvedValue(interfaceKey, table, rowIndex, srcIdx);
                } 
            }
            
            /**
             * Imports selected columns from Step 2 into the format grid in Step 3
             */
            function importSelectedColumns(interfaceKey, formatId, silent = false) {
                 if (interfaceKey !== 'modelConfig') return;
                 const state = globalState.interfaces[interfaceKey];
                 const format = state.formats.find(f => f.id === formatId);
                 if (!format || !format.primaryBaseTable) {
                     if (!silent) showToast("Select Primary Base first.", "error");
                     return;
                 }
                 const keys = Object.keys(state.sourceColumnSelections);
                 if (keys.length === 0) {
                     if (!silent) showToast("No columns selected.", "info");
                     return;
                 }
                 const existingSourceKeys = new Set(
                     format.columns
                         .filter(c => c.type === 'source')
                         .map(c => `${c.source.table}_${c.source.colIndex}`)
                 );

                 let addedCount = 0;
                 let formatMessage = ""; 

                 const relevantSelectedKeys = keys.filter(key => {
                     const [table] = key.split('_');
                     return state.sourceColumnSelections[key] && 
                            !existingSourceKeys.has(key) &&       
                            (table === format.primaryBaseTable || table === format.secondaryBaseTable); 
                 });

                 if (relevantSelectedKeys.length === 0) {
                     if (!silent) showToast('No *new* selected columns match the current base tables.', "info");
                     return;
                 }
                 
                 relevantSelectedKeys.sort((a, b) => {
                     const [tableA, idxA] = a.split('_');
                     const [tableB, idxB] = b.split('_');
                     if (tableA !== tableB) return tableA.localeCompare(tableB);
                     return parseInt(idxA, 10) - parseInt(idxB, 10);
                 });


                 relevantSelectedKeys.forEach(key => {
                     const [table, idxStr] = key.split('_');
                     const idx = parseInt(idxStr, 10);
                     let spaces = 0;
                     let fmt = 'none';
                     
                     const schema = state.tableSchemas[table];
                     const headerName = schema.headers[idx] || `Col${idx + 1}`;
                     
                     if (format.id === 1) { // Node Format rules
                         formatMessage = " with default Node formatting";
                         if (table === 'jointCoordinates') {
                             if (headerName === 'Y') { spaces = 5; fmt = '00000'; } 
                             else if (headerName === 'Col9') { spaces = 3; fmt = '000.000'; } 
                             else if (headerName === 'Col11') { spaces = 3; fmt = 'cond_sign_3dec'; } 
                             else if (headerName === 'Col13') { spaces = 3; fmt = 'cond_sign_3dec'; }
                         } else if (table === 'jointRestraints') {
                              if (headerName === 'RX') { spaces = 4; } // RX
                         }
                     } 
                     else if (format.id === 2) { // Element Format rules
                         formatMessage = " with default Element formatting";
                         if (table === 'connectivitySolid') {
                            const elementCols = ['J2', 'J4', 'J6', 'J8', 'Col11', 'Col13', 'Col15', 'Col17', 'Col19'];
                            if (elementCols.includes(headerName)) {
                                fmt = '00000';
                            }
                            if (headerName === 'J2') {
                                spaces = 5;
                            }
                         }
                         else if (table === 'solidProperties') {
                            if (headerName === 'Col5') {
                                // --- MODIFICATION: Use new format type, spaces are now handled by format ---
                                fmt = 'pad_to_5_char';
                                spaces = 0; // The format itself will add padding
                            }
                         }
                     }

                     // Add the source column first
                     format.columns.push({
                         type: 'source',
                         source: { table: table, colIndex: idx },
                         spacesBefore: spaces,
                         format: fmt
                     });
                     addedCount++;
                     
                     // NOW, check if we need to add the extra columns
                     if (format.id === 2 && table === 'solidProperties' && headerName === 'Col5') {
                         
                         // Add the new Calculated Column
                         const calcCount = format.columns.filter(c => c.type === 'calculated').length + 1;
                         const calcCol = { 
                             type: 'calculated', name: `Calc ${calcCount}`, 
                             calcFunction: 'if',
                             calcRefCol: `secondary_${idx}`, // Reference 'Col 5'
                             calcCompareVal: '', calcOrVal: '', calcTrueVal: '', calcFalseVal: '', 
                             spacesBefore: 0, format: 'none' 
                         };
                         format.columns.push(calcCol);
                         
                         // Add the new Uniform Column
                         const uniformCount = format.columns.filter(c => c.type === 'uniform').length + 1;
                         const uniformCol = {
                             type: 'uniform',
                             name: `Uniform ${uniformCount}`,
                             value: '1',
                             spacesBefore: 0,
                             format: 'none'
                         };
                         format.columns.push(uniformCol);
                     }
                 });

                 if (addedCount > 0) {
                     if (!silent) showToast(`Added ${addedCount} columns${formatMessage}.`, "success");
                     if (!silent) {
                        renderFormatGrid(interfaceKey, format);
                     }
                 }
            }
            
            /**
             * Enhanced applyFormat function with conditional sign formatting AND ERROR CHECKING
             */
            function applyFormat(value, formatType) {
                let num, parts, integer, decimal;
                
                const pad = (intPart, len) => {
                    const strPart = String(intPart);
                    const neg = strPart.startsWith('-');
                    const dig = neg ? strPart.substring(1) : strPart;
                    const padDig = dig.padStart(len, '0');
                    return neg ? `-${padDig}` : padDig;
                };

                // --- MODIFICATION: Added new format type ---
                if (formatType === 'pad_to_5_char') {
                    const strVal = String(value).trim();
                    num = parseInt(strVal, 10);
                    // Check for invalid number or non-numeric string that isn't empty
                    if ((isNaN(num) && strVal !== "") || strVal.length > 5) {
                        return { formattedValue: strVal, error: true };
                    }
                    // Valid number or empty string
                    return { formattedValue: strVal, error: false };
                }
                
                if (formatType === 'cond_sign_3dec') {
                    num = parseFloat(value.toString().replace(/[^0-9.-]/g, ''));
                    if (isNaN(num)) return { formattedValue: value, error: true };
                    
                    parts = num.toFixed(3).split('.');
                    decimal = parts[1] || '000';
                    
                    if (num < 0) {
                        integer = pad(parts[0], 2);
                    } 
                    else {
                        integer = pad(parts[0], 3);
                    }
                    return { formattedValue: `${integer}.${decimal}`, error: false };
                }
                
                if (formatType === '00000') {
                    num = parseInt(value.toString().replace(/[^0-9-]/g, ''), 10);
                    if (isNaN(num)) return { formattedValue: value, error: true };
                    const formatted = (num < 0 ? '-' : '') + Math.abs(num).toString().padStart(5, '0');
                    return { formattedValue: formatted, error: false };
                }
                
                if (formatType === '000.000') {
                    num = parseFloat(value.toString().replace(/[^0-9.-]/g, ''));
                    if (isNaN(num)) return { formattedValue: value, error: true };
                    parts = num.toFixed(3).split('.'); 
                    integer = pad(parts[0], 3); 
                    decimal = parts[1] || '000'; 
                    return { formattedValue: `${integer}.${decimal}`, error: false };
                }
                
                if (formatType === '00.000') {
                    num = parseFloat(value.toString().replace(/[^0-9.-]/g, ''));
                    if (isNaN(num)) return { formattedValue: value, error: true };
                    parts = num.toFixed(3).split('.'); 
                    let intLen = parts[0].startsWith('-') ? parts[0].length - 1 : parts[0].length;
                    integer = pad(parts[0], intLen > 2 ? intLen : (parts[0].startsWith('-') ? 2 : 2)); 
                    decimal = parts[1] || '000'; 
                    return { formattedValue: `${integer}.${decimal}`, error: false };
                }
                
                return { formattedValue: value.toString(), error: false };
            }
            
            // Enhanced evaluateFormula function with if/or support
            function evaluateFormula(col, format, rowIndex, interfaceKey) { 
                const { calcRefCol, calcCompareVal, calcTrueVal, calcFalseVal, calcFunction, calcOrVal } = col; 
                if (!calcRefCol) return ''; 
                try { 
                    const [type, idxStr] = calcRefCol.split('_'); 
                    const idx = parseInt(idxStr); 
                    if (isNaN(idx)) return '#REF!'; 
                    const refKey = (type === 'secondary' && format.secondaryBaseTable) ? format.secondaryBaseTable : format.primaryBaseTable; 
                    if (!refKey) return '#REF!'; 
                    
                    const refValue = getResolvedValue(interfaceKey, refKey, rowIndex, idx);
                    
                    // Handle if/or function
                    if (calcFunction === 'if_or') {
                        const compareValues = calcCompareVal.split(',').map(v => v.trim()).filter(v => v);
                        const orValues = (calcOrVal || '').split(',').map(v => v.trim()).filter(v => v);
                        
                        const isMatch = compareValues.some(compareVal => refValue == compareVal) ||
                                      orValues.some(orVal => refValue == orVal);
                                      
                        return isMatch ? calcTrueVal : calcFalseVal;
                    }
                    
                    // Default "if" function (now also supports comma-separated list)
                    const compareValues = calcCompareVal.split(',').map(v => v.trim()).filter(v => v);
                    const isMatch = compareValues.some(compareVal => refValue == compareVal);
                    
                    return isMatch ? calcTrueVal : calcFalseVal; 
                } catch (e) { 
                    console.error("Formula Eval Error:", e);
                    return '#ERROR!'; 
                } 
            }

            // --- END: Advanced Formula/Format Block ---


            // Enhanced renderFormatGrid function with conditional formatting support
            function renderFormatGrid(interfaceKey, format) { 
                const state = globalState.interfaces[interfaceKey]; 
                const head = document.getElementById(`grid-head-${format.id}-${interfaceKey}`); 
                const body = document.getElementById(`grid-body-${format.id}-${interfaceKey}`); 
                const placeholder = document.getElementById(`grid-placeholder-${format.id}-${interfaceKey}`); 
                if (!head || !body || !placeholder) return; 
                head.innerHTML = ""; 
                body.innerHTML = ""; 
                const baseKey = format.primaryBaseTable; 
                if (!baseKey) { 
                    placeholder.classList.remove('hidden'); 
                    placeholder.textContent = "Select Primary Base Table to begin."; 
                    updatePreview(interfaceKey, format.id); 
                    return; 
                } 
                if (format.columns.length === 0) { 
                    placeholder.classList.remove('hidden'); 
                    placeholder.textContent = 'Use "Import Selected Columns" or "Add" buttons to build your format.'; 
                    updatePreview(interfaceKey, format.id); 
                    return; 
                } 
                placeholder.classList.add('hidden'); 
                
                // Build calculation dropdown options
                let calcOpts = '<option value="">-- Select --</option>'; 
                const pSchema = state.tableSchemas[baseKey], pData = state.tables[baseKey]; 
                if (pData?.length > 0) { 
                    const max = Math.max(pSchema.headers.length, ...pData.map(r => r?.length ?? 0)); 
                    calcOpts += `<optgroup label="Primary: ${pSchema.name}">`; 
                    for (let i = 0; i < max; i++) calcOpts += `<option value="primary_${i}">Col ${i + 1}: ${pSchema.headers[i] || `Col ${i + 1}`}</option>`; 
                    calcOpts += `</optgroup>`; 
                } 
                const sKey = format.secondaryBaseTable; 
                if (sKey) { 
                    const sSchema = state.tableSchemas[sKey], sData = state.tables[sKey]; 
                    if (sData?.length > 0) { 
                        const max = Math.max(sSchema.headers.length, ...sData.map(r => r?.length ?? 0)); 
                        calcOpts += `<optgroup label="Second: ${sSchema.name}">`; 
                        for (let i = 0; i < max; i++) calcOpts += `<option value="secondary_${i}">Col ${i + 1}: ${sSchema.headers[i] || `Col ${i + 1}`}</option>`; 
                        calcOpts += `</optgroup>`; 
                    } 
                } 
                
                const trHead = head.insertRow(); 
                format.columns.forEach((col, index) => { 
                    const th = document.createElement('th'); 
                    th.className = "header-drag-target"; // Class to mark as draggable
                    th.draggable = true; 
                    th.dataset.index = index; 
                    th.addEventListener('dragstart', (e) => handleHeaderDragStart(e, interfaceKey, index)); 
                    th.addEventListener('dragover', handleHeaderDragOver); 
                    th.addEventListener('drop', (e) => handleHeaderDrop(e, interfaceKey, index)); 
                    th.addEventListener('dragend', (e) => handleHeaderDragEnd(e, interfaceKey)); 
                    
                    // --- MODIFICATION: Added new format option ---
                    let fmtOpts = `<option value="none" ${col.format === 'none' ? 'selected' : ''}>None</option>
                                  <option value="00000" ${col.format === '00000' ? 'selected' : ''}>00000</option>
                                  <option value="000.000" ${col.format === '000.000' ? 'selected' : ''}>000.000</option>
                                  <option value="00.000" ${col.format === '00.000' ? 'selected' : ''}>00.000</option>
                                  <option value="cond_sign_3dec" ${col.format === 'cond_sign_3dec' ? 'selected' : ''}>+/- 3 Dec (000.0/00.0)</option>
                                  <option value="pad_to_5_char" ${col.format === 'pad_to_5_char' ? 'selected' : ''}>Pad to 5 Chars</option>`; 
                                  
                    let html = ''; 
                    if (col.type === 'calculated') {
                        html = `<div class="col-header-content">
                                    <input type="text" class="config-input col-name-input" value="${col.name}">
                                    <span class="col-remove-btn">&times;</span>
                                </div>
                                <div class="config-group">
                                    <label>
                                        <span>Function:</span>
                                        <select class="config-select calc-function-select">
                                            <option value="if" ${!col.calcFunction || col.calcFunction === 'if' ? 'selected' : ''}>If</option>
                                            <option value="if_or" ${col.calcFunction === 'if_or' ? 'selected' : ''}>If/Or</option>
                                        </select>
                                    </label>
                                    <label>
                                        <span>If:</span>
                                        <select class="config-select calc-select calc-ref-col-input">${calcOpts}</select>
                                    </label>
                                    <label>
                                        <span>Equals:</span>
                                        <input type="text" class="config-input calc-input calc-compare-val-input" value="${col.calcCompareVal}" placeholder="Comp (val1,val2)">
                                    </label>
                                    <div class="if-or-section" ${col.calcFunction === 'if_or' ? '' : 'style="display:none;"'}>
                                        <label>
                                            <span>Or Equals:</span>
                                            <input type="text" class="config-input calc-input calc-or-val-input" value="${col.calcOrVal || ''}" placeholder="Or (val1,val2)">
                                        </label>
                                    </div>
                                    <label>
                                        <span>Then:</span>
                                        <input type="text" class="config-input calc-input calc-true-val-input" value="${col.calcTrueVal}" placeholder="True">
                                    </label>
                                    <label>
                                        <span>Else:</span>
                                        <input type="text" class="config-input calc-input calc-false-val-input" value="${col.calcFalseVal}" placeholder="False">
                                    </label>
                                    <hr class="my-1 border-gray-700">
                                    <label>
                                        <span>Spaces:</span>
                                        <input type="number" class="config-input spaces-input" value="${col.spacesBefore}" min="0">
                                    </label>
                                    <label>
                                        <span>Format:</span>
                                        <select class="config-select format-select">${fmtOpts}</select>
                                    </label>
                                </div>`; 
                    } else if (col.type === 'uniform') {
                        html = `<div class="col-header-content">
                                    <input type="text" class="config-input col-name-input" value="${col.name}">
                                    <span class="col-remove-btn">&times;</span>
                                </div>
                                <div class="config-group">
                                    <label>
                                        <span>Value:</span>
                                        <input type="text" class="config-input calc-input uniform-value-input" value="${col.value}" placeholder="Value">
                                    </label>
                                    <hr class="my-1 border-gray-700">
                                    <label>
                                        <span>Spaces:</span>
                                        <input type="number" class="config-input spaces-input" value="${col.spacesBefore}" min="0">
                                    </label>
                                    <label>
                                        <span>Format:</span>
                                        <select class="config-select format-select">${fmtOpts}</select>
                                    </label>
                                </div>`; 
                    } else { 
                        const schema = state.tableSchemas[col.source.table]; 
                        const name = schema.headers[col.source.colIndex] || `Col ${col.source.colIndex + 1}`; 
                        html = `<div class="col-header-content">
                                    <span>${schema.name}: <strong>${name}</strong></span>
                                    <span class="col-remove-btn">&times;</span>
                                </div>
                                <div class="config-group">
                                    <label>
                                        <span>Spaces:</span>
                                        <input type="number" class="config-input spaces-input" value="${col.spacesBefore}" min="0">
                                    </label>
                                    <label>
                                        <span>Format:</span>
                                        <select class="config-select format-select">${fmtOpts}</select>
                                    </label>
                                </div>`; 
                    } 
                    th.innerHTML = html; 
                    if (col.type === 'calculated') { 
                        th.querySelector('.col-name-input')?.addEventListener('change', (e) => updateColumnConfig(interfaceKey, format.id, index, 'name', e.target.value)); 
                        if (col.calcRefCol) th.querySelector('.calc-ref-col-input').value = col.calcRefCol; 
                        th.querySelector('.calc-ref-col-input')?.addEventListener('change', (e) => updateColumnConfig(interfaceKey, format.id, index, 'calcRefCol', e.target.value)); 
                        th.querySelector('.calc-compare-val-input')?.addEventListener('change', (e) => updateColumnConfig(interfaceKey, format.id, index, 'calcCompareVal', e.target.value)); 
                        
                        const functionSelect = th.querySelector('.calc-function-select');
                        if (functionSelect) {
                            functionSelect.addEventListener('change', (e) => {
                                updateColumnConfig(interfaceKey, format.id, index, 'calcFunction', e.target.value);
                                const ifOrSection = th.querySelector('.if-or-section');
                                if (ifOrSection) {
                                    ifOrSection.style.display = e.target.value === 'if_or' ? 'block' : 'none';
                                }
                            });
                        }
                        
                        th.querySelector('.calc-or-val-input')?.addEventListener('change', (e) => updateColumnConfig(interfaceKey, format.id, index, 'calcOrVal', e.target.value));
                        th.querySelector('.calc-true-val-input')?.addEventListener('change', (e) => updateColumnConfig(interfaceKey, format.id, index, 'calcTrueVal', e.target.value)); 
                        th.querySelector('.calc-false-val-input')?.addEventListener('change', (e) => updateColumnConfig(interfaceKey, format.id, index, 'calcFalseVal', e.target.value)); 
                    } else if (col.type === 'uniform') { 
                        th.querySelector('.col-name-input')?.addEventListener('change', (e) => updateColumnConfig(interfaceKey, format.id, index, 'name', e.target.value)); 
                        th.querySelector('.uniform-value-input')?.addEventListener('change', (e) => updateColumnConfig(interfaceKey, format.id, index, 'value', e.target.value)); 
                    } 
                    th.querySelector('.spaces-input')?.addEventListener('change', (e) => updateColumnConfig(interfaceKey, format.id, index, 'spacesBefore', e.target.value)); 
                    th.querySelector('.format-select')?.addEventListener('change', (e) => updateColumnConfig(interfaceKey, format.id, index, 'format', e.target.value)); 
                    th.querySelector('.col-remove-btn')?.addEventListener('click', (e) => { e.stopPropagation(); removeColumn(interfaceKey, format.id, index); }); 
                    trHead.appendChild(th); 
                }); 
                
                // Render grid body
                (state.tables[baseKey] || []).forEach((_, rIdx) => { 
                    const tr = body.insertRow(); 
                    format.columns.forEach((col, cIdx) => { 
                        const td = tr.insertCell(); 
                        
                        const val = getGridCellValue(col, format, rIdx, cIdx, interfaceKey);
                        const { formattedValue, error } = applyFormat(val, col.format);
                        
                        td.textContent = formattedValue; 
                        td.contentEditable = "true"; 
                        
                        let eventTable, eventColIndex;
                        
                        if (col.type === 'calculated') { 
                            eventTable = 'calculated';
                            eventColIndex = cIdx;
                        } else if (col.type === 'uniform') { 
                            eventTable = 'uniform';
                            eventColIndex = cIdx;
                        } else { 
                            eventTable = col.source.table;
                            eventColIndex = col.source.colIndex;
                        } 
                        
                        td.addEventListener('blur', (e) => handleFormatCellEdit(e, interfaceKey, format.id, rIdx, eventTable, eventColIndex)); 
                        
                        // Apply initial styling
                        styleFormatCell(td, col, rIdx, cIdx, interfaceKey, format, error);
                        
                    }); 
                }); 
                updatePreview(interfaceKey, format.id); 
            }
            
            /**
             * Updates the text preview area based on the current format grid.
             */
            function updatePreview(interfaceKey, formatId) {
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                const format = state.formats.find(f => f.id === formatId);
                const preview = document.getElementById(`preview-output-${formatId}-${interfaceKey}`);
                if (!format || !preview) return;
                
                const baseKey = format.primaryBaseTable;
                if (!baseKey || !state.tables[baseKey] || state.tables[baseKey].length === 0) {
                    preview.value = "";
                    return;
                }
                
                let output = "";
                const rowCount = state.tables[baseKey].length;
                
                for (let rIdx = 0; rIdx < rowCount; rIdx++) {
                    let line = "";
                    format.columns.forEach((col, cIdx) => {
                        let value = getGridCellValue(col, format, rIdx, cIdx, interfaceKey);
                        let { formattedValue, error } = applyFormat(value, col.format);
                        
                        let spaces = "";
                        
                        // --- MODIFICATION: Handle dynamic spacing for pad_to_5_char ---
                        if (col.format === 'pad_to_5_char') {
                            if (error) {
                                // Invalid value, pad with 5 spaces to maintain alignment
                                spaces = " ".repeat((col.spacesBefore || 0) + 5);
                                formattedValue = ""; // Don't print the invalid value
                            } else {
                                // Calculate padding to fill 5 chars, right-aligned
                                const valueLength = formattedValue.length;
                                const dynamicPadding = Math.max(0, 5 - valueLength);
                                spaces = " ".repeat((col.spacesBefore || 0) + dynamicPadding);
                            }
                        } else {
                            // Standard spacing
                            spaces = " ".repeat(col.spacesBefore || 0);
                        }
                        
                        line += (spaces + formattedValue);
                    });
                    output += line + "\n";
                }
                
                preview.value = output;
            }
            
            // --- END: Format Builder (Step 3) Core Logic ---

            // --- START: Drag & Drop Column Handlers ---

            function handleHeaderDragStart(e, interfaceKey, index) {
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                state.draggedHeaderIndex = index;
                e.target.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            }

            function handleHeaderDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                const target = e.target.closest('th.header-drag-target');
                if (target) {
                    // Clear previous hovers
                    target.parentNode.querySelectorAll('.header-drag-over').forEach(th => th.classList.remove('header-drag-over'));
                    target.classList.add('header-drag-over');
                }
            }

            function handleHeaderDrop(e, interfaceKey, dropIndex) {
                e.preventDefault();
                if (interfaceKey !== 'modelConfig') return;
                const state = globalState.interfaces[interfaceKey];
                const format = state.formats.find(f => f.id === state.activeFormatId);
                
                const dropTarget = e.target.closest('th.header-drag-target');
                if (!dropTarget) return;
                const actualDropIndex = parseInt(dropTarget.dataset.index, 10);
                
                if (format && state.draggedHeaderIndex !== null && state.draggedHeaderIndex !== actualDropIndex) {
                    // Move item in array
                    const [draggedItem] = format.columns.splice(state.draggedHeaderIndex, 1);
                    format.columns.splice(actualDropIndex, 0, draggedItem);
                    
                    // Re-render
                    renderFormatGrid(interfaceKey, format);
                }
                // Clean up drag state
                handleHeaderDragEnd(e, interfaceKey);
            }

            function handleHeaderDragEnd(e, interfaceKey) {
                if (globalState.interfaces.modelConfig) {
                    globalState.interfaces.modelConfig.draggedHeaderIndex = null;
                }
                // Clear all visual indicators
                document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                document.querySelectorAll('.header-drag-over').forEach(el => el.classList.remove('header-drag-over'));
            }

            // --- END: Drag & Drop Column Handlers ---
            // --- END: PHASE 4 SCRIPT ---


            // --- START: PHASE 5 (EQUAL DISP BOUNDARY) SCRIPT ---
            
            // Initialize the interface
            function initializePhase5() {
                renderEqualDispFormatBuilder();
                attachEqualDispListeners();
            }

            // Attach event listeners
            function attachEqualDispListeners() {
                const dropZone = document.getElementById('drop-zone-equalDisp');
                const fileInput = document.getElementById('file-upload-equalDisp');
                
                if (dropZone) {
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropZone.classList.add('drop-zone-over');
                    });
                    
                    dropZone.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropZone.classList.remove('drop-zone-over');
                    });
                    
                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        dropZone.classList.remove('drop-zone-over');
                        handleFileDrop(e);
                    });
                }
                
                fileInput?.addEventListener('change', handleFileInput);
                document.getElementById('clear-files-btn-equalDisp')?.addEventListener('click', clearEqualDispFiles);
            }

            // Handle file drop
            function handleFileDrop(e) {
                if (e.dataTransfer.files.length) {
                    processFiles(e.dataTransfer.files);
                }
            }

            // Handle file input
            function handleFileInput(e) {
                if (e.target.files.length) {
                    processFiles(e.target.files);
                }
                e.target.value = null;
            }

            // Clear all files
            function clearEqualDispFiles() {
                const state = globalState.interfaces.equalDisp;
                state.files = [];
                state.activeFileIndex = 0;
                if (state.formats[0]) {
                    state.formats[0].columns = [];
                    state.formats[0].editedData = {};
                }
                renderEqualDispSourceColumns();
                renderEqualDispDataView();
                renderFormatGrid_EqualDisp();
                saveState_EqualDisp();
                showToast("All files cleared", "info");
            }

            // Process uploaded files
            function processFiles(files) {
                const state = globalState.interfaces.equalDisp;
                
                Array.from(files).forEach(file => {
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (!['csv', 'xlsx'].includes(ext)) {
                        showToast(`Skipped '${file.name}': Invalid format.`, "error");
                        return;
                    }
                    
                    showToast(`Processing '${file.name}'...`, "info");
                    
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            let data = [];
                            let header = "Column A";
                            
                            if (ext === 'xlsx') {
                                const wb = XLSX.read(e.target.result, { type: 'binary' });
                                const ws = wb.Sheets[wb.SheetNames[0]];
                                const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
                                
                                if (json[0]?.[0]) {
                                    header = json[0][0];
                                }
                                
                                for (let i = 3; i < json.length; i++) {
                                    if (json[i]?.[0] != null && json[i][0] !== "") {
                                        data.push([json[i][0]]);
                                    } else if (data.length > 0 && i >= 3) {
                                        break;
                                    }
                                }
                            } else {
                                const lines = e.target.result.split(/[\r\n]+/).filter(l => l.trim());
                                const parseCsv = (line) => {
                                    let result = [];
                                    let cell = '';
                                    let inQuotes = false;
                                    
                                    for (let i = 0; i < line.length; i++) {
                                        const char = line[i];
                                        
                                        if (char === '"') {
                                            inQuotes = !inQuotes;
                                        } else if (char === ',' && !inQuotes) {
                                            result.push(cell);
                                            cell = '';
                                        } else {
                                            cell += char;
                                        }
                                    }
                                    
                                    result.push(cell);
                                    return result.map(v => v.replace(/^"|"$/g, ''));
                                };
                                
                                if (lines[0]) {
                                    const headerRow = parseCsv(lines[0]);
                                    if (headerRow[0]) {
                                        header = headerRow[0];
                                    }
                                }
                                
                                for (let i = 3; i < lines.length; i++) {
                                    const row = parseCsv(lines[i]);
                                    if (row?.[0] != null && row[0] !== "") {
                                        data.push([row[0]]);
                                    } else if (data.length > 0 && i >= 3) {
                                        break;
                                    }
                                }
                            }
                            
                            state.files.push({
                                name: file.name,
                                headers: [header],
                                data: data
                            });
                            
                            showToast(`Loaded '${file.name}'. Extracted ${data.length} rows.`, "success");
                            
                            if (state.files.length === 1) {
                                state.activeFileIndex = 0;
                            }
                            
                            renderEqualDispSourceColumns();
                            renderEqualDispDataView();
                            
                        } catch (err) {
                            console.error("Parse Error:", err);
                            showToast(`Error parsing '${file.name}'.`, "error");
                        }
                    };
                    
                    if (ext === 'xlsx') {
                        reader.readAsBinaryString(file);
                    } else {
                        reader.readAsText(file);
                    }
                });
            }

            // Render source columns
            function renderEqualDispSourceColumns() {
                const { files, activeFileIndex } = globalState.interfaces.equalDisp;
                const tabsEl = document.getElementById('file-tabs-equalDisp');
                const listEl = document.getElementById('source-column-list-equalDisp');
                
                if (!tabsEl || !listEl) return;
                
                tabsEl.innerHTML = "";
                listEl.innerHTML = "";
                
                if (files.length === 0) {
                    listEl.innerHTML = `<p class="text-slate-400">Upload files to begin.</p>`;
                    return;
                }
                
                files.forEach((f, i) => {
                    const btn = document.createElement('button');
                    btn.className = `file-tab-btn ${i === activeFileIndex ? 'active' : ''}`;
                    btn.textContent = f.name;
                    btn.dataset.index = i;
                    btn.addEventListener('click', () => {
                        globalState.interfaces.equalDisp.activeFileIndex = i;
                        renderEqualDispSourceColumns();
                        renderEqualDispDataView();
                    });
                    tabsEl.appendChild(btn);
                });
                
                const activeFile = files[activeFileIndex];
                if (activeFile?.headers[0]) {
                    const div = document.createElement('div');
                    div.className = 'source-column-draggable';
                    div.textContent = activeFile.headers[0];
                    listEl.appendChild(div);
                } else {
                    listEl.innerHTML = `<p class="text-slate-400">No header found.</p>`;
                }
            }

            // Render data view
            function renderEqualDispDataView() {
                const { files, activeFileIndex } = globalState.interfaces.equalDisp;
                const contentEl = document.getElementById('data-view-content-equalDisp');
                
                if (!contentEl) return;
                
                const file = files[activeFileIndex];
                contentEl.textContent = (!file?.data?.length) ? 'No data available.' : file.data.map(r => r[0]).join('\n');
            }

            // Render format builder
            function renderEqualDispFormatBuilder() {
                document.getElementById('import-all-cols-btn-equalDisp')?.addEventListener('click', importAllColumns_EqualDisp);
                document.getElementById('add-manual-col-btn-equalDisp')?.addEventListener('click', addManualColumn_EqualDisp);
                document.getElementById('undo-btn-equalDisp')?.addEventListener('click', undo_EqualDisp);
                document.getElementById('redo-btn-equalDisp')?.addEventListener('click', redo_EqualDisp);
                document.getElementById('generate-output-btn-equalDisp')?.addEventListener('click', generateFullOutput_EqualDisp);
                document.getElementById('copy-btn-equalDisp')?.addEventListener('click', copyOutput_EqualDisp);
                document.getElementById('download-btn-equalDisp')?.addEventListener('click', downloadOutput_EqualDisp);
                renderFormatGrid_EqualDisp();
                saveState_EqualDisp();
            }

            // Render format grid
            function renderFormatGrid_EqualDisp() {
                const state = globalState.interfaces.equalDisp;
                const format = state.formats[0];
                const head = document.getElementById(`grid-head-equalDisp`);
                const body = document.getElementById(`grid-body-equalDisp`);
                const placeholder = document.getElementById(`grid-placeholder-equalDisp`);
                
                if (!head || !body || !placeholder) return;
                
                head.innerHTML = "";
                body.innerHTML = "";
                
                if (format.columns.length === 0) {
                    placeholder.classList.remove('hidden');
                    placeholder.textContent = state.files.length > 0 ? "Click 'Import All Columns' to begin." : "Upload files and click 'Import All Columns'.";
                    updatePreview_EqualDisp(format);
                    return;
                }
                
                placeholder.classList.add('hidden');
                const trHead = document.createElement('tr');
                let maxRows = 0;
                
                format.columns.forEach((col, index) => {
                    if (col.type === 'source' && state.files[col.fileIndex]) {
                        maxRows = Math.max(maxRows, state.files[col.fileIndex].data.length);
                    }
                    
                    const th = document.createElement('th');
                    th.draggable = true;
                    th.dataset.index = index;
                    th.addEventListener('dragstart', (e) => handleHeaderDragStart(e, 'equalDisp', index));
                    th.addEventListener('dragover', handleHeaderDragOver);
                    th.addEventListener('drop', (e) => handleHeaderDrop(e, 'equalDisp', index));
                    th.addEventListener('dragend', (e) => handleHeaderDragEnd(e, 'equalDisp'));
                    
                    const fmtOpts = `<option value="none" ${col.format === 'none' ? 'selected' : ''}>None</option>
                                   <option value="00000" ${col.format === '00000' ? 'selected' : ''}>00000</option>`;
                    
                    let html = '';
                    
                    if (col.type === 'source') {
                        const file = state.files[col.fileIndex];
                        th.className = 'equal-disp-source-col';
                        html = `<div class="col-header-content">
                                    <span class="text-xs font-normal">File: ${file?.name || '??'}<br><strong>${col.header || '??'}</strong></span>
                                    <span class="col-remove-btn">&times;</span>
                                </div>
                                <div class="config-group">
                                    <label>
                                        <span>Spaces:</span>
                                        <input type="number" class="config-input spaces-input" value="${col.spacesBefore}" min="0">
                                    </label>
                                    <label>
                                        <span>Format:</span>
                                        <select class="config-select format-select">${fmtOpts}</select>
                                    </label>
                                </div>`;
                    } else if (col.type === 'uniform') {
                        th.className = 'equal-disp-uniform-col';
                        html = `<div class="col-header-content">
                                    <input type="text" class="config-input col-name-input" value="${col.name}">
                                    <span class="col-remove-btn">&times;</span>
                                </div>
                                <div class="config-group">
                                    <label>
                                        <span>Value:</span>
                                        <input type="text" class="config-input calc-input uniform-value-input" value="${col.value}" placeholder="Value">
                                    </label>
                                    <hr class="my-1 border-slate-600">
                                    <label>
                                        <span>Spaces:</span>
                                        <input type="number" class="config-input spaces-input" value="${col.spacesBefore}" min="0">
                                    </label>
                                    <label>
                                        <span>Format:</span>
                                        <select class="config-select format-select">${fmtOpts}</select>
                                    </label>
                                </div>`;
                    }
                    
                    th.innerHTML = html;
                    
                    th.querySelector('.spaces-input')?.addEventListener('change', (e) => {
                        updateColumnConfig_EqualDisp(index, 'spacesBefore', e.target.value);
                        saveState_EqualDisp();
                    });
                    
                    th.querySelector('.format-select')?.addEventListener('change', (e) => {
                        updateColumnConfig_EqualDisp(index, 'format', e.target.value);
                        saveState_EqualDisp();
                    });
                    
                    th.querySelector('.col-remove-btn')?.addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeColumn_EqualDisp(index);
                        saveState_EqualDisp();
                    });
                    
                    if (col.type === 'uniform') {
                        th.querySelector('.col-name-input')?.addEventListener('change', (e) => {
                            updateColumnConfig_EqualDisp(index, 'name', e.target.value);
                            saveState_EqualDisp();
                        });
                        
                        th.querySelector('.uniform-value-input')?.addEventListener('change', (e) => {
                            updateColumnConfig_EqualDisp(index, 'value', e.target.value);
                            saveState_EqualDisp();
                        });
                    }
                    
                    trHead.appendChild(th);
                });
                
                head.appendChild(trHead);

                if (maxRows === 0 && format.columns.some(c => c.type === 'uniform')) {
                    maxRows = 1;
                }
                
                for (let rIdx = 0; rIdx < maxRows; rIdx++) {
                    const tr = document.createElement('tr');
                    format.columns.forEach((col, cIdx) => {
                        const td = tr.insertCell();
                        const value = getGridCellValue_EqualDisp(col, rIdx, format);
                        td.textContent = value;
                        td.contentEditable = "true";
                        const cellKey = `${rIdx}_${cIdx}`;
                        
                        td.addEventListener('blur', (e) => {
                            handleFormatCellEdit_EqualDisp(e, format, cellKey, value);
                            saveState_EqualDisp();
                        });
                        
                        if (format.editedData[cellKey] !== undefined) {
                            td.style.backgroundColor = 'rgba(59, 130, 246, 0.2)';
                            td.style.fontStyle = 'italic';
                        }
                    });
                    body.appendChild(tr);
                }
                
                updatePreview_EqualDisp(format);
            }

            // Get grid cell value
            function getGridCellValue_EqualDisp(col, rowIndex, format) {
                const editKey = `${rowIndex}_${format.columns.indexOf(col)}`;
                
                if (format.editedData[editKey] !== undefined) {
                    return format.editedData[editKey];
                }
                
                if (col.type === 'source') {
                    return globalState.interfaces.equalDisp.files[col.fileIndex]?.data[rowIndex]?.[0] || "";
                }
                
                if (col.type === 'uniform') {
                    return col.value;
                }
                
                return "";
            }

            // Handle format cell edit
            function handleFormatCellEdit_EqualDisp(event, format, cellKey, originalValue) {
                const newValue = event.target.textContent.trim();
                
                if (newValue === originalValue) {
                    delete format.editedData[cellKey];
                } else {
                    format.editedData[cellKey] = newValue;
                }
                
                event.target.style.backgroundColor = newValue === originalValue ? '' : 'rgba(59, 130, 246, 0.2)';
                event.target.style.fontStyle = newValue === originalValue ? '' : 'italic';
                updatePreview_EqualDisp(format);
            }

            // Apply format
            function applyFormat_EqualDisp(value, formatType) {
                if (formatType === '00000') {
                    return (parseInt(value.toString().replace(/[^0-9]/g, ''), 10) || 0).toString().padStart(5, '0');
                }
                return value.toString();
            }

            // Generate concatenated line
            function generateConcatenatedLine_EqualDisp(format, rowIndex) {
                return format.columns.map(col => 
                    " ".repeat(col.spacesBefore || 0) + 
                    applyFormat_EqualDisp(getGridCellValue_EqualDisp(col, rowIndex, format), col.format)
                ).join('');
            }

            // Update preview
            function updatePreview_EqualDisp(format) {
                const el = document.getElementById(`output-preview-equalDisp`);
                if (!format || !el) return;
                
                let maxRows = 0;
                format.columns.forEach(c => {
                    if (c.type === 'source' && globalState.interfaces.equalDisp.files[c.fileIndex]) {
                        maxRows = Math.max(maxRows, globalState.interfaces.equalDisp.files[c.fileIndex].data.length);
                    }
                });
                
                if (maxRows === 0 && format.columns.some(c => c.type === 'uniform')) {
                    maxRows = 1;
                }
                
                if (maxRows === 0) {
                    el.textContent = "No data available for preview.";
                    return;
                }
                
                el.textContent = Array.from({ length: Math.min(maxRows, 10) }, (_, i) => 
                    generateConcatenatedLine_EqualDisp(format, i)
                ).join('\n');
            }

            // Generate full output
            function generateFullOutput_EqualDisp() {
                const el = document.getElementById(`final-output-equalDisp`);
                const format = globalState.interfaces.equalDisp.formats[0];
                
                let maxRows = 0;
                format.columns.forEach(c => {
                    if (c.type === 'source' && globalState.interfaces.equalDisp.files[c.fileIndex]) {
                        maxRows = Math.max(maxRows, globalState.interfaces.equalDisp.files[c.fileIndex].data.length);
                    }
                });
                
                if (maxRows === 0 && format.columns.some(c => c.type === 'uniform')) {
                    maxRows = 1;
                }
                
                if (maxRows === 0) {
                    showToast("No data available to generate output.", "error");
                    el.value = "";
                    return;
                }
                
                el.value = Array.from({ length: maxRows }, (_, i) => 
                    generateConcatenatedLine_EqualDisp(format, i)
                ).join('\n');
                
                showToast(`Generated ${maxRows} lines of output.`, "success");
            }

            // Import all columns
            function importAllColumns_EqualDisp() {
                const state = globalState.interfaces.equalDisp;
                const format = state.formats[0];
                
                if (state.files.length === 0) {
                    showToast("No files loaded. Please upload files first.", "error");
                    return;
                }
                
                // Import all file columns with 00000 format and 5 leading spaces
                format.columns = state.files.map((f, i) => ({
                    type: 'source',
                    fileIndex: i,
                    header: f.headers[0] || 'Col 1',
                    spacesBefore: (i === 0) ? 5 : 0, // 5 spaces before first column
                    format: '00000' // All columns formatted as 00000
                }));
                
                // Add manual column at the end with 4 leading spaces and no formatting
                const manualColumnCount = format.columns.filter(c => c.type === 'uniform').length + 1;
                format.columns.push({
                    type: 'uniform',
                    name: `Manual ${manualColumnCount}`,
                    value: '',
                    spacesBefore: 4, // 4 leading spaces
                    format: 'none' // No formatting
                });
                
                format.editedData = {};
                showToast(`Imported ${state.files.length} columns with automatic formatting.`, "success");
                saveState_EqualDisp();
                renderFormatGrid_EqualDisp();
            }

            // Add manual column
            function addManualColumn_EqualDisp() {
                const format = globalState.interfaces.equalDisp.formats[0];
                const count = format.columns.filter(c => c.type === 'uniform').length + 1;
                
                format.columns.push({
                    type: 'uniform',
                    name: `Manual ${count}`,
                    value: '',
                    spacesBefore: 4, // 4 leading spaces
                    format: 'none' // No formatting
                });
                
                saveState_EqualDisp();
                renderFormatGrid_EqualDisp();
                showToast(`Added manual column: Manual ${count}`, "success");
            }

            // Update column configuration
            function updateColumnConfig_EqualDisp(colIndex, configKey, value) {
                const col = globalState.interfaces.equalDisp.formats[0]?.columns[colIndex];
                if (col) {
                    col[configKey] = (configKey === 'spacesBefore') ? parseInt(value, 10) : value;
                }
                renderFormatGrid_EqualDisp(); // Re-render needed for uniform value change too
            }

            // Remove column
            function removeColumn_EqualDisp(colIndex) {
                const cols = globalState.interfaces.equalDisp.formats[0]?.columns;
                if (cols) {
                    cols.splice(colIndex, 1);
                }
                renderFormatGrid_EqualDisp();
                showToast("Column removed successfully.", "info");
            }

            // Copy output
            function copyOutput_EqualDisp() {
                const el = document.getElementById(`final-output-equalDisp`);
                if (!el.value) {
                    showToast("Nothing to copy. Generate output first.", "error");
                    return;
                }
                
                el.select();
                el.setSelectionRange(0, 99999);
                
                try {
                    document.execCommand('copy');
                    showToast("Output copied to clipboard!", "success");
                } catch (err) {
                    showToast("Failed to copy. Please try again.", "error");
                }
            }

            // Download output
            function downloadOutput_EqualDisp() {
                const el = document.getElementById(`final-output-equalDisp`);
                if (!el.value) {
                    showToast("Nothing to download. Generate output first.", "error");
                    return;
                }
                
                const format = globalState.interfaces.equalDisp.formats[0];
                const blob = new Blob([el.value], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `equal_disp_output_${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                showToast("Output downloaded successfully!", "success");
            }

            // Save state
            function saveState_EqualDisp() {
                const state = globalState.interfaces.equalDisp;
                const snapshot = JSON.parse(JSON.stringify(state.formats));
                state.history = state.history.slice(0, state.historyIndex + 1);
                state.history.push(snapshot);
                state.historyIndex = state.history.length - 1;
                updateUndoRedoButtons();
            }

            // Undo
            function undo_EqualDisp() {
                const state = globalState.interfaces.equalDisp;
                if (state.historyIndex > 0) {
                    state.historyIndex--;
                    state.formats = JSON.parse(JSON.stringify(state.history[state.historyIndex]));
                    renderFormatGrid_EqualDisp();
                    updateUndoRedoButtons();
                    showToast("Undo successful.", "info");
                }
            }

            // Redo
            function redo_EqualDisp() {
                const state = globalState.interfaces.equalDisp;
                if (state.historyIndex < state.history.length - 1) {
                    state.historyIndex++;
                    state.formats = JSON.parse(JSON.stringify(state.history[state.historyIndex]));
                    renderFormatGrid_EqualDisp();
                    updateUndoRedoButtons();
                    showToast("Redo successful.", "info");
                }
            }

            // Update undo/redo buttons
            function updateUndoRedoButtons() {
                const { historyIndex, history } = globalState.interfaces.equalDisp;
                const undoBtn = document.getElementById('undo-btn-equalDisp');
                const redoBtn = document.getElementById('redo-btn-equalDisp');
                
                if (undoBtn) undoBtn.disabled = historyIndex <= 0;
                if (redoBtn) redoBtn.disabled = historyIndex >= history.length - 1;
            }

            // Handle header drag start
            function handleHeaderDragStart(event, interfaceKey, colIndex) {
                globalState.interfaces.equalDisp.draggedHeaderIndex = colIndex;
                event.target.closest('th').classList.add('dragging');
                event.dataTransfer.effectAllowed = 'move';
            }

            // Handle header drag over
            function handleHeaderDragOver(event) {
                event.preventDefault();
                event.dataTransfer.dropEffect = 'move';
                const target = event.target.closest('th');
                if (target) {
                    document.querySelectorAll('.header-drag-over').forEach(th => th.classList.remove('header-drag-over'));
                    target.classList.add('header-drag-over');
                }
            }

            // Handle header drop
            function handleHeaderDrop(event, interfaceKey, droppedOnIndex) {
                event.preventDefault();
                document.querySelectorAll('.header-drag-over').forEach(th => th.classList.remove('header-drag-over'));
                
                const state = globalState.interfaces.equalDisp;
                const format = state.formats[0];
                
                if (format && state.draggedHeaderIndex !== null && state.draggedHeaderIndex !== droppedOnIndex) {
                    const item = format.columns.splice(state.draggedHeaderIndex, 1)[0];
                    format.columns.splice(droppedOnIndex, 0, item);
                    renderFormatGrid_EqualDisp();
                    saveState_EqualDisp();
                    showToast("Column reordered successfully.", "info");
                }
            }

            // Handle header drag end
            function handleHeaderDragEnd(event, interfaceKey) {
                globalState.interfaces.equalDisp.draggedHeaderIndex = null;
                document.querySelectorAll('.dragging, .header-drag-over').forEach(th => th.classList.remove('dragging', 'header-drag-over'));
            }

            // --- END: PHASE 5 SCRIPT ---


            // --- START: PHASE 1 (INTRO) SCRIPT ---
            // --- This logic is from the original Phase 1 file ---

            // --- NEW: Phase Navigation Data ---
            const phases = [
                { id: 'phase1', title: 'Introduction', icon: 'fa-rocket' },
                { id: 'phase2', title: 'Initial Stress', icon: 'fa-compress-arrows-alt' },
                { id: 'phase3', title: 'CM Parameters', icon: 'fa-cogs' },
                { id: 'phase4', title: 'Model Config', icon: 'fa-project-diagram' },
                { id: 'phase5', title: 'Equal Disp', icon: 'fa-border-all' },
                { id: 'phase6', title: 'Earthquake Step', icon: 'fa-wave-square' },
                { id: 'phase7', title: 'Ru-Acc-Disp', icon: 'fa-chart-line' }
            ];
            let currentActivePhase = 'phase1'; // Default for this page

            /**
             * NEW: Renders both desktop and mobile navigation bars.
             */
            function renderPhaseNav() {
                const desktopNav = document.getElementById('phase-nav-desktop');
                const mobileNav = document.getElementById('phase-nav-mobile');

                if (!desktopNav || !mobileNav) return;

                desktopNav.innerHTML = '';
                mobileNav.innerHTML = '';

                phases.forEach(phase => {
                    // Create desktop nav item
                    const navItem = document.createElement('a');
                    navItem.className = 'phase-nav-item';
                    navItem.dataset.phaseId = phase.id;
                    navItem.setAttribute('role', 'button');
                    navItem.setAttribute('aria-label', `Switch to ${phase.title}`);
                    navItem.innerHTML = `<i class="fas ${phase.icon} w-4 text-center"></i><span>${phase.title}</span>`;
                    if (phase.id === currentActivePhase) {
                        navItem.classList.add('active');
                    }
                    desktopNav.appendChild(navItem);

                    // Create mobile nav option
                    const navOption = document.createElement('option');
                    navOption.value = phase.id;
                    navOption.textContent = phase.title;
                    if (phase.id === currentActivePhase) {
                        navOption.selected = true;
                    }
                    mobileNav.appendChild(navOption);
                });
            }

            /**
             * NEW: Sets the active phase in the UI and shows/hides content.
             * @param {string} phaseId - The ID of the phase to activate (e.g., 'phase1').
             */
            function setActivePhase(phaseId) {
                currentActivePhase = phaseId;

                // Update desktop nav
                document.querySelectorAll('#phase-nav-desktop .phase-nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.phaseId === phaseId);
                });

                // Update mobile nav
                const mobileNav = document.getElementById('phase-nav-mobile');
                if (mobileNav) {
                    mobileNav.value = phaseId;
                }
                
                // --- NEW: Show/Hide Panes ---
                const panes = {
                    'phase1': document.getElementById('interface-introduction'),
                    'phase2': document.getElementById('interface-initialStress'),
                    'phase3': document.getElementById('interface-cmParams'),
                    'phase4': document.getElementById('interface-modelConfig'),
                    'phase5': document.getElementById('interface-equalDisp')
                    // Add future phases here as:
                    // 'phase6': document.getElementById('interface-earthquakeStep'),
                };

                // Hide all panes
                Object.values(panes).forEach(pane => {
                    if(pane) pane.classList.add('hidden');
                });

                // Show the active pane
                if (panes[phaseId]) {
                    panes[phaseId].classList.remove('hidden');
                } else {
                    // Fallback to intro if pane not found
                    panes['phase1']?.classList.remove('hidden');
                }
                // --- END NEW ---
                
                console.log(`Switched to phase: ${phaseId}`);
            }

            /**
             * NEW: Initializes all event listeners for the phase navigation.
             */
            function initPhaseNav() {
                renderPhaseNav();

                // Desktop nav click listener (using event delegation)
                document.getElementById('phase-nav-desktop').addEventListener('click', (e) => {
                    const navItem = e.target.closest('.phase-nav-item');
                    if (navItem && navItem.dataset.phaseId) {
                        setActivePhase(navItem.dataset.phaseId);
                        // Scroll the active item into view if needed
                        navItem.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    }
                });

                // Mobile nav change listener
                document.getElementById('phase-nav-mobile').addEventListener('change', (e) => {
                    setActivePhase(e.target.value);
                });
            }
            // --- END: Phase Navigation ---


            // Create floating particles for background effect
            function createParticles() {
                const container = document.getElementById('particles-container');
                if (!container) return;
                const particleCount = Math.floor(window.innerWidth / 30);
                
                for (let i = 0; i < particleCount; i++) {
                    const particle = document.createElement('div');
                    particle.classList.add('particle');
                    
                    // Random size
                    const size = Math.random() * 8 + 2;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    
                    // Random position
                    particle.style.left = `${Math.random() * 100}%`;
                    particle.style.top = `${Math.random() * 100}%`;
                    
                    // Random animation duration
                    const duration = Math.random() * 20 + 10;
                    particle.style.animationDuration = `${duration}s`;
                    
                    // Random delay
                    const delay = Math.random() * 5;
                    particle.style.animationDelay = `${delay}s`;
                    
                    container.appendChild(particle);
                }
            }
            
            // Initialize particles
            createParticles();
            
            // Handle window resize
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    // Clear existing particles
                    const container = document.getElementById('particles-container');
                    if (container) {
                        container.innerHTML = '';
                        // Recreate particles with new count
                        createParticles();
                    }
                }, 250);
            });
            
            // Add hover effects to feature cards
            const featureCards = document.querySelectorAll('.feature-card');
            featureCards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    const icon = card.querySelector('.feature-icon');
                    if (icon) {
                        icon.style.transform = 'scale(1.1)';
                        icon.style.transition = 'transform 0.3s ease';
                    }
                });
                
                card.addEventListener('mouseleave', () => {
                    const icon = card.querySelector('.feature-icon');
                    if (icon) {
                        icon.style.transform = 'scale(1)';
                    }
                });
            });
            
            // Smooth scroll for anchor links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            
            // Add animation to workflow steps on scroll
            const observerOptions = {
                threshold: 0.1
            };
            
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.style.opacity = 1;
                            entry.target.style.transform = 'translateY(0)';
                        }
                    });
                }, { ...observerOptions, root: mainContent }); // Observe scrolling within main-content
                
                document.querySelectorAll('.workflow-step, .data-item, .concept-item').forEach(item => {
                    item.style.opacity = 0;
                    item.style.transform = 'translateY(20px)';
                    item.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                    observer.observe(item);
                });
            }

            // --- Toast Notification ---
            let toastTimer; 
            
            function showToast(message, type = "info") { 
                const toast = document.getElementById('toast'); 
                if (!toast) return; 
                
                // Set message text
                toast.textContent = message; 
                
                // Reset classes and apply color based on type
                toast.className = 'fixed bottom-5 right-5 text-white px-5 py-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 z-50'; 
                
                // Apply color classes based on type
                if (type === "success") {
                    toast.classList.add('bg-green-700');
                    toast.classList.add('border');
                    toast.classList.add('border-green-500');
                } else if (type === "error") {
                    toast.classList.add('bg-red-700');
                    toast.classList.add('border');
                    toast.classList.add('border-red-500');
                } else if (type === "warning") {
                    toast.classList.add('bg-blue-700');
                    toast.classList.add('border');
                    toast.classList.add('border-blue-500');
                } else {
                    toast.classList.add('bg-slate-700');
                    toast.classList.add('border');
                    toast.classList.add('border-slate-500');
                }
                
                // Show toast
                clearTimeout(toastTimer);
                toast.classList.remove('opacity-0');
                
                // Hide toast after 3 seconds
                toastTimer = setTimeout(() => {
                    toast.classList.add('opacity-0');
                    setTimeout(() => {
                        // Reset all classes except positioning
                        toast.className = 'fixed bottom-5 right-5 text-white px-5 py-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 z-50';
                    }, 300);
                }, 3000);
            }
            
            // --- Initialize Page ---
            initPhaseNav(); // Initialize the new navigation bar
            initializePhase2(); // Initialize the listeners for Phase 2
            initializePhase3(); // Initialize the listeners for Phase 3
            initializePhase4(); // Initialize the listeners for Phase 4
            initializePhase5(); // Initialize the listeners for Phase 5
            setActivePhase(currentActivePhase); // Run once on load to show the correct initial pane (phase1)

        });
    </script>
</body>
</html>